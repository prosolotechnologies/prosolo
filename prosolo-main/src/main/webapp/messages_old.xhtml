<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	template="templates/masterLayout.xhtml"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:dlg="http://java.sun.com/jsf/composite/components/dialogs"
	xmlns:post="http://java.sun.com/jsf/composite/components/post"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks">

<ui:define name="windowTitle">
	Messages
</ui:define>

<ui:define name="metadata">
	<f:metadata>
		<f:viewParam name="id" value="#{messagesBean.threadId}" />		
		<f:viewAction action="#{messagesBean.init()}" />
	</f:metadata>
</ui:define>

<ui:define name="content">
    <div class="whiteBar"></div>

	<div id="messageThreads" class="container tabbedLayout">
	
		<div class="leftSidebar">
			<h:panelGroup layout="block" id="messageItemsContainer" class="leftNav">
				<ul class="itemsContainer">
					<ui:repeat value="#{messagesBean.messagesThreads}" var="messageThreadData" varStatus="iterator">

						<li class="conversation conversation#{messageThreadData.id} item #{messageThreadData.id == messagesBean.threadData.id ? 'selected' : ''}">
							
							<p:commandLink styleClass=""
								action="#{messagesBean.changeThread(messageThreadData)}"
								update=":messagesForm:messagesContainer"
								onclick="changeConversation(#{messageThreadData.id})">
								
								<h:panelGroup rendered="#{messageThreadData.participantsWithoutLoggedUser.size() == 1}">
					    			<img class="imageRound image30 left" 
					    				src="#{messageThreadData.participantsWithoutLoggedUser.get(0).avatarUrl != null ? messageThreadData.participantsWithoutLoggedUser.get(0).avatarUrl : colleguesBean.avatarUrlByUserId(messageThreadData.participantsWithoutLoggedUser.get(0).id, 60)}" 
										width="30" height="30" alt="#{messageThreadData.participantsWithoutLoggedUser.get(0).name}" />
										
									<div class="contentContainer">
										<span class="user">
											#{messageThreadData.participantsWithoutLoggedUser.get(0).name}
										</span>
										<span class="time">
											#{messageThreadData.updateTime}
										</span>
		
										<div class="clear"></div>
		
										<span>
											"#{messageThreadData.latest.shortContent}"
										</span>
									</div>
								</h:panelGroup>
								<div class="clear"></div>
							</p:commandLink>
								
							<ui:remove>
							<h:panelGroup rendered="#{messageThreadData.participantsWithoutLoggedUser.size() > 1}">
								<div class="avatars">
									<ui:repeat value="#{messageThreadData.participantsWithoutLoggedUser}" var="participantDataAvatar">
										<img class="imageRound image30 left" 
						    				src="#{participantDataAvatar.avatarUrl != null ? participantDataAvatar.avatarUrl : colleguesBean.avatarUrlByUserId(participantDataAvatar.id, 60)}" 
											width="30" height="30" alt="#{participantDataAvatar.name}" />
									</ui:repeat>
								</div>
								<div class="clear"></div>
								
								<span class="users">
									#{messageThreadData.participantsListWithoutLoggedUser}
								</span>
							</h:panelGroup>
							</ui:remove>
						</li>
					</ui:repeat>
				</ul>
				
				<script>
					roundImages();
				</script>
			</h:panelGroup>	
			
		</div><!-- .leftSidebar -->
		
		<div class="content">
		
			<h:form id="messagesForm" prependId="false">
	            
	            <h:panelGroup layout="block" id="messagesContainer">
				
					<p>Conversation with 
						<span class="bold">
							#{messagesBean.threadData.participantsListWithoutLoggedUser}
						</span>
					</p>
	            
					<p:commandLink styleClass="loadMore" 
						rendered="#{messagesBean.loadMore}"
						action="#{messagesBean.loadMore()}"
			       		update=":messagesForm:messagesContainer"
			       		value="Show previous messages"
			       	/>
		            <div class="clear marginBottom10"></div>

					<ui:repeat value="#{messagesBean.messages}" var="message" varStatus="iterator">
			            
						<div class="box messageItem">
							<div class="avatar">
								<link:user value="userDetailsImage" 
				    				userData="#{message.actor}"
				    				mode="image"
				    				imageSize="48"
				    				idPrefix="messageParticipantImage#{iterator.index}"
				    				context="message.image"/>
							</div>
							
							<div class="text">
								<div class="user left">
									<link:user value="userDetails" 
					    				userData="#{message.actor}"
					    				divClass="bold"
					    				mode="name"
					    				idPrefix="messageParticipant#{iterator.index}"
					    				context="message.name"/>
								</div>							
								<div class="date">#{message.date}</div>
				                <div class="clear"></div>
								<div class="messageContent">#{message.content}</div>
							</div>
			            </div>
		            </ui:repeat>
	            </h:panelGroup>
			
				<post:newpostNoForm value="messageReply" id="messageReply" 
					content="#{messagesBean.messageData}" 
					createPostAction="#{messagesBean.createNewPost()}"
					containerDiv="#messageThreads"
					linkEnabled="false"
					watermark="Reply..."
					regionToRefresh=":messagesForm:messagesContainer :messageItemsContainer"
					actionButtonName="Reply"
				/>
				
				<p:growl id="messagesFormGrowl" for="messagesFormGrowl" showDetail="true" />
				
				<script>
				$(function() {
					roundImages();
				});
				</script>
			</h:form>
		</div><!-- .content -->
	</div><!-- .container end -->
	
	<script>
		function changeConversation(threadId) {
			$('#messageThreads .leftNav .conversation').removeClass('selected');
			$('#messageThreads .leftNav .conversation'+threadId).addClass('selected');
			setQueryParam('id', threadId);
		}
		
		/* if (getParameterByName('id').length == 0) {
			setQueryParam('id', #{messagesBean.threadData.id});
		} */
	</script>
	
</ui:define>
</ui:composition>