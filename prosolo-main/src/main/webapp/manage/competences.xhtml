<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	template="templates/masterLayout.xhtml"
	xmlns:dlg="http://java.sun.com/jsf/composite/components/dialogs"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:icon="http://java.sun.com/jsf/composite/components/resourceLinks/icons"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:util="http://www.prosolo.com/util">

<ui:define name="windowTitle">
	Competences
</ui:define>

<ui:define name="content">
	<script type="text/javascript">
		$(function() {
			var query = "#{param['query']}";
			
			$('form.filteredSearch .searchContainer .inputContainer.compSearch .searchInput').val("#{param['query']}");
			$('form.filteredSearch .searchContainer .inputContainer.compSearch .searchInputHidden').val("#{param['query']}");
			searchControl.executeSearch();
		});
		
		var searchControl = {
			addLoaderToSearchContainer: function () {
				$('form.filteredSearch .resultContainer')
					.css('text-align', 'center')
					.css('padding-top', '50px')
					.html('<img src="#{request.contextPath}/resources/images/style/ajax-loader-black.gif" style="vertical-align:middle;"/>');
			},
			updateUrlQuery: function (){
				setQueryParam('query', $('form.filteredSearch .inputContainer.compSearch .searchInput').val());
			},
			updateUrlKeywords: function (){
				setQueryParam('keywords', $('form.filteredSearch .inputContainer.keywordFilter .searchInput').val());
			},
			executeSearch: function (){
				$('form.filteredSearch .search.button').trigger('click');
			},
			keystrokeTimeout: null,
			searchListener: function () {
				var $this = this;
				this.updateUrlQuery(); 
				
				var delayedSearch = function(){
					$('form.filteredSearch .inputContainer.compSearch .searchInputHidden').val($('form.filteredSearch .inputContainer.compSearch .searchInput').val());
					$this.executeSearch();
				};

				window.clearTimeout(this.keystrokeTimeout);
				this.keystrokeTimeout = window.setTimeout(delayedSearch, 350);
			},
		};
	</script>

	<div class="container admin">
		<div class="content wide search">
			<h2>Competences</h2>
		
			<h:form id="compSearchForm" class="filteredSearch">
				<p:growl id="compSearchFormGrowl" showDetail="true" />
			
				<div class="right">
					<p:commandLink styleClass="button blue size25 right search" value="Search"
						onclick="searchControl.addLoaderToSearchContainer(); searchControl.updateUrlQuery();"
						actionListener="#{searchCompetencesBean.searchAllCompetences()}"
						update=":compSearchForm:resultContainer"/>
					
					<div class="inputContainer compSearch">
						<div class="mGlass"></div>
   						<h:inputText size="20" class="searchInput"
   							placehoder="Search competences"
					  		onclick="$(this).select();" 
					  		onkeydown="searchControl.searchListener();" />
					  		
					  		<script>
								$('form.filteredSearch .inputContainer.compSearch .searchInput').attr("placeholder", "Search Comptences");
							</script>
					  		
					  	<h:inputText class="searchInputHidden"
					  		style="display: none;"
					  		value="#{searchCompetencesBean.query}" />
					</div>
				</div>
				<div class="clear"></div>
				
				<div class="right">
					<span class="marginRight10 middleAlign">Filter by keywords:</span>
					
					<h:panelGroup layout="block" id="keywords" class="keywords">
						<div class="inputContainer keywordFilter">
							<ui:repeat value="#{searchCompetencesBean.filterTags}" var="keyword" id="filterKeywords">
								<span class="keywordItem">
									<span class="name">#{keyword.title}</span>
									<p:commandLink styleClass="remove"
										actionListener="#{searchCompetencesBean.removeFilterTag(keyword)}"
										action="#{searchTagsBean.resetSearchResults()}"
										update=":compSearchForm"
										oncomplete="searchControl.executeSearch();"
					    			/>
								</span>
							</ui:repeat>
							
							<div class="searchInputContainer">
		   						<h:inputText size="20" class="searchInput"
						    		autocomplete="off"
							  		onclick="$(this).select();" 
									valueChangeListener="#{searchTagsBean.searchListener}">
									<f:ajax
										render="keywordSearchResultPanel"
										execute="@this" event="keyup" />
						  		</h:inputText>
						  		
								<h:panelGroup layout="block" id="keywordSearchResultPanel">
									<h:panelGroup layout="block" styleClass="results" rendered="#{not empty searchTagsBean.tags}">
								
										<ui:repeat value="#{searchTagsBean.tags}" var="keyword" id="foundKeywordList">
											<p:commandLink
												styleClass="resultContainer"
												action="#{searchCompetencesBean.addFilterTag(keyword)}"
												oncomplete="$('.admin .keywords .results').fadeOut();$('.admin .filteredSearch .inputContainer.keywordFilter .searchInput').val('').focus();"
								    			update=":compSearchForm:keywords">
								    			
												<div class="result">
													<div class="infoContainer" style="float: left">
														<div class="title">#{keyword.title}</div>
													</div>
												</div>
											</p:commandLink>
											<div class="clear"></div>
										</ui:repeat>
									</h:panelGroup>
								</h:panelGroup>
							</div>
						  		
						  	<h:inputHidden class="searchInputHidden"
						  		value="#{searchTagsBean.query}" 
						  	/>
						</div>
					</h:panelGroup>
					
					<script>
					$(function() {
						$('.admin .filteredSearch .keywordFilter').on('click', function(e) {
							$(this).find('.searchInput').focus();
						});
						$(document).on('click', function(){
							$('.admin .keywords .results').fadeOut();
						});
					});
					</script>
				</div>
				
				<p:commandLink styleClass="left button green size30 marginBottom10"
					value="New Competence"
					onclick="$('#newCompFormModalDialog').dialog('open');"
					action="#{competenceDialog.reset()}"
					update=":newComp:newCompForm"
				/>
					
				<div class="separator clear"></div>
			
				<h:panelGroup layout="block" class="resultContainer" id="resultContainer">
					<div class="marginTop10">
						<span class="marginRight10">Sorting:</span>
					
						<p:commandLink styleClass="titleSort marginRight10"
							rendered="#{!searchCompetencesBean.sortTitleAsc}"
							action="#{searchCompetencesBean.changeTitleSorting(true)}"
							update="resultContainer">
							Title <span class="upArrow dark inlineBlock"></span>
						</p:commandLink>
						<p:commandLink styleClass="titleSort marginRight10"
							rendered="#{searchCompetencesBean.sortTitleAsc}"
							action="#{searchCompetencesBean.changeTitleSorting(false)}"
							update="resultContainer">
							Title <span class="downArrow dark inlineBlock"></span>
						</p:commandLink>
					</div>
				
					<ui:repeat value="#{searchCompetencesBean.competences}" var="compData" id="compList" varStatus="iterator">
						<div class="box comp#{compData.id}">
							<div class="avatar">
								<icon:competence />
							</div>
							
							<div class="textWrapper">
								<span class="title">
									<h:link value="#{compData.title}" 
										outcome="/manage/competence">
										<f:param name="id" value="#{util:encodeId(compData.id)}" />
									</h:link>
								</span>
								<div class="clear"></div>
								
								<h:panelGroup layout="block"
									rendered="#{compData.description != null and compData.description.length() > 0}"
									class="message">"#{compData.description}"</h:panelGroup>
								
								<script>
									$('form.filteredSearch .box.comp#{compData.id} .message').readmore({maxHeight: 40});
								</script>	
								<div class="clear"></div>
								
								<table>
									<tr>
										<td><span class="bold">Creator:</span></td>
										<td>
											<link:user value="userDetailsImage" 
							    				user="#{compData.creator}"
							    				mode="imageName"
							    				imageSize="22"
							    				idPrefix="compSearchCreator#{iterator.index}" 
							    				context="competences.imageName"/>
										</td>
									</tr>
									<tr>
										<td class="middleAlign"><span class="bold">Keywords:</span></td>
										<td>
											<ui:repeat value="#{compData.tags}" var="keyword" varStatus="iterator">
												<p:commandLink styleClass="keywordItem actionalble"
													actionListener="#{searchCompetencesBean.addFilterTag(keyword)}"
													action="#{searchCompetencesBean.searchAllCompetences()}"
									    			update=":compSearchForm"
									    			oncomplete="$('.admin .keywords .results').hide();"
									    			>
													<span class="name">#{keyword.title}</span>
												</p:commandLink>
											</ui:repeat>
										</td>
									</tr>
								</table>
								
								<div class="links">
									<h:link value="Edit" 
										styleClass="button green size20 left" 
										outcome="/manage/competence">
										<f:param name="id" value="#{util:encodeId(compData.id)}" />
									</h:link>
								</div>
							</div>
							
							<div class="date">Validity: #{compData.validity} months</div>
			            </div>
						
						<div class="separator clear"></div>
					</ui:repeat>
					
					<p:commandLink id="loadMore" rendered="#{searchCompetencesBean.moreToLoad}" styleClass="loadMore"
						actionListener="#{searchCompetencesBean.loadMoreCompetences}"
						update=":compSearchForm">
						<h:outputText value="SHOW MORE" />
					</p:commandLink>
					
					<script>
					$(function() {
						roundImages();
						
						$('form.filteredSearch .loadMore').on('click', function() {
							$(this).html('<img src="#{request.contextPath}/resources/images/style/ajax-loader-black.gif" id="loginloader" style="margin-top: 9px;"/>');
							return false;
						});
						
						var input = $('form.filteredSearch .inputContainer .searchInput');
						input[0].selectionStart = input[0].selectionEnd = input.val().length;
						
						$('form.filteredSearch .resultContainer').fadeIn();
					});
					</script>
					
					<utilcomp:tooltip target=".hasTooltip[title]" />
				</h:panelGroup>
			</h:form>
		</div>
	</div>
	
	<dlg:newCompetence id="newComp"
		compData="#{competenceDialog.formData}"
		updateCompetenceAction="#{competenceDialog.saveCompetence()}"
		regionToUpdate=":compSearchForm:resultContainer"
		mode="MANAGER"
		context="manager.course" />
		

</ui:define>

</ui:composition>