<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:comp="http://java.sun.com/jsf/composite/components"
	template="templates/masterLayout2.xhtml"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:dlg="http://java.sun.com/jsf/composite/components/dialogs"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:util="http://www.prosolo.com/util"
	xmlns:courses="http://java.sun.com/jsf/composite/components/courses"
	xmlns:mngComp="http://java.sun.com/jsf/composite/components/manage"
	xmlns:dlgComp="http://java.sun.com/jsf/composite/components/dialogs/manager">

	<ui:define name="windowTitle">
		Credential - #{credentialMembersBean.credentialTitle} - Students
	</ui:define>

	<ui:define name="metadata">
		<f:metadata>
			<f:viewParam name="id" value="#{credentialMembersBean.id}" default="null" />
			<f:viewParam name="p" value="#{credentialMembersBean.paginationData.pageString}" default="1" />
			<f:viewAction action="#{credentialMembersBean.init()}" />
		</f:metadata>
	</ui:define>

    <ui:define name="resourceTitle">
    	<h1>#{credentialMembersBean.credentialTitle}</h1>
    </ui:define>
    
    <ui:define name="navLinks">
		<mngComp:credentialsHeaderNavLinks
			id="headerNavLinks"
			credEncodedId="#{param['id']}"
			credType="UNIVERSITY_CREATED"
		/>
	</ui:define>
	
	<ui:define name="content">
	<script src="#{request.contextPath}/resources/javascript2/search.js"></script>
	
	<div class="whiteBar">
		<h:form id="formSearch">
			<div class="container">
				<div class="whiteBarContent">
					<div class="whiteBarLeft">
						<p:commandLink rendered="#{credentialMembersBean.canEdit()}"
	                		value="Add Students"
	                		styleClass="btn btn-green btn-sm item"
	                		pt:data-toggle="modal"
	                		process="@this"
	                		action="#{studentEnrollBean.prepareStudentEnroll()}"
							update=":formEnrollStudents:enrollStudentsModalContent"
	                		oncomplete="$('#addStudentsModal').modal('show');">
	                	</p:commandLink>  
						<ui:fragment rendered="#{not credentialMembersBean.canEdit()}">
							<a href="javascript:void(0);" 
								disabled="true"
								class="btn btn-green btn-sm item"
								data-toggle="tooltip"
								title="You are not allowed to add students to this credential">
								Add Students
							</a>
						</ui:fragment>
						
						<div class="searchBox">
							<p:remoteCommand 
								name="execSearchStudents" 
								process="inputStudentSearch"
								update=":formMain:panelStudents :formMain:pagination :formSearch:panelSearchFilters"
								action="#{credentialMembersBean.resetAndSearch()}" />
														
							<h:inputText id="inputStudentSearch"
								type="search"
								styleClass="studentSearchField"
								placeholder="Search by name"
								value="#{credentialMembersBean.searchTerm}"
								onclick="$(this).select();"
								onkeyup="searchListener(execSearchStudents);"/>              
						</div>
					</div>
					
					<div class="whiteBarRight">
						<h:panelGroup id="panelSort" layout="block" styleClass="dropdown sortDrop item">
							<span>Sort:</span>
							<h:link 
								id="linkSortOption" 
								pt:data-toggle="dropdown" 
								pt:aria-haspopup="true" 
								pt:aria-expanded="true">
								#{credentialMembersBean.sortOption.label}
								<span class="arrowDown">arrowDown</span>
							</h:link>
							
							<ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">
								<ui:repeat var="sortOption" value="#{credentialMembersBean.sortOptions}">
									<li>
										<p:commandLink 
											process="@this"
											value="#{sortOption.label}"
											action="#{credentialMembersBean.applySortOption(sortOption)}"
											update=":formMain:panelStudents :formMain:pagination :formSearch:linkSortOption :formSearch:panelSearchFilters" />
									</li>
								</ui:repeat>      
							</ul>
						</h:panelGroup>
						<h:panelGroup layout="block" id="panelSearchFilters" styleClass="dropdown showDrop item">
							<span>Show:</span>
							<h:link 
								id="linkSearchFilter"
								pt:data-toggle="dropdown" 
								pt:aria-haspopup="true" 
								pt:aria-expanded="true">
								#{credentialMembersBean.instructorAssignFilter.filter.label} (#{credentialMembersBean.instructorAssignFilter.numberOfResults})
								<span class="arrowDown">arrowDown</span>
							</h:link>
							
							<ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">
								<ui:repeat var="searchFilter" value="#{credentialMembersBean.searchFilters}">
									<li>
										<p:commandLink 
											process="@this"
											value="#{searchFilter.filter.label} (#{searchFilter.numberOfResults})"
											action="#{credentialMembersBean.applySearchFilter(searchFilter)}"
											update=":formMain:panelStudents :formMain:pagination :formSearch:panelSearchFilters" />
									</li>
								</ui:repeat> 
							</ul>
						</h:panelGroup>
					</div>
				</div>
			</div>
		</h:form>
	</div>

	<div class="container">
		<ol class="breadcrumb">
			<li><a href="#">Credentials</a></li>
			<li class="active">#{credentialMembersBean.credentialTitle}</li>
		</ol>
	</div>

	<h:form id="formMain">
		<p:growl id="growlMain" globalOnly="true" showDetail="true"/>
		<div class="container">
			<div class="row">
				<h:panelGroup layout="block" id="panelStudents" styleClass="col-md-12">
					<img class="loaderSvg" id="loaderPanelStudents" src="#{request.contextPath}/resources/images2/loader.svg" width="20" height="20" style="display: none; margin-left: auto; margin-right: auto;"/>
					<ui:fragment rendered="#{empty credentialMembersBean.members}" >
						<div class="noContentMessage">
		                    <p>
		                        No one has started this credential yet.
		                    </p>
		                </div>
	                </ui:fragment>
				
					<ul class="whiteBox peopleList">
						<ui:repeat var="student" value="#{credentialMembersBean.members}">
							<li>
								<div class="peopleListLeft">
									<h:link	outcome="studentProfile">
										<utilcomp:userAvatar
											avatar="#{student.user.avatarUrl}"
											fullName="#{student.user.fullName}"	
											width="64"
											height="64" />
										<f:param name="id" value="#{util:encodeId(student.user.id)}" />
									</h:link>
									
									<div>
										<h2>
											<h:link outcome="studentProfile">
												#{student.user.fullName}
												<f:param name="id" value="#{util:encodeId(student.user.id)}" />
											</h:link>
										</h2>
										<span>#{student.user.position}</span>
									</div>
								</div>
								
								<div class="peopleListRight">
									<div class="progressBar">
										<span>#{student.credProgress}%</span>
										<div class="progress">
											<div class="progress-bar" role="progressbar" aria-valuenow="#{student.credProgress}" aria-valuemin="0" aria-valuemax="100" style="width: #{student.credProgress}%;">
											</div>
										</div>
									</div>
									<div class="assessmentButton">

                            		</div>
									<div class="assignedTo">
										<h:link outcome="/manage/credential-assessment" rendered="#{student.assessmentId > 0}"
											styleClass="btn btn-green-stroke">
											Assessment
											<f:param value="#{util:encodeId(student.assessmentId)}" name="assessmentId"></f:param>
											<f:param value="#{param['id']}" name="id"></f:param>
										</h:link>
										<ui:fragment rendered="#{student.instructor != null}">
										<p>
											<span>Instructor:</span>
											<br/>
											<p:commandLink rendered="#{credentialMembersBean.canEdit()}"
												pt:data-toggle="modal"
												process="@this"
												action="#{credentialMembersBean.loadCredentialInstructors(student)}"
												oncomplete="$('#assignInstructorModal1').modal('show');"
												update=":dlgInstructors:formAssignInstructor:assignInstructorModalContent">
												#{student.instructor.user.fullName}
											</p:commandLink>
											<ui:fragment rendered="#{not credentialMembersBean.canEdit()}">
												<a href="javascript:void(0);">#{student.instructor.user.fullName}</a>
											</ui:fragment>
										</p>
										</ui:fragment>
										
										<ui:fragment rendered="#{student.instructor == null}">
											<p:commandLink rendered="#{credentialMembersBean.canEdit()}"
												styleClass="btn btn-green-stroke"
												pt:data-toggle="modal"
												process="@this"
												action="#{credentialMembersBean.loadCredentialInstructors(student)}"
												oncomplete="$('#assignInstructorModal1').modal('show');"
												update=":dlgInstructors:formAssignInstructor:assignInstructorModalContent">
												Assign Instructor
											</p:commandLink>
											<ui:fragment rendered="#{not credentialMembersBean.canEdit()}">
												<a href="javascript:void(0);" 
													disabled="true"
													class="btn btn-green-stroke"
													data-toggle="tooltip"
													title="You are not allowed to assign instructors to students for this credential">
													Assign Instructor
												</a>
											</ui:fragment>
										</ui:fragment>
									</div>
								</div>
							</li>
						</ui:repeat>
					</ul>
				</h:panelGroup>
			</div>
		
			<utilcomp:pagination
				id="pagination" 
				bean="#{credentialMembersBean}"
				updateUrl="true"
				toUpdate=":formMain:panelStudents" />
		</div>
	</h:form>
	
	<h:form id="formEnrollStudents">
    	<div class="modal fade addStudentsModal" id="addStudentsModal" tabindex="-1" role="dialog" aria-labelledby="addStudentModal">
           <div class="modal-dialog modal-lg">
              <h:panelGroup layout="block" id="enrollStudentsModalContent" styleClass="modal-content">
                  <div class="modal-header alignLeft">
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&#215;</span></button>
                      <h2 class="modal-title">Add Students to Credential</h2>
                  </div>
                  
                  <div class="searchInstructors">
                      <p:remoteCommand 
                    		name="execSearchUnenrolledStudents" 
                    		process="inputStudentSearch"
							update=":formEnrollStudents:panelStudents"
							action="#{studentEnrollBean.resetAndSearch()}" />							
						<h:inputText id="inputStudentSearch"
							type="search"
							styleClass="studentSearchField"
							placeholder="Search Students"
							value="#{studentEnrollBean.studentSearchTerm}"
							onclick="$(this).select();"
							onkeyup="searchListener(execSearchUnenrolledStudents);">
						</h:inputText>         
                  </div>
                  <h:panelGroup id="panelStudents">
	                  <ul class="list">
	                  	<ui:repeat id="repeat" var="student" value="#{studentEnrollBean.students}" varStatus="status">
	                  		<li>
	                          <div class="instructorInfo">
	                              <div class="checkbox checkLine">
	                              	  <h:selectBooleanCheckbox id="selectBooleanEnrollStudent"
	                              	  	styleClass="hiddenStudentLink"
	                              	  	pt:data-id="checkStudentHidden#{status.index}"
	                                    value="#{student.enrolled}">
	                                    <p:ajax 
	                                    	event="change" 
	                                    	process="@this" 
	                                    	listener="#{studentEnrollBean.studentEnrollChecked(status.index)}">
	                                    </p:ajax>
	                              	  </h:selectBooleanCheckbox>
	                              	  <h:outputLabel for="selectBooleanEnrollStudent" />               
	                              </div>
	                              <utilcomp:userAvatar
										avatar="#{student.user.avatarUrl}"
										fullName="#{student.user.fullName}"	
										width="48"
										height="48"
								  />  
	                              <div class="infoWrap">
	                                  <h3>#{student.user.fullName}</h3>
	                                  <span>#{student.user.position}</span>
	                              </div>
	                          </div>
	                      </li>
	                  	</ui:repeat>
	                  </ul>
	                  <utilcomp:pagination
			        	id="pagination1" 
			        	bean="#{studentEnrollBean}"
			        	toUpdate=":formEnrollStudents:panelStudents"
				  	  />
                  </h:panelGroup>
                  
                  <h:panelGroup layout="block" id="panelAssignLink" styleClass="modal-footer alignLeft">
               		<p:commandLink
                  	  	value="Add"
                  	  	styleClass="btn btn-green"
                  	  	action="#{credentialMembersBean.addStudentsAndResetData()}"
                  	  	update=":formMain:growlMain :formMain:panelStudents :formMain:pagination :formSearch:panelSearchFilters :formSearch:panelSort"
                  	  	oncomplete="$('#addStudentsModal').modal('hide');">
                  	</p:commandLink>
                  </h:panelGroup>
			</h:panelGroup>
			</div>
		</div>
    </h:form>
	
	<dlgComp:instructorAssign id="dlgInstructors"
		title="Assign instructor to #{credentialMembersBean.studentToAssignInstructor.user.fullName}"
		bean="#{credentialMembersBean}"
		instructorList="#{credentialMembersBean.credentialInstructors}"
		toUpdate=":formMain:panelStudents :formMain:growlMain"/>
	
</ui:define>
</ui:composition>
