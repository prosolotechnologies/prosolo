<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:comp="http://java.sun.com/jsf/composite/components"
	template="templates/masterLayout1.xhtml"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:dlg="http://java.sun.com/jsf/composite/components/dialogs"
	xmlns:actions="http://java.sun.com/jsf/composite/components/actions"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:util="http://www.prosolo.com/util"
	xmlns:dlgComp="http://java.sun.com/jsf/composite/components/dialogs/manager">

	<ui:define name="windowTitle">
		Course members
	</ui:define>

	<ui:define name="metadata">
		<f:metadata>
			<f:viewParam name="id" value="#{courseMembersBean.id}" default="null" />
			<f:viewParam name="courseName" default="null" />
			<f:viewAction action="#{courseMembersBean.init()}" />
		</f:metadata>
	</ui:define>

	<ui:define name="content">

		<script src="#{request.contextPath}/manage/js/stickyTable.js"></script>
		
		<script>
			function searchListener(execFunction) {
				var $this = this;
				//this.updateUrlQuery(); 
				
				var delayedSearch = function(){
					execFunction();
				};
	
				window.clearTimeout(this.keystrokeTimeout);
				this.keystrokeTimeout = window.setTimeout(delayedSearch, 350);
			};
		</script>

		<section class="heading">
			<header>
				<img class="ico40" title="Credentials" alt="Credentials"
					src="#{request.contextPath}/resources/images/ico-credentials.svg"></img>
				<div class="headerTitle">
					<h1>#{param['courseName']}</h1>
					<p>Student progression grid</p>
				</div>


			</header>
		</section>

		<section class="container-fluid mainArea">

			<div class="row">
				<div class="panel panel-default">
					<div class="panel-heading">
						<h3 class="panel-title">Students list</h3>
					</div>
					<div class="row narrow searchFilter">
						<div class="col-md-12">
							<h:form id="filterStudentsForm">
								<h:panelGroup id="panelNoStudent" styleClass="records">Students: <strong>#{courseMembersBean.courseMembersNumber}</strong></h:panelGroup> <span
									class="checkbox checkbox-success checkbox-inline">
									<h:selectBooleanCheckbox id="checkbox2" value="#{courseMembersBean.filterUnassigned}">
										<p:ajax event="click" process="@this checkbox2" 
											listener="#{courseMembersBean.filterCourseMembers}" update=":studentListForm panelNoStudent" />
									</h:selectBooleanCheckbox>
									<label for="checkbox2">Show
										only unassigned</label> 
								</span>
							</h:form>
							<h:form class="form-inline searchField">
								<p:remoteCommand name="execSearch" 
									process="inputFilterByName"
									update=":studentListForm :filterStudentsForm:panelNoStudent" 
									actionListener="#{courseMembersBean.resetSearchOptions}"
									action="#{courseMembersBean.searchCourseMembers}" />
 
								<div class="form-group">
									<h:inputText id="inputFilterByName" 
										value="#{courseMembersBean.searchTerm}"
								    	pt:placeholder=" Filter by name"
								    	styleClass="form-control"
								    	onclick="$(this).select();" 
								    	onkeydown="searchListener(execSearch);"></h:inputText>
								</div>
							</h:form>
						</div>
					</div>
					<h:form id="studentListForm">
					    <p:growl id="studentListGrowl" showDetail="true"></p:growl>
						<table class="table tableProsolo">
							<thead>
								<tr>
									<th class="colNo" scope="col">No.</th>
									<th class="colStudent" scope="col">
									    <p:commandLink
									     	process="@this"
									    	actionListener="#{courseMembersBean.setSortByStudentName}"
									    	action="#{courseMembersBean.searchCourseMembers}"
									    	update="studentListForm">
									    	Student
									    	<h:panelGroup rendered="#{courseMembersBean.sortByStudent}">
									    		<i class="#{courseMembersBean.isASCOrder() ? 'fa fa-caret-up' : 'fa fa-caret-down'}"></i>
									    	</h:panelGroup>
									    </p:commandLink>
									</th>
									<th scope="col" class="colProfile">
										 <p:commandLink
									     	process="@this"
									    	actionListener="#{courseMembersBean.setSortByProfileType}"
									    	action="#{courseMembersBean.searchCourseMembers}"
									    	update="studentListForm">
									    	Profile Type
									    	<h:panelGroup rendered="#{courseMembersBean.sortByProfileType}">
									    		<i class="#{courseMembersBean.isASCOrder() ? 'fa fa-caret-up' : 'fa fa-caret-down'}"></i>
									    	</h:panelGroup>
									    </p:commandLink>
									</th>
									<th class="colProgression" scope="col">
										 <p:commandLink
									     	process="@this"
									    	actionListener="#{courseMembersBean.setSortByCourseProgress}"
									    	action="#{courseMembersBean.searchCourseMembers}"
									    	update="studentListForm">
									    	Progression
									    	<h:panelGroup rendered="#{courseMembersBean.sortByCourseProgress}">
									    		<i class="#{courseMembersBean.isASCOrder() ? 'fa fa-caret-up' : 'fa fa-caret-down'}"></i>
									    	</h:panelGroup>
									    </p:commandLink>
									</th>
									<th class="colInstructor" scope="col">
									    Instructor
									</th>
								</tr>
							</thead>
							<tbody>
								<ui:repeat var="user" value="#{courseMembersBean.members}"
									varStatus="status">
									<tr>
										<td class="colNoD">#{status.index + 1}</td>
										<td class="colStudentD">
											<span
												class="userProfileImageLarge"> <h:link
													outcome="/manage/studentProfile">
													<h:graphicImage id="userImageId" value="#{user.avatarUrl}"
														title="#{user.fullName}" alt="#{user.fullName}" />
													<f:param name="id" value="#{util:encodeId(user.id)}" />
												</h:link>
											</span>
											<div class="name">
												<h1>
													<h:link outcome="/manage/studentProfile">
														#{user.fullName}
												    	<f:param name="id" value="#{util:encodeId(user.id)}" />
													</h:link>
												</h1>
												<h2>#{user.position}</h2>
											</div>
										</td>
										<td class="colProfileD">
	
											<div class="profileTypeBadgeTable">
												<span>TYPE</span> <span class="number">1</span>
											</div>
										</td>
										<td class="colProgressionD">#{user.courseProgress}%</td>
										<td class="colInstructorD">
											<p:commandLink
												styleClass="btn btn-default"
												pt:role="button" 
												rendered="#{user.instructor == null}"
												process="@this"
												action="#{courseMembersBean.loadCourseInstructors(user)}"
												oncomplete="$('#assignInstructorModal').modal('show');"
												update=":dlgInstructors:modalForm:assignInstructorModalContent">
												<i class="fa fa-plus"></i> Assign Instructor
											</p:commandLink> 
											<h:link rendered="#{user.instructor != null}">
														#{user.instructor.fullName}
												    	<f:param name="id"
													value="#{util:encodeId(user.instructor.id)}" />
											</h:link></td>
									</tr>
								</ui:repeat>
	
							</tbody>
						</table>
						
						<div class="tableProsoloNavigation">
						<ul class="pagination">
							<ui:fragment rendered="#{courseMembersBean.isCurrentPageFirst()}">
								<li class="disabled">
									<a id="linkPreviousDisabled" aria-label="Previous" href="#">
										<span aria-hidden="true"><i class="fa fa-angle-left"></i></span>
									</a>
								</li>
							</ui:fragment>
							<ui:fragment rendered="#{!courseMembersBean.isCurrentPageFirst()}">
								<li>
									<p:commandLink 
										process="@this"
									    actionListener="#{courseMembersBean.setPage(courseMembersBean.page - 1)}"
									    action="#{courseMembersBean.searchCourseMembers}"
									    update=":studentListForm"
										pt:aria-label="Previous">
										<span
											aria-hidden="true"><i class="fa fa-angle-left"></i>
										</span>
									</p:commandLink>
								
								</li>
							</ui:fragment>
						<ui:repeat var="link" value="#{courseMembersBean.paginationLinks}">
							<ui:fragment rendered="#{link.isLink()}">
								<li class="#{link.selected ? 'active' : ''}">
									<p:commandLink
								     	process="@this"
								    	actionListener="#{courseMembersBean.setPage(link.page)}"
								    	action="#{courseMembersBean.searchCourseMembers}"
								    	update=":studentListForm">
								    	#{link.linkOutput}
								    </p:commandLink>
							    </li>   
							</ui:fragment>	
							
							<ui:fragment rendered="#{!link.isLink()}">
								<li><span>#{link.linkOutput}</span></li>
							</ui:fragment>		
						</ui:repeat>
							<ui:fragment rendered="#{courseMembersBean.isCurrentPageLast()}">
								<li class="disabled">
									<a id="linkNextDisabled" aria-label="Next" href="#">
										<span
											aria-hidden="true"><i class="fa fa-angle-right"></i>
										</span>
									</a>
								</li>
							</ui:fragment>
							<ui:fragment rendered="#{!courseMembersBean.isCurrentPageLast()}">
								<li>
									<p:commandLink 
										process="@this"
									    actionListener="#{courseMembersBean.setPage(courseMembersBean.page + 1)}"
									    action="#{courseMembersBean.searchCourseMembers}"
									    update=":studentListForm"
										pt:aria-label="Next">
										<span
											aria-hidden="true"><i class="fa fa-angle-right"></i>
										</span>
									</p:commandLink>
								
								</li>
							</ui:fragment>
						</ul>
						<script>
						
						function preventSendingToTheTopOfThePage(id) {
							$("#" + id).click(function(e) {
							    if(e.preventDefault)
							        e.preventDefault();
							    else
							        e.stop();
							});	
						};
						preventSendingToTheTopOfThePage("linkNextDisabled");
						preventSendingToTheTopOfThePage("linkPreviousDisabled");
						</script>
					</div>
					
					
					</h:form>

				</div>
			</div>

		</section>

		<dlgComp:instructorAssign id="dlgInstructors"
			title="Assign instructor to #{courseMembersBean.userToAssignInstructor.fullName}"
			bean="#{courseMembersBean}"
			searchListener="searchListener"
			instructorList="#{courseMembersBean.courseInstructors}"
			updateRegion=":studentListForm" 
			page="#{facesContext.viewRoot.viewId}"/>
		
		<ui:remove><h:form id="modalForm">
			<div id = "assignInstructorModal" class="modal fade assignInstructor" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
				         <div class="modal-dialog">
				            <h:panelGroup layout="block" id="assignInstructorModalContent" styleClass="modal-content">
				               <div class="modal-header"> <button aria-label="Close" data-dismiss="modal" class="close" type="button"><span aria-hidden="true">×</span></button> 
				               	<h4 id="myLargeModalLabel" class="modal-title">Assign instructor to #{courseMembersBean.userToAssignInstructor.fullName}</h4> </div>
				               <div class="row narrow filterModal">
					               	<div class="col-md-12">
			                  			<p:remoteCommand name="execInstructorSearch" 
											process="inputInstructorSearch"
											update=":dlgInstructors:modalForm:instructorSearchResults" 
											action="#{courseMembersBean.loadCourseInstructors()}" />
					                     <div class="form-group">
					                        <label>Search</label>    
					                        <h:inputText 
					                        	id="inputInstructorSearch"
					                        	value="#{courseMembersBean.instructorSearchTerm}"
					                        	pt:placeholder=" Start typing..."
					                        	styleClass="form-control"
					                        	onclick="$(this).select();" 
									    		onkeydown="searchListener(execInstructorSearch);">
					                        </h:inputText>
					                     </div>
					               </div>
					           </div>
				               <h:panelGroup layout="block" id="instructorSearchResults" styleClass="modal-body userList">
				                  <table width="100%" border="0" cellspacing="0" cellpadding="0">
				                     <ui:repeat var="instructor" value="#{courseMembersBean.courseInstructors}">
				                     	<tr>
				                        	<td>
					                        	<div class="userInfo">
					                           	<span class="userProfileImage">
					                           		<h:graphicImage value="#{instructor.avatarUrl}"
														title="#{instructor.name}" alt="#{instructor.name}" />
					                           	</span>
					                              #{instructor.name}		                           
					                           </div>
					                        </td>
					                        <td class="affiliation">
					                        	#{instructor.position}
					                        </td>
					                        <td>
					                        	<span class="assigned #{instructor.full ? full : ''}" 
					                        		data-toggle="tooltip" data-placement="top" title="Assigned/Limit">
					                        		#{instructor.numberOfAssignedStudents}/#{instructor.maxNumberOfStudents}
					                        	</span>
					                        </td>
					                        <td class="assign">
					                        	<ui:fragment rendered="#{!instructor.full}">
					                        		<p:commandLink 
					                        			value="Select"
					                        			styleClass="btn btn-default"
					                        			pt:role="button"
					                        			action="#{courseMembersBean.assignInstructorToStudent(instructor)}"
					                        			update=":studentListForm"
					                        			oncomplete="$('#assignInstructorModal').modal('hide');">	
					                        		</p:commandLink>
					                        	</ui:fragment>
					                        	
					                        	<ui:fragment rendered="#{instructor.full}">
					                        		Load limit reached
					                        	</ui:fragment>
					                        </td>
					                     </tr>
				                     </ui:repeat>                                                     
				                                                               
				                  </table>
				
				               </h:panelGroup>
				            </h:panelGroup>
				         </div>
      				</div>
		</h:form></ui:remove>

	</ui:define>
</ui:composition>
