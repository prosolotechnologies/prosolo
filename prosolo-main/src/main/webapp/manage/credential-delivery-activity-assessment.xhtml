<ui:composition xmlns="http://www.w3.org/1999/xhtml"
				xmlns:h="http://java.sun.com/jsf/html"
				xmlns:f="http://java.sun.com/jsf/core"
				xmlns:ui="http://java.sun.com/jsf/facelets"
				xmlns:p="http://primefaces.org/ui"
				template="templates/masterLayout2.xhtml"
				xmlns:activities="http://java.sun.com/jsf/composite/components/activities"
				xmlns:assessment="http://java.sun.com/jsf/composite/components/assessments"
				xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
				xmlns:post="http://java.sun.com/jsf/composite/components/post"
				xmlns:util="http://www.prosolo.com/util">

	<ui:define name="windowTitle">
		Assessment - #{credentialActivityAssessmentsBeanManager.assessmentsSummary.title} - #{credentialActivityAssessmentsBeanManager.credentialTitle} - ProSolo
	</ui:define>

	<ui:define name="metadata">
		<f:metadata>
			<f:viewParam name="targetActId" value="#{credentialActivityAssessmentsBeanManager.targetActId}" default="null" />
			<f:viewParam name="actId" value="#{credentialActivityAssessmentsBeanManager.actId}" default="null" />
			<f:viewParam name="credId" value="#{credentialActivityAssessmentsBeanManager.credId}" default="null"/>
			<f:viewParam name="comment" value="#{credentialActivityAssessmentsBeanManager.commentId}" default="null"/>
			<f:viewAction action="#{credentialActivityAssessmentsBeanManager.initIndividualResponse()}" />
		</f:metadata>
	</ui:define>

	<utilcomp:messagesBundle var="msg" />

    <ui:define name="resourceTitle">
    	<h1>#{credentialActivityAssessmentsBeanManager.assessmentsSummary.title}</h1>
    </ui:define>
    
	<ui:define name="content">
	<h:outputStylesheet library="css2" name="bootstrap-slider.css"  />
	<script	src="#{request.contextPath}/resources/javascript2/bootstrap-slider.min.js"></script>
	<script>
		$(function() {
			if(#{not empty param['comment']}) {
				if(#{credentialActivityAssessmentsBeanManager.individualActivityResponse.resultComments.initialized}) {
					$('#commentsContainerDiv#{credentialActivityAssessmentsBeanManager.individualActivityResponse.targetActivityId}').collapse();
				}
				scrollTo('comment_' + #{util:decodeId(param['comment'])});
			}	
		});
		
		function markDiscussionAsSeen(discussionId, parentElement) {
			markActivityDiscussionRead([{name:'encodedActivityDiscussionId', value:discussionId}])
			$(parentElement).removeClass( "hasNewComments" );
		}
	</script>
	<h:form prependId="false" id="remoteCommandForm">
		<p:remoteCommand action="#{credentialActivityAssessmentsBeanManager.markDiscussionRead()}" name="markActivityDiscussionRead"></p:remoteCommand>
	</h:form>
	
	<ui:param name="learningContext" value="name:credential|id:#{credentialActivityAssessmentsBeanManager.decodedCredId}|context:/name:activity|id:#{credentialActivityAssessmentsBeanManager.decodedActId}|context:/name:target_activity|id:#{credentialActivityAssessmentsBeanManager.decodedTargetActId}|context:/name:RESULTS///"/>
	<p:growl id="growlMain" showDetail="true" globalOnly="true" />
	
    <div class="whiteBar">

    </div>

	<div class="container">
		<ol class="breadcrumb">
			<li>
				<h:link value="#{msg['label.credential.plural']}" outcome="/manage/credentialLibrary"/>
			</li>
			<li>
				<h:link
						value="#{credentialActivityAssessmentsBeanManager.credentialTitle}"
						outcome="/manage/credential"
						onclick="sendLogPageNavigation('/manage/credential.xhtml',
						'#{facesContext.viewRoot.viewId}',
						'#{util:addSubContext(learningContext, &#34;name:breadcrumbs&#34;)}',
						'');">
					<f:param name="id" value="#{param.credId}"></f:param>
				</h:link>
			</li>
			<li>
				<h:link
						value="Assessments"
						outcome="/manage/credential-delivery-assessments"
						onclick="sendLogPageNavigation('/manage/credential-delivery-assessments.xhtml',
						'#{facesContext.viewRoot.viewId}',
						'#{util:addSubContext(learningContext, &#34;name:breadcrumbs&#34;)}',
						'');">
					<f:param name="id" value="#{param.credId}"></f:param>
				</h:link>
			</li>
			<li>
				<h:link
					value="#{credentialActivityAssessmentsBeanManager.assessmentsSummary.title}"
					outcome="/manage/credential-delivery-assessments-activity"
					onclick="sendLogPageNavigation('/manage/credential-delivery-assessments-activity.xhtml',
						'#{facesContext.viewRoot.viewId}',
						'#{util:addSubContext(learningContext, &#34;name:breadcrumbs&#34;)}',
						'');">
					<f:param name="id" value="#{param.credId}"/>
					<f:param name="activityId" value="#{param.actId}"/>
				</h:link>
			</li>
			<li class="active">
				#{credentialActivityAssessmentsBeanManager.resultOwnerFullName}
			</li>
		</ol>
	</div>

    <div class="container">
        <div class="row">
            <div class="col-md-8">
            	<h:panelGroup id="panelUploadAssignment">
	                <h2>Activity Response</h2>
					<activities:activityResult
							bean="#{credentialActivityAssessmentsBeanManager}"
							resultData="#{credentialActivityAssessmentsBeanManager.individualActivityResponse}"
							resultType="#{credentialActivityAssessmentsBeanManager.activityResultType}"
							learningContext="#{learningContext}"
							role="MANAGER"
							assignmentUploadModalId=""
							growlToUpdate=":growlMain"
							regionToUpdate=""
							privateConvModalId="assessmentCommentsModal1"
							toUpdateConvModal=":commentModal:formPrivateConversation:panelModalPrivateConversation"
							privateConvNumberOfMsgsLink="privateConvMsgsNoLink_#{credentialActivityAssessmentsBeanManager.decodedTargetActId}"
							assessmentGradeLinkOnComplete="showPopupSidebar('#cbp-spmenu-s2');"
							gradeLink="gradeLink_#{credentialActivityAssessmentsBeanManager.decodedTargetActId}"
							toUpdateAssessmentGradeModal=":activityGradePanel:gradePanel"
							otherResultCommentModalId="assessmentCommentsModal1b"
							toUpdateOtherResultCommentModal=":formCommentOnOtherResult:panelModalAssessmentComments"
							credId="#{credentialActivityAssessmentsBeanManager.decodedCredId}"
					/>
	           	</h:panelGroup>
            </div>
        </div>
    </div>
    
	<activities:activityCommentModal 
    	id="commentModal"
		toUpdate=":growlMain @(.privateConvMsgsNoLink_#{credentialActivityAssessmentsBeanManager.decodedTargetActId})"/>

	<assessment:gradePanel
			id="activityGradePanel"
			gradeActionMethodName="updateGrade"
			gradeAction="#{credentialActivityAssessmentsBeanManager.updateGrade}"
			assessmentId="#{not empty activityAssessmentBean.activityAssessmentData ? util:decodeId(activityAssessmentBean.activityAssessmentData.encodedActivityAssessmentId) : 0}"
			completed="#{not empty activityAssessmentBean.activityAssessmentData ? activityAssessmentBean.activityAssessmentData.completed : false}"
			gradeData="#{not empty activityAssessmentBean.activityAssessmentData ? activityAssessmentBean.activityAssessmentData.grade : null}"
			resource="ACTIVITY"
			toUpdate=":growlMain @(.gradeLink_#{credentialActivityAssessmentsBeanManager.decodedTargetActId})"
			learningContext="#{learningContext}"
			gradePanelSidebarId="gradeSidebar"
	/>

	<h:form id="formCommentOnOtherResult">
		<div class="modal fade assessmentCommentsModal"
			 id="assessmentCommentsModal1b" tabindex="-1" role="dialog"
			 aria-labelledby="assessmentCommentsModal">

			<div class="modal-dialog modal-lg">
				<h:panelGroup id="panelModalAssessmentComments" layout="block" class="modal-content">
					<div class="modal-header alignLeft">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">Ã—</span>
						</button>
						<h2 class="modal-title">Response by #{credentialActivityAssessmentsBeanManager.currentResult.user.fullName}</h2>
					</div>

					<ui:fragment rendered="#{credentialActivityAssessmentsBeanManager.activityResultType eq 'FILE_UPLOAD'}">
						<div class="activityResultFile">
							<div class="activityResultHead">
								<div class="user32">
									<utilcomp:userAvatar
											avatar="#{credentialActivityAssessmentsBeanManager.currentResult.user.avatarUrl}"
											fullName="#{credentialActivityAssessmentsBeanManager.currentResult.user.fullName}" />
									<h3>
										<h:link outcome="/manage/studentProfile">
											#{credentialActivityAssessmentsBeanManager.currentResult.user.fullName}
											<f:param name="id" value="#{util:encodeId(credentialActivityAssessmentsBeanManager.currentResult.user.id)}" />
											<f:param name="cred" value="#{param.credId}" />
										</h:link>
									</h3>
								</div>
								<div class="timestamp">#{credentialActivityAssessmentsBeanManager.currentResult.prettyResultPostDate}</div>
							</div>
							<div class="resultWrapper">
								<div class="actBoxLeft noUrl">
									<h3>#{credentialActivityAssessmentsBeanManager.currentResult.assignmentTitle}</h3>
								</div>
								<a href="#{credentialActivityAssessmentsBeanManager.currentResult.result}" class="btn btn-green btn-sm">Download</a>
							</div>
							<div class="discussion">
								<div class="comments">
									<ul class="media-list">
										<ui:repeat var="comment" value="#{credentialActivityAssessmentsBeanManager.currentResult.resultComments.comments}">
											<li class="media">
												<post:comment1 id="comment"
															   comments="#{credentialActivityAssessmentsBeanManager.currentResult.resultComments}"
															   comment="#{comment}" isTopLevel="true"
															   newestCommentId="newestCommentId#{credentialActivityAssessmentsBeanManager.currentResult.targetActivityId}"
															   toUpdate="@(.panelNewestComment_#{credentialActivityAssessmentsBeanManager.currentResult.targetActivityId}) growlMain"
															   learningContext="#{learningContext}" />
											</li>
										</ui:repeat>
									</ul>
								</div>

								<div class="addComment">
									<utilcomp:userAvatar
											avatar="#{loggeduser.avatar}"
											fullName="#{loggeduser.fullName}" />

									<div class="commentForm">
										<h:inputTextarea class="hidden"
														 value="#{credentialActivityAssessmentsBeanManager.currentResult.resultComments.topLevelComment}" />

										<div class="contentEditableComment" placeholder="Add Comment..."
											 strip-br="true" contenteditable="true"
											 onkeyup="displaySubmitButton(this);"></div>

										<p:commandButton styleClass="btn btn-sm btn-green hidden submitBtn"
														 value="Submit"
														 action="#{commentBean.saveTopLevelComment(credentialActivityAssessmentsBeanManager.currentResult.resultComments)}"
														 update="panelModalAssessmentComments :growlMain">
											<f:param name="page" value="#{facesContext.viewRoot.viewId}" />
											<f:param name="learningContext"
													 value="#{util:addSubContext(learningContext, 'name:comment')}" />
										</p:commandButton>
									</div>

									<script>
										$('#' + escapeColons('formCommentOnOtherResult:panelModalAssessmentComments') + ' .addComment .contentEditableComment').on('keyup', function(e) {
											$(this).parent().find('textarea').val($(this).html());
										});
									</script>
								</div>
								<div class="clear"></div>
							</div>
						</div>
					</ui:fragment>

					<ui:fragment rendered="#{credentialActivityAssessmentsBeanManager.activityResultType eq 'TEXT'}">
						<div class="activityResultText">
							<div class="activityResultHead">
								<div class="user32">
									<utilcomp:userAvatar
											avatar="#{credentialActivityAssessmentsBeanManager.currentResult.user.avatarUrl}"
											fullName="#{credentialActivityAssessmentsBeanManager.currentResult.user.fullName}" />
									<h3>
										<h:link outcome="/manage/studentProfile">
											#{credentialActivityAssessmentsBeanManager.currentResult.user.fullName}
											<f:param name="id" value="#{util:encodeId(credentialActivityAssessmentsBeanManager.currentResult.user.id)}" />
											<f:param name="cred" value="#{param.credId}" />
										</h:link>
									</h3>
								</div>
								<div class="timestamp">
									#{credentialActivityAssessmentsBeanManager.currentResult.prettyResultPostDate}
								</div>
							</div>

							<div class="activityResultTextContent">
								<p class="commentText">
									<h:outputText escape="false" value="#{credentialActivityAssessmentsBeanManager.currentResult.result}" />
								</p>
							</div>

							<div class="discussion">
								<div class="comments">
									<ul class="media-list">
										<ui:repeat var="comment" value="#{credentialActivityAssessmentsBeanManager.currentResult.resultComments.comments}">
											<li class="media">
												<post:comment1 id="comment"
															   comments="#{credentialActivityAssessmentsBeanManager.currentResult.resultComments}"
															   comment="#{comment}" isTopLevel="true"
															   newestCommentId="newestCommentId#{credentialActivityAssessmentsBeanManager.currentResult.targetActivityId}"
															   toUpdate="@(.panelNewestComment_#{credentialActivityAssessmentsBeanManager.currentResult.targetActivityId}) growlMain"
															   learningContext="#{learningContext}" />
											</li>
										</ui:repeat>
									</ul>
								</div>

								<div class="addComment">
									<utilcomp:userAvatar
											avatar="#{loggeduser.avatar}"
											fullName="#{loggeduser.fullName}" />

									<div class="commentForm">
										<h:inputTextarea class="hidden"
														 value="#{credentialActivityAssessmentsBeanManager.currentResult.resultComments.topLevelComment}" />

										<div class="contentEditableComment" placeholder="Add Comment..."
											 strip-br="true" contenteditable="true"
											 onkeyup="displaySubmitButton(this);"></div>

										<p:commandButton styleClass="btn btn-sm btn-green hidden submitBtn"
														 value="Submit"
														 action="#{commentBean.saveTopLevelComment(credentialActivityAssessmentsBeanManager.currentResult.resultComments)}"
														 update="panelModalAssessmentComments :growlMain">
											<f:param name="page" value="#{facesContext.viewRoot.viewId}" />
											<f:param name="learningContext"
													 value="#{util:addSubContext(learningContext, 'name:comment')}" />
										</p:commandButton>
									</div>

									<script>
										$('#' + escapeColons('formCommentOnOtherResult:panelModalAssessmentComments') + ' .addComment .contentEditableComment').on('keyup', function(e) {
											$(this).parent().find('textarea').val($(this).html());
										});
									</script>
								</div>
								<div class="clear"></div>
							</div>
						</div>
					</ui:fragment>

				</h:panelGroup>
			</div>
		</div>
	</h:form>
    
</ui:define>
</ui:composition>
