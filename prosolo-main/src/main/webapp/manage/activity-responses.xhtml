<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:comp="http://java.sun.com/jsf/composite/components"
	template="templates/masterLayout2.xhtml"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:dlg="http://java.sun.com/jsf/composite/components/dialogs"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:util="http://www.prosolo.com/util"
	xmlns:activities="http://java.sun.com/jsf/composite/components/activities"
	xmlns:post="http://java.sun.com/jsf/composite/components/post">

<ui:define name="windowTitle">
	Activity Responses - #{activityResultsBeanManager.activity.title}
</ui:define>

<ui:define name="metadata">
	<f:metadata>
		<f:viewParam name="actId" value="#{activityResultsBeanManager.actId}" default="null" />
		<f:viewParam name="compId" value="#{activityResultsBeanManager.compId}" default="null"/>
		<f:viewParam name="credId" value="#{activityResultsBeanManager.credId}" default="null"/>
		<f:viewParam name="user" default="null"/>
		<f:viewParam name="p" value="#{activityResultsBeanManager.paginationData.pageString}" default="1"/>
		<f:viewAction action="#{activityResultsBeanManager.init()}" />
	</f:metadata>
</ui:define>

<ui:define name="resourceTitle">
	<h1>#{activityResultsBeanManager.activity.title}</h1>
	<ul class="nav nav-tabs headerSubmenu">
		<li role="presentation">
			<h:link outcome="/manage/activity">
			Activity Details
			<f:param name="credId" value="#{param['credId']}"></f:param>
			<f:param name="compId" value="#{param['compId']}"></f:param>
			<f:param name="actId" value="#{param['actId']}"></f:param>
			</h:link>
		</li>
		<li role="presentation" class="active"><a href="javascript:void(0);">Responses</a></li>
	</ul>
</ui:define>
   
<ui:define name="content">
	<h:outputStylesheet library="css2" name="bootstrap-slider.css"  />
	<script	src="#{request.contextPath}/resources/javascript2/bootstrap-slider.min.js"></script>
	
	<script>
		function markDiscussionAsSeen(discussionId, parentElement) {
			markActivityDiscussionRead([{name:'encodedActivityDiscussionId', value:discussionId}])
			$(parentElement).removeClass( "hasNewComments" );
		}
		
		//comment form hide/show
		function displaySubmitButtonPrivateConvModal(inputElem) {
		    if ($(inputElem).val().length==0) {
		        $(inputElem).next('a.btn-green').addClass('hidden');
		    } else {
		        $(inputElem).next('a.btn-green').removeClass('hidden');
		    }
		}

	</script>
	<h:form prependId="false" id="remoteCommandForm">
		<p:remoteCommand action="#{activityResultsBeanManager.markDiscussionRead()}" name="markActivityDiscussionRead"></p:remoteCommand>
	</h:form>
	
	<ui:param name="learningContext" value="name:credential|id:#{activityResultsBeanManager.decodedCredId}|context:/name:competence|id:#{activityResultsBeanManager.decodedCompId}|context:/name:activity|id:#{activityResultsBeanManager.decodedActId}|context:/name:RESULTS///" />
	<ui:param name="canEdit" value="#{activityResultsBeanManager.activity.type == 'UNIVERSITY_CREATED' 
     		and request.isUserInRole('MANAGE.CONTENT.EDIT')}" />
     		
	<p:growl id="growlMain" showDetail="true" globalOnly="true"></p:growl>
    <div class="whiteBar">
        <div class="container">
            <activities:activityHeaderOptions
				bean="#{activityResultsBeanManager}"
				activity="#{activityResultsBeanManager.activity}"
				learningContext="#{learningContext}"
				canEdit="#{canEdit}"
				isPreview="false"
			/>
        </div>
    </div>

    <div class="container">
        <ol class="breadcrumb">
            <li>
            	<h:link value="Credentials" outcome="/manage/credentialLibrary"/>
            </li>
            <li>
            	<h:link 
            		value="#{activityResultsBeanManager.credentialTitle}"
            		outcome="/manage/credential"
            		onclick="sendLogPageNavigation('/manage/credential.xhtml', 
							'#{facesContext.viewRoot.viewId}', 
							'#{util:addSubContext(learningContext, &#34;name:breadcrumbs|context:/name:CREDENTIAL|id:&#34;.concat(activityResultsBeanManager.decodedCredId).concat(&#34;/&#34;))}', 
							'');">
            		<f:param name="id" value="#{param['credId']}"></f:param>
            	</h:link>
            </li>
            <li>
            	<h:link 
            		value="#{activityResultsBeanManager.competenceTitle}"
            		outcome="/manage/competence"
            		onclick="sendLogPageNavigation('/manage/competence.xhtml', 
							'#{facesContext.viewRoot.viewId}', 
							'#{util:addSubContext(learningContext, &#34;name:breadcrumbs|context:/name:COMPETENCE|id:&#34;.concat(activityResultsBeanManger.decodedCompId).concat(&#34;/&#34;))}', 
							'');">
            		<f:param name="compId" value="#{param['compId']}"></f:param>
            		<f:param name="credId" value="#{param['credId']}"></f:param>
            	</h:link>
            </li>
            <li>
            	<h:link 
            		value="#{activityResultsBeanManager.activity.title}"
            		outcome="/manage/activity"
            		onclick="sendLogPageNavigation('/manage/activity.xhtml', 
							'#{facesContext.viewRoot.viewId}', 
							'#{util:addSubContext(learningContext, &#34;name:breadcrumbs|context:/name:activity|id:&#34;.concat(activityResultsBeanUser.decodedActId).concat(&#34;/&#34;))}', 
							'');">
					<f:param name="actId" value="#{param['actId']}"></f:param>
            		<f:param name="compId" value="#{param['compId']}"></f:param>
            		<f:param name="credId" value="#{param['credId']}"></f:param>
            	</h:link>
            	
            </li>
            <li class="active">
            	Responses
            </li>
        </ol>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-9">
                <h2>Student Responses</h2>
                <ui:fragment rendered="#{empty activityResultsBeanManager.activity.studentResults}">
                	 <div class="noContentMessage">
	                    <p>
	                        No responses to show.
	                    </p>
	                </div>
                </ui:fragment>
                <h:panelGroup id="panelResults">
	                <ui:repeat var="result" value="#{activityResultsBeanManager.activity.studentResults}">
	                	 <activities:activityResult
	                	 	bean="#{activityResultsBeanManager}"
		           			resultData="#{result}"
		           			resultType="#{activityResultsBeanManager.activityResultType}"
		           			learningContext="#{learningContext}"
		           			role="MANAGER"
		           			assignmentUploadModalId=""
		           			growlToUpdate=":growlMain"
		           			regionToUpdate=""
		           			privateConvModalId="assessmentCommentsModal1"
		           			toUpdateConvModal=":formPrivateConversation:panelModalPrivateConversation"
		           			otherResultCommentModalId="assessmentCommentsModal1b"
		           			toUpdateOtherResultCommentModal=":formCommentOnOtherResult:panelModalAssessmentComments"
		           			privateConvNumberOfMsgsLink="privateConvMsgsNoLink_#{result.targetActivityId}"
		           			assessmentGradeModalId="assessmentGradeModal1"
		           			gradeLink="gradeLink_#{result.targetActivityId}"
		           			toUpdateAssessmentGradeModal=":activityGradeModal:formGradeModal:panelGradeModal"
		           		/>
	                </ui:repeat>
                </h:panelGroup>
                
               <ui:remove> <h:form id="formPagination">
	                <utilcomp:pagination
			        	id="pagination" 
			        	bean="#{activityResultsBeanManager}"
			        	toUpdate=":panelResults"
			        />
			    </h:form></ui:remove>
            </div>
            <div class="col-md-3">
                <div class="whiteBox">
                	<h:form id="formFilters">
	                    <h2>Show</h2>
	                    <h:panelGroup id="panelFilters">		                  
		                    <c:forEach items="#{activityResultsBeanManager.filters}" var="filter" varStatus="status">
		                    	<div class="checkbox checkLine">
			                    	<h:selectBooleanCheckbox id="checkboxFilter#{filter.filter}" value="#{filter.applied}">
										<p:ajax event="click" process="@this"
											listener="#{activityResultsBeanManager.filterChanged(filter)}" update=":panelResults" />
									</h:selectBooleanCheckbox>
									<h:outputLabel for=":formFilters:checkboxFilter#{filter.filter}">#{filter.filter.label}</h:outputLabel>
								</div>
		                    </c:forEach>
		                </h:panelGroup>
		                <div class="checkLinks">
	                    	<p:commandLink
	                    		value="Check all"
	                    		action="#{activityResultsBeanManager.checkAllFilters()}"
	                    		update=":panelResults :formFilters:panelFilters">
	                    	</p:commandLink>
	                        <span>|</span>
	                        <p:commandLink
	                    		value="Clear all"
	                    		action="#{activityResultsBeanManager.uncheckAllFilters()}"
	                    		update=":panelResults :formFilters:panelFilters">
	                    	</p:commandLink>
	                    </div>      
	                </h:form>
                </div>
            </div>
        </div>

    </div>
    
    <h:form id="formPrivateConversation">
    	<div class="modal fade assessmentCommentsModal" id="assessmentCommentsModal1" tabindex="-1" role="dialog" aria-labelledby="assessmentCommentsModal">
          <div class="modal-dialog modal-lg">
              <h:panelGroup id="panelModalPrivateConversation" layout="block" styleClass="modal-content">
              	<ui:fragment rendered="#{not empty activityResultsBeanManager.currentResult}">
                  <div class="modal-header alignLeft">
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      	<span aria-hidden="true">&#215;</span>
                      </button>
                      <h2 class="modal-title">Comments</h2>
                  </div>
                  <div class="discussion">
                      <div class="comments">
                          <ui:fragment rendered="#{not empty activityResultsBeanManager.currentResult.assessment.activityDiscussionMessageData}">
								<ul class="media-list">
									<ui:repeat var="activityMessageData" value="#{activityResultsBeanManager.currentResult.assessment.activityDiscussionMessageData}">
										<li class="media">
											<div class="media-left">
												<utilcomp:userAvatar
													avatar="#{activityMessageData.senderAvatarUrl}"
													fullName="#{activityMessageData.senderFullName}" />
											</div>
											
											<div class="media-body">
												<ui:fragment rendered="#{activityResultsBeanManager.isCurrentUserMessageSender(activityMessageData)}">
													<div class="commentMain">
														<span class="commentTime">
															Edited: #{activityMessageData.dateUpdatedFormat}
														</span>
														
														<h3 class="media-heading">
															#{activityMessageData.senderFullName}
															<ui:fragment rendered="#{activityMessageData.senderInsructor}">
																<span>INSTRUCTOR</span>
															</ui:fragment>
														</h3>
														
														<p class="commentText">#{activityMessageData.content}</p>
														
														<div class="editComment hidden">
															<p:inputTextarea name="name"
																styleClass="contentEditableComment"
																style="width:100%;" rows="1"
																value="#{activityMessageData.content}"></p:inputTextarea>
															<p:commandLink styleClass="btn btn-sm btn-green"
																oncomplete="hideEditPrivateConversationComment(this);"
																update=":formPrivateConversation:panelModalPrivateConversation"
																actionListener="#{activityResultsBeanManager.editComment(activityMessageData.content, activityMessageData.encodedMessageId)}"
																type="button"
																name="button">
																Submit
															</p:commandLink>
															
															<a href="javascript:void(0)"
																class="btn btn-sm btn-green-stroke"
																onclick="hideEditPrivateConversationComment(this)">Cancel</a>
														</div>
														
														<div class="commentOptions">
															<a href="javascript:void(0)" class="edit"
																onclick="showEditComment(this)">
																<span class="icon"></span>Edit
															</a>
														</div>
													</div>
												</ui:fragment>
												
												<ui:fragment rendered="#{not activityResultsBeanManager.isCurrentUserMessageSender(activityMessageData)}">
													<div class="commentMain">
														<span class="commentTime">
															Edited: #{activityMessageData.dateCreatedFormat}
														</span>
														<h3 class="media-heading">
															#{activityMessageData.senderFullName}
															<ui:fragment rendered="#{activityMessageData.senderInsructor}">
																<span>INSTRUCTOR</span>
															</ui:fragment>
														</h3>
														<p>#{activityMessageData.content}</p>
													</div>
													
													<div class="media replyInput hidden">
														<div class="media-left">
															<utilcomp:userAvatar
																avatar="#{activityMessageData.senderAvatarUrl}"
																fullName="#{activityMessageData.senderFullName}" />
														</div>
														
														<div class="media-body replyComment">
															<div class="commentForm">
																<textarea placeholder="Add Comment..." onkeyup="displaySubmitButtonPrivateConvModal(this)"></textarea>
																<button type="button"
																	class="btn btn-sm btn-green hidden"
																	name="button">
																	Submit
																</button>
															</div>
														</div>
													</div>
												</ui:fragment>
											</div>
										</li>
									</ui:repeat>
								</ul>
							</ui:fragment>
                      </div>
                      <div class="addComment">
							<utilcomp:userAvatar
								avatar="#{loggeduser.avatar}"
								fullName="#{loggeduser.fullName}" />
								
							<div class="commentForm">
								<p:inputTextarea styleClass="contentEditableComment"
									style="width:100%;" rows="1"
									value="#{activityResultsBeanManager.newCommentValue}"
									placeholder="Add Comment..."
									onkeyup="displaySubmitButtonPrivateConvModal(this)" />
								
								<p:commandLink
									action="#{activityResultsBeanManager.addCommentToActivityDiscussion()}"
									type="button" styleClass="btn btn-sm btn-green hidden"
									name="button"
									update=":formPrivateConversation:panelModalPrivateConversation @(.privateConvMsgsNoLink_#{activityResultsBeanManager.currentResult.targetActivityId})">
									Submit
									<f:param name="page" value="#{facesContext.viewRoot.viewId}"/>
									<f:param name="learningContext" value="#{learningContext}"/>
									<f:param name="service" value="name:result_private_conversation_dialog|id:#{activityResultsBeanManager.currentResult.targetActivityId}"/>
								</p:commandLink>
								
							</div>
						</div>
                      <div class="clear"></div>
                  </div>
                </ui:fragment>
              </h:panelGroup>
          </div>
      </div>
    </h:form>
    
    <h:form id="formCommentOnOtherResult">
	    <div class="modal fade assessmentCommentsModal"
			id="assessmentCommentsModal1b" tabindex="-1" role="dialog"
			aria-labelledby="assessmentCommentsModal">
			
			<div class="modal-dialog modal-lg">
				<h:panelGroup id="panelModalAssessmentComments" layout="block" class="modal-content">
					<div class="modal-header alignLeft">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">×</span>
						</button>
						<h2 class="modal-title">Response by #{activityResultsBeanManager.currentResult.user.fullName}</h2>
					</div>
					
					<ui:fragment rendered="#{activityResultsBeanManager.activityResultType eq 'FILE_UPLOAD'}">
						<div class="activityResultFile">
							<div class="activityResultHead">
								<div class="user32">
									<utilcomp:userAvatar
										avatar="#{activityResultsBeanManager.currentResult.user.avatarUrl}"
										fullName="#{activityResultsBeanManager.currentResult.user.fullName}" />
									<h3>
										<h:link outcome="/profile">
				                     		#{activityResultsBeanManager.currentResult.user.fullName}
				                     		<f:param name="id" value="#{util:encodeId(activityResultsBeanManager.currentResult.user.id)}" />
										</h:link>
									</h3>
								</div>
								<div class="timestamp">#{activityResultsBeanManager.currentResult.prettyResultPostDate}</div>
							</div>
							<div class="resultWrapper">
								<div class="actBoxLeft noUrl">
									<h3>#{activityResultsBeanManager.currentResult.assignmentTitle}</h3>
								</div>
								<a href="#{activityResultsBeanManager.currentResult.result}" class="btn btn-green btn-sm">Download</a>
							</div>
							<div class="discussion">
								<div class="comments">
									<ul class="media-list">
										<ui:repeat var="comment" value="#{activityResultsBeanManager.currentResult.resultComments.comments}">
											<li class="media">
												<post:comment1 id="comment"
													comments="#{activityResultsBeanManager.currentResult.resultComments}"
													comment="#{comment}" isTopLevel="true"
													newestCommentId="newestCommentId#{activityResultsBeanManager.currentResult.targetActivityId}"
													toUpdate="@(.panelNewestComment_#{activityResultsBeanManager.currentResult.targetActivityId}) growlMain"
													learningContext="#{learningContext}" />
											</li>
										</ui:repeat>
									</ul>
								</div>
								
								<div class="addComment">
									<utilcomp:userAvatar
										avatar="#{loggeduser.avatar}"
										fullName="#{loggeduser.fullName}" />
			
									<div class="commentForm">
										<h:inputTextarea class="hidden"
											value="#{activityResultsBeanManager.currentResult.resultComments.topLevelComment}" />
										
										<div class="contentEditableComment" placeholder="Add Comment..." 
											strip-br="true" contenteditable="true"
											onkeyup="displaySubmitButton(this);"></div>
			
										<p:commandButton styleClass="btn btn-sm btn-green hidden"
											value="Submit"
											action="#{commentBean.saveTopLevelComment(activityResultsBeanManager.currentResult.resultComments)}"
											update="panelModalAssessmentComments :growlMain">
											<f:param name="page" value="#{facesContext.viewRoot.viewId}" />
											<f:param name="learningContext"
												value="#{util:addSubContext(learningContext, 'name:comment')}" />
										</p:commandButton>
									</div>
									
									<script>
										$('#' + escapeColons('formCommentOnOtherResult:panelModalAssessmentComments') + ' .addComment .contentEditableComment').on('keyup', function(e) {
											$(this).prev('textarea').val($(this).html());
										});
									</script>
								</div>
								<div class="clear"></div>
							</div>
						</div>
					</ui:fragment>
					
					<ui:fragment rendered="#{activityResultsBeanManager.activityResultType eq 'TEXT'}">
						<div class="activityResultText">
							<div class="activityResultHead">
								<div class="user32">
									<utilcomp:userAvatar
										avatar="#{activityResultsBeanManager.currentResult.user.avatarUrl}"
										fullName="#{activityResultsBeanManager.currentResult.user.fullName}" />
									<h3>
										<h:link outcome="/profile">
				                     		#{activityResultsBeanManager.currentResult.user.fullName}
				                     		<f:param name="id" value="#{util:encodeId(activityResultsBeanManager.currentResult.user.id)}" />
										</h:link>
									</h3>
								</div>
								<div class="timestamp">
									#{activityResultsBeanManager.currentResult.prettyResultPostDate}
								</div>
							</div>
							
							<div class="activityResultTextContent">
								<p class="commentText">
									<h:outputText escape="false" value="#{activityResultsBeanManager.currentResult.result}" />
								</p>
							</div>
							
							<div class="discussion">
								<div class="comments">
									<ul class="media-list">
										<ui:repeat var="comment" value="#{activityResultsBeanManager.currentResult.resultComments.comments}">
											<li class="media">
												<post:comment1 id="comment"
													comments="#{activityResultsBeanManager.currentResult.resultComments}"
													comment="#{comment}" isTopLevel="true"
													newestCommentId="newestCommentId#{activityResultsBeanManager.currentResult.targetActivityId}"
													toUpdate="@(.panelNewestComment_#{activityResultsBeanManager.currentResult.targetActivityId}) growlMain"
													learningContext="#{learningContext}" />
											</li>
										</ui:repeat>
									</ul>
								</div>
								
								<div class="addComment">
									<utilcomp:userAvatar
										avatar="#{loggeduser.avatar}"
										fullName="#{loggeduser.fullName}" />
			
									<div class="commentForm">
										<h:inputTextarea class="hidden"
											value="#{activityResultsBeanManager.currentResult.resultComments.topLevelComment}" />
										
										<div class="contentEditableComment" placeholder="Add Comment..." 
											strip-br="true" contenteditable="true"
											onkeyup="displaySubmitButton(this);"></div>
			
										<p:commandButton styleClass="btn btn-sm btn-green hidden"
											value="Submit"
											action="#{commentBean.saveTopLevelComment(activityResultsBeanManager.currentResult.resultComments)}"
											update="panelModalAssessmentComments :growlMain">
											<f:param name="page" value="#{facesContext.viewRoot.viewId}" />
											<f:param name="learningContext"
												value="#{util:addSubContext(learningContext, 'name:comment')}" />
										</p:commandButton>
									</div>
									
									<script>
										$('#' + escapeColons('formCommentOnOtherResult:panelModalAssessmentComments') + ' .addComment .contentEditableComment').on('keyup', function(e) {
											$(this).prev('textarea').val($(this).html());
										});
									</script>
								</div>
								<div class="clear"></div>
							</div>
						</div>
					</ui:fragment>
					
				</h:panelGroup>
			</div>
		</div>
    </h:form>
    
    <activities:activityGradeModal
    	id="activityGradeModal"
   	 	bean="#{activityResultsBeanManager}"
		assessment="#{not empty activityResultsBeanManager.currentResult ? activityResultsBeanManager.currentResult.assessment : null}"
		toUpdate=":growlMain @(.gradeLink_#{activityResultsBeanManager.currentResult.targetActivityId})"
		minGrade="#{activityResultsBeanManager.activity.gradeOptions.minGrade}"
		maxGrade="#{activityResultsBeanManager.activity.gradeOptions.maxGrade}"
		learningContext="#{learningContext}"
	/>
	
	<ui:fragment rendered="#{not empty param['user']}">
		<script>
			scrollTo('activityResultBox_' + #{util:decodeId(param['user'])});
		</script>
	</ui:fragment>
</ui:define>
</ui:composition>