<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:comp="http://java.sun.com/jsf/composite/components"
	template="templates/masterLayout1.xhtml"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:dlg="http://java.sun.com/jsf/composite/components/dialogs"
	xmlns:actions="http://java.sun.com/jsf/composite/components/actions"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:util="http://www.prosolo.com/util"
	xmlns:dlgComp="http://java.sun.com/jsf/composite/components/dialogs/manager"
	xmlns:mngComp="http://java.sun.com/jsf/composite/components/manage">

	<ui:define name="windowTitle">
		Competences
	</ui:define>

	<ui:define name="metadata">
		<f:metadata>
			<f:viewParam name="courseId" value="#{courseCompetencesBean.id}"
				default="null" />
			<f:viewParam value="#{courseCompetencesBean.courseTitle}"
				name="courseName" default="null" />
			<f:viewAction action="#{courseCompetencesBean.init()}" />
		</f:metadata>
	</ui:define>

	<ui:define name="content">
		<script>
			function searchListener(execFunction) {
				var $this = this;
				//this.updateUrlQuery(); 

				var delayedSearch = function() {
					execFunction();
				};

				window.clearTimeout(this.keystrokeTimeout);
				this.keystrokeTimeout = window.setTimeout(delayedSearch, 250);
			};

			function searchCompsIfNeeded() {
				if ($('.acField').val().length != 0) {
					searchListener(execSearchComps);
				}
			}
		</script>
		<mngComp:credentialsHeader id="credentialsHeader"
			courseNameField="#{courseCompetencesBean.courseTitle}"
			courseEncodedIdField="#{param['courseId']}" activeLink="Competences" />
		<section>
			<div class="subHeader">
				<h3 class="title">Competences</h3>
				<a class="btn btn-default panelButton pull-right"
					href="credential-instructors.html" role="button"><i
					class="fa fa-ban red"></i> Cancel
				</a>
				<p:commandLink styleClass="btn btn-primary panelButton pull-right"
					pt:role="button"
					action="#{courseCompetencesBean.saveCourseCompetences()}"
					update=":formMain" oncomplete="initializePageJS();">
					<i class="fa fa-save"></i> Save
				</p:commandLink>
			</div>
		</section>
		
		<section class="container-fluid mainArea fullWidth">
			<h:form id="formMain">
				<p:growl id="growlMain" showDetail="true"></p:growl>
				<div class="row fullWidthPanel">
					<div class="col-md-10 indexColumn">
						<div class="tab-content centerTabs">
							<div class="addInstance form-inline">
								<p:commandLink
									pt:role="button"
									pt:aria-haspopup="true"
									pt:aria-expanded="false"
									styleClass="btn btn-primary"
									action="#{searchCompetencesBean.createNewCompetenceAndNavigate()}">
									
									<i class="fa fa-plus"></i>
									Create new competence
								</p:commandLink>
										
								<span>or search existing</span>
								<div class="form-group acContainerInline">
									<p:remoteCommand name="execSearchComps" process="inputCompName"
										update=":formMain:panelCompSearchResults"
										action="#{courseCompetencesBean.searchCompetences()}" />
									<h:inputText id="inputCompName"
										styleClass="form-control acField competenceField"
										value="#{courseCompetencesBean.compSearchTerm}"
										placeholder="Start typing..." onclick="$(this).select();"
										onkeyup="showSearchResults();searchCompsIfNeeded();">
									</h:inputText>
									<div class="acPanel userList dropdown-menu">
										<h:panelGroup id="panelCompSearchResults">
											<table width="100%" cellspacing="0" cellpadding="0"
												border="0">
												<tbody>
													<ui:repeat var="comp"
														value="#{courseCompetencesBean.compSearchResults}">
														<p:commandLink styleClass="hiddenCompLink"
															style="display: none;" pt:data-id="#{comp.competenceId}"
															action="#{courseCompetencesBean.addComp(comp)}"
															update=":formMain:panelCompList :formMain:panelCompSearchResults"
															oncomplete="$('.acField').val(''); $('.acPanel').first().stop(true, true).slideUp(10);">
														</p:commandLink>
														<tr
															onclick="$('.hiddenCompLink[data-id=&#34;#{comp.competenceId}&#34;]').trigger('click')">
															<td class="itemIco"><img class="ico40"
																title="Competence" alt="Competence"
																src="#{request.contextPath}/resources/images/ico-competences.svg"></img>
															</td>
															<td class="itemTitle">#{comp.title}</td>
														</tr>
													</ui:repeat>
												</tbody>
											</table>

										</h:panelGroup>
									</div>
								</div>
								<a href="#" class="small">Show all</a>
							</div>

							<h:panelGroup layout="block" id="panelCompList"
								styleClass="compList">

								<ui:repeat var="comp"
									value="#{courseCompetencesBean.competences}" varStatus="status">
									<div
										class="compItem #{courseCompetencesBean.mandatory ? 'connected' : ''}">
										<h:panelGroup layout="block" styleClass="itemNo"
											rendered="#{courseCompetencesBean.mandatory}">
			               		#{status.index + 1}
			               	</h:panelGroup>
										<div class="iHeading">
											<div class="sort pull-left">

												<p:commandLink
													rendered="#{status.index != courseCompetencesBean.currentNumberOfComps - 1}"
													action="#{courseCompetencesBean.moveDown(status.index)}"
													update=":formMain:panelCompList">
													<i class="fa fa-caret-down"></i>
												</p:commandLink>

												<p:commandLink rendered="#{status.index != 0}"
													action="#{courseCompetencesBean.moveUp(status.index)}"
													update=":formMain:panelCompList">
													<i class="fa fa-caret-up"></i>
												</p:commandLink>
											</div>
											<p:commandLink pt:type="button" styleClass="close"
												pt:data-dismiss="modal" pt:aria-label="Close"
												action="#{courseCompetencesBean.removeComp(status.index)}"
												update=":formMain:panelCompList">
												<span aria-hidden="true">Ã—</span>
											</p:commandLink>
											<div class="clearfix"></div>
										</div>
										<div class="iBody">
											<img
												src="#{request.contextPath}/resources/images/ico-competences.svg"
												alt="Competence" title="Competence" class="ico40"></img>
											<h2>#{comp.title}</h2>
											<h:link styleClass="edit" value="Edit"
												outcome="/manage/competence-overall">
												<f:param name="compId"
													value="#{util:encodeId(comp.competenceId)}" />
												<f:param name="origin"
													value="/manage/credential-competences.xhtml?courseId=#{param['courseId']}" />
												<f:param name="credId" value="#{param['courseId']}" />
											</h:link>
										</div>
									</div>
								</ui:repeat>
							</h:panelGroup>
						</div>
					</div>
					<div class="col-md-2">
						<div class="observationPanel cloneHeight">
							<div class="form-group">
								<label>Credential structure <a href="#"
									data-toggle="tooltip" title="Credential structure"><i
										class="fa fa-question-circle"></i> </a></label>
								<h:selectOneMenu styleClass="form-control selectpicker"
									value="#{courseCompetencesBean.credentialStructure}">
									<f:selectItems
										value="#{courseCompetencesBean.credentialStructureArray}"
										var="status" itemValue="#{status}" itemLabel="#{status.label}" />
									<f:ajax render=":formMain:panelCompList" />
								</h:selectOneMenu>
							</div>
						</div>
					</div>
				</div>
			</h:form>
		</section>

		<!-- Modal -->
		<div class="modal fade" id="modalFull">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&#215;</span>
						</button>
						<h4 class="modal-title">Remove Instructor</h4>
					</div>
					<div class="modal-body">
						<div class="row">
							<div class="col-md-1">
								<i class="fa fa-warning"></i>
							</div>
							<div class="col-md-11">
								<p>This instructor has students assigned. If you remove
									him/her, students will be marked as unassigned. You will then
									need to manually assign new instructor to them.</p>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary">Confirm
							removal</button>
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
					</div>
				</div>
			</div>
		</div>


		<!-- Modal 2 -->
		<div class="modal fade" id="modalOk">
			<div class="modal-dialog modal-sm">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&#215;</span>
						</button>
						<h4 class="modal-title">Remove Instructor</h4>
					</div>
					<div class="modal-body">
						<p>Are you sure?</p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary">Confirm
							removal</button>
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
					</div>
				</div>
			</div>
		</div>

		<script src="#{request.contextPath}/manage/js/credentialsOverall.js"></script>
	</ui:define>
</ui:composition>
