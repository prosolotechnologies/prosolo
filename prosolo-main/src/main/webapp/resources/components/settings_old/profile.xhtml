<ui:composition
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util">
	
	<h:outputStylesheet library="css" name="icropper.css" target="head" />
	<h:outputScript library="javascript" name="icropper/icropper-min.js" target="head" />
	<h:outputScript library="javascript" name="settings.profile.location.js" target="head" />
	<utilcomp:messagesBundle var="msg" />
	
	<div id="profile" class="profile">
		<h2>Settings: Profile</h2>
		<div class="separator clear"></div>
		
		<h:form id="avatarForm" class="hidden" >
		</h:form>
		
		<h:form id="profileForm">
			<p:growl id="profileFormGrowl" showDetail="true" enctype="multipart/form-data" />
			
			<div class="infoBlock">
				<h3>Profile Photo</h3>
				
				<h:panelGroup layout="block" id="avatar" class="avatar">
					<h:panelGroup layout="block" id="displayAvatar" class="row info #{profileSettings.newAvatar != null ? 'hidden' : ''}">
						<div class="first bold">Your photo:</div>
						
						<div class="second">
							<h:graphicImage styleClass="imageRound image120 left"
								value="#{profileSettings.accountData.avatarPath}" 
								height="120" alt="" />
								
							<p:fileUpload styleClass="uploadAvatar upload green size25"
								fileUploadListener="#{profileSettings.handleFileUpload}"  
					            mode="advanced"  
					            auto="true"
					            update=":profileForm:editAvatar :profileForm:displayAvatar"
					            oncomplete="$('.profile .actions .refresh').trigger('click')"
					            label="Choose a file"
					            allowTypes="/(\.|\/)(gif|jpe?g|png)$/"
				            />
				            
				            <ui:remove>
							<span class="button size20 green browseFileTrigger left">Upload new</span>
							<script type="text/javascript">
								$('.profile .avatar .browseFileTrigger').on('click', function(){
									$('.profile .browseFileHidden').trigger('click');
								});
							</script>
				            </ui:remove>
						</div>
					</h:panelGroup>
					<h:panelGroup layout="block" id="editAvatar" class="row infoEdit #{profileSettings.newAvatar == null ? 'hidden' : ''}">
						<div class="first bold" style="vertical-align: top;">Your photo:</div>
						<div class="second">
			
							<div class="cropperContainer">
								<div id="croppedImage"></div>
								<div class="previewSmallContainer">
									<span class="center">Preview:</span>
									<div id="previewSmall"></div>
								</div>
							</div>
							
							<div class="clear"></div>
							<p:commandLink styleClass="button size25 green left" value="Crop and Save"
								onclick="$('.profile .avatar .hiddenCoordinates').val(ic.getInfo().t+'_'+ic.getInfo().l+'_'+ic.getInfo().w+'_'+ic.getInfo().h);"
								action="#{profileSettings.crop()}"
								process="hiddenCoordinates"
								update=":avatarContainer :profileForm:avatar :profileForm:profileFormGrowl" />
								
							<p:commandLink styleClass="button size25 gray left" 
								value="Cancel" 
								action="#{profileSettings.cancelCrop()}"
								update=":profileForm:avatar"
							/>
								
							<h:inputText id="hiddenCoordinates" class="hiddenCoordinates" style="display:none;" value="#{profileSettings.cropCoordinates}" />
							
							<script type="text/javascript">
								var ic = new ICropper('croppedImage',{
										minWidth: 100,
										minHeight: 100,
										keepSquare: true,
										image: '#{profileSettings.newAvatar}',
										preview: [
											'previewSmall'
										]
									});
							</script>
						</div>
					</h:panelGroup>
					<script>
						$('#profile .infoBlock .avatar').fadeIn();
						roundImages();
					</script>
				</h:panelGroup>
			</div>
		
			<div class="separator"></div>

			<h3>Personal Information</h3>
			<div class="infoBlock">
				<h:panelGroup layout="block" id="name" class="row infoEdit name">
					<div class="first bold">Name:</div>
					<div class="second">
						<h:inputText id="editName" class="editName"
							value="#{profileSettings.accountData.firstName}"
							placeholder="#{msg['settings.profile.name']}" />
					</div>
				</h:panelGroup>
				
				
				<h:panelGroup layout="block" id="lastName" class="lastName row infoEdit">
					<div class="first bold">Last name:</div>
					<div class="second">
						<h:inputText id="editLastName" class="editLastName"
							value="#{profileSettings.accountData.lastName}"
							placeholder="#{msg['settings.profile.lastname']}" />
					</div>
				</h:panelGroup>
			</div>

			<div class="separator"></div>
				
			<div class="infoBlock">
				<h3>Work Information</h3>
				<h:panelGroup layout="block" id="position" class="position row infoEdit">
					<div class="first bold">Position:</div>
					<div class="second">
						<h:inputText id="editPosition" class="editPosition"
							value="#{profileSettings.accountData.position}"
							placeholder="#{msg['settings.profile.position']}" />
					</div>
				</h:panelGroup>
			</div>
			
			<div class="separator"></div>
			
			<div class="infoBlock">
				<h3>Location Information</h3>
				<h:panelGroup layout="block" id="location" class="location row infoEdit">
					<div class="first bold">Your Location:</div>
					<div class="second">
						<h:inputText value="#{profileSettings.accountData.locationName}" class="searchLocationTextField" size="50" />
						<h:inputText value="#{profileSettings.accountData.latitude}" class="latitude" style="display: none;" />
						<h:inputText value="#{profileSettings.accountData.longitude}" class="longitude" style="display: none;"/>
						
						<div class="map-canvas"></div>
					</div>
					
					<script>
						$(function(){
							initializeMap('#{profileSettings.accountData.locationName}', '#{profileSettings.accountData.latitude}', '#{profileSettings.accountData.longitude}');
						})
					</script>
				</h:panelGroup>
			</div>
			
			<div class="clear"></div>
			
			<h:panelGroup layout="block" class="actions">
				<p:commandLink styleClass="button size25 green left" value="Save"
					action="#{profileSettings.saveChanges}"
					update=":userNameContainer :profileForm" />
			</h:panelGroup>
			
		</h:form>
		<script>
			function clickParentsNextSibling(elem, event){
				if (event.keyCode == 13){$(elem).parent().next('a').trigger('click');}
			}
		</script>
	</div>
</ui:composition>