<ui:composition
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:dlg="http://java.sun.com/jsf/composite/components/dialogs"
	xmlns:util="http://www.prosolo.com/util"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:action="http://java.sun.com/jsf/composite/components/actions"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:icon="http://java.sun.com/jsf/composite/components/resourceLinks/icons">
	
	<script>
		document.title = 'Search: Suggested Learning';
	</script>
	<div id="searchSuggestedLearning">
		<h2>Search: Suggested Learning</h2>

		<h:form id="searchSuggestedLearningForm" class="filteredSearch">
			<h:inputHidden value="#{searchSuggestedLearningBean.filterString}" id="hiddenFilter" />
		
			<p:commandLink styleClass="hidden refreshCommand" value="Refresh"
				action="#{searchSuggestedLearningBean.init()}"
				update=":searchSuggestedLearningForm:resultContainer :searchSuggestedLearningForm:filter" />
		
			<p:commandLink styleClass="hidden updateFilter"
				action="#{searchSuggestedLearningBean.updateBasedOnSelectedFilter()}"
				update=":searchSuggestedLearningForm:resultContainer :searchSuggestedLearningForm:filter" />
		
			<h:panelGroup layout="block" id="filter" class="filter">
				<ul class="aHolder">
					<li>
						<a class="suggestedLearningDrop button gray size16">#{searchSuggestedLearningBean.filterString}<span></span></a>
						<div class="dropdown hidden">
							<ul>
								<li class="#{searchSuggestedLearningBean.chosenFilter == 'ALL' ? 'selected' : ''}">
									<a class="cursorPointer" onclick="setFilter('all', true); $('#searchSuggestedLearning .updateFilter').trigger('click');">
										#{msg['search.suggestedLearning.filter.all']}
									</a>
								</li>
								<li class="#{searchSuggestedLearningBean.chosenFilter == 'COLLEAGUES' ? 'selected' : ''}">
									<a class="cursorPointer" onclick="setFilter('colleagues', true); $('#searchSuggestedLearning .updateFilter').trigger('click');">
										#{msg['search.suggestedLearning.filter.colleagues']}
									</a>
								</li>
								<li class="#{searchSuggestedLearningBean.chosenFilter == 'SYSTEM' ? 'selected' : ''}">
									<a class="cursorPointer" onclick="setFilter('system', true); $('#searchSuggestedLearning .updateFilter').trigger('click');">
										#{msg['search.suggestedLearning.filter.system']}
									</a>
								</li>
								<li class="#{searchSuggestedLearningBean.chosenFilter == 'COURSES' ? 'selected' : ''}">
									<a class="cursorPointer" onclick="setFilter('courses', true); $('#searchSuggestedLearning .updateFilter').trigger('click');">
										#{msg['search.suggestedLearning.filter.courses']}
									</a>
								</li>
							</ul>
						</div>
					</li>
				</ul>
				<script type="text/javascript">
					enableDropdown('#searchSuggestedLearning .suggestedLearningDrop');
				</script>
			</h:panelGroup>
			
			<div class="separator clear"></div>
			
			<h:panelGroup layout="block" id="resultContainer" class="resultContainer">
				<ui:repeat value="#{searchSuggestedLearningBean.filteredResources}" var="recommendedData"
					id="suggestedResourcesList" varStatus="iterator">
						
					<h:panelGroup layout="block" class="box" rendered="#{recommendedData.recommendationType=='USER'}">
						
						<div class="avatar">
							<h:panelGroup rendered="#{recommendedData.resourceType == 'LEARNINGGOAL'}">
								<icon:goal size="30" styleClass="icon" />
							</h:panelGroup>
							
							<h:panelGroup rendered="#{recommendedData.resourceType == 'COMPETENCE'}">
								<icon:competence size="30" styleClass="icon" />
							</h:panelGroup>							
						</div>
						
						<div class="textWrapper">
							<div class="user">
								<link:user value="suggestedResourceMaker" 
				    				user="#{recommendedData.maker}"
				    				divClass="name"
				    				mode="name"
				    				idPrefix="suggestedByUserResource#{iterator.index}"
				    				context="suggestedLearning.name" />
								recommended you learning goal 
								<h:panelGroup rendered="#{recommendedData.resourceType == 'LEARNINGGOAL'}">
									<p:commandLink
										onclick="$('#goalDetailsModalDialog').dialog('open');"
										action="#{goalDialog.initializeRecommendedGoalDialog(recommendedData.resourceId, recommendedData.makerId)}"
										actionListener="#{loggingBean.logServiceUse('GOAL_DIALOG', 'context', 'search.suggestedLearning.recommended', 'action', 'openLearningGoalDialog', 'targetGoalId', recommendedData.resourceId, 'recommenderId', recommendedData.makerId)}"
										update=":goalDetailsDialogForm"
										value="#{recommendedData.resourceTitle}"
										styleClass="title" />
								</h:panelGroup>
							</div>
						</div>
						
						<div class="date">#{util:prettyDate(recommendedData.dateCreated)}</div>
						<div class="clear"></div>
						
						<div class="links">
							<h:panelGroup rendered="#{recommendedData.resourceType == 'LEARNINGGOAL'}">
								<p:commandLink id="requestToJoinButton" value="Request to Join" 
									rendered="#{recommendedData.resourceAvailability == 'CAN_BE_REQUESTED_TO_JOIN'}"
									styleClass="button green size20 left" 
									onclick='$("#requestToJoinGoalModalDialog").dialog("open");'
									update=":requestToJoinGoalForm"
									action="#{requestToJoinGoalBean.requestToJoinGoalById(recommendedData.resourceId, 'suggestedLearning')}" />
								
								<p:commandLink id="freeToJoinButton" value="Join" 
									rendered="#{recommendedData.resourceAvailability == 'IS_FREE_TO_JOIN'}"
									styleClass="button green size20 left" 
									action="#{goalDialog.joinLearningGoalById(recommendedData.resource.id)}"
									update="@form" />
								
								<p:commandLink rendered="#{goalDialog.resourceAvailability == 'USER_HAS_THIS_GOAL'}"
									styleClass="button gray size20 left hasTooltip"
									title="#{msg['tooltip.actionDisabled.goalDialog.userHasGoal']}"
									value="Join" />
									
								<p:commandLink rendered="#{goalDialog.resourceAvailability == 'REQUEST_ALREADY_SENT'}"
									styleClass="button gray size20 left hasTooltip"
									title="#{msg['tooltip.actionDisabled.goalDialog.requestAlradySent']}"
									value="Request to Join" />
								
								<p:commandLink id="dismissButton" value="Dismiss"
									styleClass="button gray size20 left"
									action="#{suggestedLearningBean.dismissRecommendation(recommendedData)}"
									process="@this"
									update="@form"
								/>
								
								<utilcomp:tooltip target=".hasTooltip[title]" />
							</h:panelGroup>
						</div>
		            </h:panelGroup>
		            
					<h:panelGroup layout="block" class="box" rendered="#{recommendedData.recommendationType == 'SYSTEM'}">
						<div class="avatar">
							<h:panelGroup rendered="#{recommendedData.resourceType == 'LEARNINGGOAL'}">
								<icon:goal size="30" styleClass="icon" />
							</h:panelGroup>
							
							<h:panelGroup rendered="#{recommendedData.resourceType == 'COMPETENCE'}">
								<icon:competence size="30" styleClass="icon" />
							</h:panelGroup>							
						</div>
						
						<div class="textWrapper">
							<div class="user">
								ProSolo recommended you
								<h:panelGroup rendered="#{recommendedData.resourceType == 'LEARNINGGOAL'}">
									learning goal 
									<p:commandLink
										onclick="$('#goalDetailsModalDialog').dialog('open');"
										action="#{goalDialog.initializeRecommendedGoalDialog(recommendedData.resourceId)}"
										actionListener="#{loggingBean.logServiceUse('GOAL_DIALOG', 'context', 'search.suggestedLearning.system', 'action', 'openLearningGoalDialog', 'targetGoalId', recommendedData.resourceId)}"
										value="#{recommendedData.resourceTitle}"
										update=":goalDetailsDialogForm"
										styleClass="title" >
									</p:commandLink>
								</h:panelGroup>
								
								<h:panelGroup rendered="#{recommendedData.resourceType == 'COMPETENCE'}">
									competence
									<link:competence 
										resource="#{recommendedData.resource}"
										type="Competence"
										title="#{recommendedData.resourceTitle}"
										styleClass="title" 
										context="suggestedLearning"/>
								</h:panelGroup>
							</div>
						</div>
						
						<div class="date">#{util:prettyDate(recommendedData.dateCreated)}</div>
						<div class="clear"></div>
						
						<div class="links">
							<h:panelGroup rendered="#{recommendedData.resourceType == 'LEARNINGGOAL'}">
								<p:commandLink id="requestToJoinButton2" value="Request to Join" 
									rendered="#{recommendedData.resourceAvailability == 'CAN_BE_REQUESTED_TO_JOIN'}"
									styleClass="button green size20 left" 
									onclick='$("#requestToJoinGoalModalDialog").dialog("open");'
									update=":requestToJoinGoalForm"
									action="#{requestToJoinGoalBean.requestToJoinGoalById(recommendedData.resourceId, 'suggestedLearning')}"/>
									
								<p:commandLink id="freeToJoinButton2" value="Join" 
									rendered="#{recommendedData.resourceAvailability == 'IS_FREE_TO_JOIN'}"
									styleClass="button green size20 left" 
									onclick='$("#goalDetailsModalDialog").dialog("close");'
									action="#{goalDialog.joinLearningGoalById(recommendedData.resourceId)}"
									update="@form" />
									
								<p:commandLink rendered="#{goalDialog.resourceAvailability == 'USER_HAS_THIS_GOAL'}"
									styleClass="button gray size20 left hasTooltip"
									title="#{msg['tooltip.actionDisabled.goalDialog.userHasGoal']}"
									value="Join" />
									
								<p:commandLink rendered="#{goalDialog.resourceAvailability == 'REQUEST_ALREADY_SENT'}"
									styleClass="button gray size20 left hasTooltip"
									title="#{msg['tooltip.actionDisabled.goalDialog.requestAlradySent']}"
									value="Request to Join" />
									
								<p:commandLink id="dismissButton2" value="Dismiss"
									styleClass="button gray size20 left"
									action="#{suggestedLearningBean.dismissRecommendation(recommendedData)}"
									process="@this"
									update="@form"
								/>
								
								<utilcomp:tooltip target=".hasTooltip[title]" />
							</h:panelGroup>
							
							<h:panelGroup rendered="#{recommendedData.resourceType == 'COMPETENCE'}">
								<table>
									<tr>
										<td>
											<action:addToGoal 
												styleClass="button green size20 left"
												competence="#{recommendedData.resource}" />
										</td>	
										<td> 
									 		<p:commandLink id="dismissButton3" value="Dismiss"
												styleClass="button gray size20 right"
												action="#{suggestedLearningBean.dismissRecommendation(recommendedData)}"
												process="@this"
												update="@form"
									 		/>
										</td>	 	
									</tr>	 	 
								</table>
							</h:panelGroup>
							
			 			</div>
		            </h:panelGroup>
	
					<div class="separator clear"></div>
				</ui:repeat>
			</h:panelGroup>
			
			<utilcomp:lazyLoad 
				parentClass="search"
				updateOnComplete=":searchSuggestedLearningForm:resultContainer"
				loaderContainer=".resultContainer"
				initializeAction="#{searchSuggestedLearningBean.init()}"
			/>
		</h:form>
		
		<script type="text/javascript">
			$(function(){
				var filter = "#{param['filter']}";
				console.log('filter: ' + filter);
				if (filter.length > 0) {
					$(escapeColons('#searchSuggestedLearningForm:hiddenFilter')).val("#{param['filter']}");
					setFilter("#{param['filter']}");
				}
			});
		
			function setFilter(filter, updateQuery) {
				$(escapeColons('#searchSuggestedLearningForm:hiddenFilter')).val(filter);
				
				if (updateQuery) {
					setQueryParam('filter', $(escapeColons('#searchSuggestedLearningForm:hiddenFilter')).val());
				}
			}
		</script>
		
	</div>
</ui:composition>