<ui:composition
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:dlg="http://java.sun.com/jsf/composite/components/dialogs"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:icon="http://java.sun.com/jsf/composite/components/resourceLinks/icons">
	
	<h:outputScript library="javascript" name="prosolo.tags.js" target="head"/>
	<h:outputScript library="javascript" name="readmore.custom.js" target="head" />
	
	<script>
		document.title = 'Search: Goals';
	</script>
	
	<div id="searchGoals">
		<h2>Search: Goals</h2>
		
		<h:form id="goalSearchForm" class="filteredSearch">
			<div>
				<p:commandLink styleClass="button blue size25 right search" value="Search"
					onclick="addLoaderToSearchContainer(); updateUrlQuery();"
					actionListener="#{searchGoalsBean.searchAllLearningGoals()}"
					update=":goalSearchForm:resultContainer"/>
				
				<div class="inputContainer">
					<div class="mGlass"></div>
  						<input type="text" size="20" class="searchInput"
				  		onclick="$(this).select();" 
				  		onkeydown="searchListener();" />
				  	<h:inputHidden class="searchInputHidden"
				  		value="#{searchGoalsBean.query}" 
				  	/>
				</div>
			</div>

			<div class="separator clear"></div>
			
			<h:panelGroup layout="block" class="resultContainer" id="resultContainer" style="display: none;">
					
				<ui:repeat value="#{searchGoalsBean.goals}" var="goalData" id="goalList" varStatus="iterator">
					<div class="box">
						<div class="avatar">
							<icon:goal />
						</div>
						
						<div class="textWrapper">
							<span class="title">
								<link:goal
									goalId="#{goalData.id}"
									title="#{goalData.title}"
									context="search.goals.#{goalData.id}.title" />
							</span>
							<div class="clear"></div>
							<div class="message">#{goalData.description}</div>
							
							<div class="keywords">
								<h:panelGroup rendered="#{goalData.tagsString != ''}">
									<span class="label">Tags:&#160;</span> 
									<h:inputText class="tagsReadMode" value="#{goalData.tagsString}" />
								</h:panelGroup>
								
								<div class="clear"></div>
								
								<span class="creator">
									Creator:&#160;
									<link:user value="userDetailsImage" 
					    				userData="#{goalData.maker}"
					    				mode="imageName"
					    				imageSize="22"
					    				idPrefix="goalSearchCreator#{iterator.index}" 
					    				context="search.goals.#{goalData.id}.maker.imageName" />			
								</span>
							</div>
							
							<div class="links">
								<p:growl id="goalDetailsDialogGrowl" for="goalDetailsDialogGrowl" showDetail="true" />

								<p:commandLink value="Request to join"
									styleClass="button green size20 left" 
									rendered="#{goalData.canBeRequestedToJoin}"
									update=":requestToJoinGoalForm"
									onclick='$("#requestToJoinGoalModalDialog").dialog("open");'
									action="#{requestToJoinGoalBean.requestToJoinLearningGoal(goalData, 'search.goals')}" />
								
								<p:commandLink value="Join"
									styleClass="button green size20 left" 
									rendered="#{requestToJoinGoalBean.checkIfLearningGoalIsFreeToJoin(goalData)}"
									update=":goalSearchForm"
									action="#{goalDialog.joinLearningGoalById(goalData.id)}" />
							</div>
						</div>
						
						<h:panelGroup layout="block" rendered="#{goalData.prettyDeadline != ''}"
							class="date">
							due to: #{goalData.prettyDeadline}
						</h:panelGroup>
						<div class="clear"></div>
		            </div>
		            
					<div class="separator clear"></div>
				</ui:repeat>
				
				<p:commandLink id="loadMore" rendered="#{searchGoalsBean.moreToLoad}" styleClass="loadMore"
					actionListener="#{searchGoalsBean.loadMoreGoals}"
					update=":goalSearchForm">
					<h:outputText value="SHOW MORE" />
				</p:commandLink>
				
				<script type="text/javascript">
				$(function() {
					$('#searchGoals .tagsReadMode').tags({editMode: false});
					roundImages();
					
					$('form.filteredSearch .loadMore').on('click', function() {
						$(this).html('<img src="#{request.contextPath}/resources/images/style/ajax-loader-black.gif" id="loginloader" style="margin-top: 9px;"/>');
						return false;
					});
					
					var input = $('form.filteredSearch .inputContainer .searchInput');
					input[0].selectionStart = input[0].selectionEnd = input.val().length;
					
					$('.search .resultContainer').fadeIn();
					$('#searchGoals .box .message').readmore({maxHeight: 60 });
				});
				</script>
			</h:panelGroup>
		</h:form>
	</div>
</ui:composition>