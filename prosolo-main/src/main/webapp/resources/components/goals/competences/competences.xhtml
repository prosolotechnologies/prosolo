<ui:composition
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:goalscomps="http://java.sun.com/jsf/composite/components/goals"
	xmlns:comp="http://java.sun.com/jsf/composite/components"
	xmlns:post="http://java.sun.com/jsf/composite/components/post"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:dlg="http://java.sun.com/jsf/composite/components/dialogs"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:pt="http://java.sun.com/jsf/passthrough">
	
	<utilcomp:messagesBundle var="msg" />
	
	<div class="learnMenuContent competenceList" style="display: none;">
		
		<div class="middleColumn bottomSeparator50">
			<ui:remove>
			<h3>Competence List</h3>
			</ui:remove>
			
			<h:form id="competenceList">
				<ui:param name="contextRoot" value="learn.targetGoal.#{learninggoals.selectedGoalData.data.targetGoalId}.competences" />
			
				<!-- Predefined Competences -->
				<h:outputText rendered="#{not empty learninggoals.selectedGoalData.predefinedCompetences}">
					<h4>
						Predefined Competences 
						<utilcomp:infotooltip 
							position="PREDEFINED_COMPETENCES" 
							context="#{contextRoot}" />
					</h4>
				</h:outputText>
				<ul>
					<ui:repeat value="#{learninggoals.selectedGoalData.predefinedCompetences}" var="competenceData" varStatus="iterator">
						<li class="item #{iterator.index == 0 ? 'learnTripStep11a' : ''}" data-id="#{competenceData.data.id}">
							<h4 class="title">
								<p:commandLink
									rendered="#{!competenceData.completed and 
										competenceData.data.canNotBeMarkedAsCompleted == null}"
									styleClass="iconUnCheck left marginRight10 hasTooltip"
									disabled="#{learninggoals.completed}"
									action="#{competencesBean.completeCompetence(competenceData, true, contextRoot.concat('.').concat(competenceData.data.id))}"
									process="@this"
									update=":goalDetails :competenceList :newCompetenceButtonForm :compSearchForm :goalWall:goalWallForm:goalWall"
									pt:title="#{learninggoals.completed ? msg['learn.disabledAsGoalIsCompleted.tooltip'] : msg['generic.complete.tooltip']}"
								/>
								
								<h:panelGroup rendered="#{!competenceData.completed and 
										competenceData.data.canNotBeMarkedAsCompleted != null}">
									<span class="iconUnCheck left marginRight10 hasTooltip"
										title="#{tooltips.getActionDisabledText(competenceData.data.canNotBeMarkedAsCompleted)}"></span>
								</h:panelGroup>
								
								<p:commandLink
									rendered="#{competenceData.completed}"
									styleClass="iconCheck left marginRight10"
									disabled="#{learninggoals.completed}"
									action="#{competencesBean.completeCompetence(competenceData, false, contextRoot.concat('.').concat(competenceData.data.id))}"
									process="@this"
									update=":goalDetails @form"
									pt:title="#{learninggoals.completed ? msg['learn.disabledAsGoalIsCompleted.tooltip'] : msg['generic.uncomplete.tooltip']}"
								/>
								
								<p:commandLink value="#{competenceData.data.title}" 
									styleClass="titleText navItemCompActivities compDetailsBtn" 
									onclick="learnControl.selectCompetence(#{competenceData.data.id});"
								 	actionListener="#{activitiesRecommendation.setCompData(competenceData)}"
								 	action="#{learninggoals.selectCompetence(competenceData)}"
								 	update=":activities" 
								/>
							</h4>
							
							<div class="clear"></div>
							<div class="details">#{competenceData.activities.size()} activities</div>
						</li>
					</ui:repeat>
				</ul>
				
				<h4>
					<h:outputText rendered="#{not empty learninggoals.selectedGoalData.predefinedCompetences}" value="Added" /> Competences
					
					<h:outputText rendered="#{not empty learninggoals.selectedGoalData.predefinedCompetences}">
						<utilcomp:infotooltip 
							position="ADDED_COMPETENCES" 
							context="#{contextRoot}" />
					</h:outputText>
				</h4>
				<ul>
					<ui:repeat id="competenceRepeat" value="#{learninggoals.selectedGoalData.competences}" var="competenceData" varStatus="iterator">
						<li class="item #{iterator.index == 0 ? 'learnTripStep11a' : ''}" data-id="#{competenceData.data.id}">
							<h4 class="title">
								<p:commandLink
									rendered="#{!competenceData.completed and 
										competenceData.data.canNotBeMarkedAsCompleted == null}"
									styleClass="iconUnCheck left marginRight10 hasTooltip"
									disabled="#{learninggoals.completed}"
									action="#{competencesBean.completeCompetence(competenceData, true, contextRoot.concat('.').concat(competenceData.data.id))}"
									process="@this"
									update=":goalDetails :competenceList :newCompetenceButtonForm :compSearchForm :goalWall:goalWallForm:goalWall"
									pt:title="#{learninggoals.completed ? msg['learn.disabledAsGoalIsCompleted.tooltip'] : msg['generic.complete.tooltip']}"
								/>
								
								<h:panelGroup rendered="#{!competenceData.completed and 
										competenceData.data.canNotBeMarkedAsCompleted != null}">
									<span class="iconUnCheck left marginRight10 hasTooltip"
										title="#{tooltips.getActionDisabledText(competenceData.data.canNotBeMarkedAsCompleted)}"></span>
								</h:panelGroup>
								
								<p:commandLink
									rendered="#{competenceData.completed}"
									styleClass="iconCheck left marginRight10"
									disabled="#{learninggoals.completed}"
									action="#{competencesBean.completeCompetence(competenceData, false, contextRoot.concat('.').concat(competenceData.data.id))}"
									process="@this"
									update=":goalDetails @form"
									pt:title="#{learninggoals.completed ? msg['learn.disabledAsGoalIsCompleted.tooltip'] : msg['generic.uncomplete.tooltip']}"
								/>
								
								<p:commandLink value="#{competenceData.data.title}" 
									styleClass="titleText navItemCompActivities compDetailsBtn" 
									onclick="learnControl.selectCompetence(#{competenceData.data.id});"
								 	actionListener="#{activitiesRecommendation.setCompData(competenceData)}"
								 	action="#{learninggoals.selectCompetence(competenceData)}"
								 	update=":activities" 
								/>
							</h4>
							
							<p:commandLink rendered="#{competenceData.data.shouldNotBeDeleted == null}"
								styleClass="iconRemove right"
								onclick="$('#deleteCompFormModalDialog').dialog('open');sendServiceUse('DELETE_COMPETENCE_DIALOG', {context: '#{contextRoot}', 'targetCompId' : '#{competenceData.data.id}', 'targetGoalId' : '#{learninggoals.selectedGoalData.data.targetGoalId}'});"
								disabled="#{learninggoals.completed}"
								action="#{deleteCompetenceDialog.init(competenceData)}"
								pt:title="#{learninggoals.completed ? msg['learn.disabledAsGoalIsCompleted.tooltip'] : msg['generic.remove.tooltip']}"
								process="@this"
								update=":deleteCompForm" />
							
							<div class="clear"></div>
							<div class="details">#{competenceData.activities.size()} activities</div>
							
						</li>
					</ui:repeat>
				</ul>
				
				<h:panelGroup class="noContentMessage"
					rendered="#{empty learninggoals.selectedGoalData.competences}">
					No <h:outputText rendered="#{not empty learninggoals.selectedGoalData.predefinedCompetences}" value="added" /> competences
				</h:panelGroup>

				<utilcomp:tooltip target=".hasTooltip[title]" />
				
				<script>
					$(function(){
						//update competence links' href
						$('.competenceList li.item a.titleText').each(function() {
							$(this).attr('href', learnControl.currentPath + '/' + $(this).parents('.item').attr('data-id'));
						});
					});
				</script>
			</h:form>
		</div><!-- middleColumn end -->
		
		<div class="middleColumn marginLeft30">
			<div class="middleColumn bottomSeparator50">
				
				<h:form id="newCompetenceButtonForm">
					<c:if test="#{adminSettings.settings.userCanCreateCompetence}">
						<div class="smallColumn">
							<h3>Create competence</h3>
							
								<p:commandLink styleClass="button #{learninggoals.completed ? 'gray' : 'green'} size24 hasTooltip"
									rendered="#{!learninggoals.selectedGoalData.data.competencesCanNotBeCreated}"
									value="New Competence"
									disabled="#{learninggoals.completed}"
									onclick="$('#newCompFormModalDialog').dialog('open');sendServiceUse('NEW_COMPETENCE_DIALOG', {context: '#{contextRoot}', 'targetGoalId' : '#{learninggoals.selectedGoalData.data.targetGoalId}'});"
									action="#{competencesBean.resetFormData}"
									pt:title="#{learninggoals.completed ? msg['learn.disabledAsGoalIsCompleted.tooltip'] : ''}"
									process="@this"
									update=":newGoalComp:newCompForm"
									async="true"
								/>
								<utilcomp:tooltip target=".hasTooltip[title]" />
							
								<h:panelGroup rendered="#{learninggoals.selectedGoalData.data.competencesCanNotBeCreated}">
								<span class="button gray disabled size24 hasTooltip" 
									title="#{msg['goals.competences.button.newCompetence.disabledForTheCourse']}">New Competence</span>
							</h:panelGroup>
					</div>
				</c:if>
				</h:form>
				
				<div class="smallColumn #{adminSettings.settings.userCanCreateCompetence ? 'marginLeft30' : ''}">
					<ui:include src="/resources/components/goals/competences/competenceSearch.xhtml" />
				</div>
			</div>
			
			<div class="middleColumn bottomSeparator50">
				<ui:include src="/resources/components/goals/competences/competenceDiscovery.xhtml" />
			</div>
		</div>
		
		<div id="collabComps" class="comparisonOverlay" style="display: none;">
			<a class="closeIcon" onclick="$('.goalsPage .competenceList .comparisonOverlay').fadeOut();"></a>
			<h:form id="collabCompsForm" class="collabCompsForm">
				<h3>Competence List of #{competenceComparisonBean.user.name}</h3>
				
				<ul>
					<ui:repeat id="collabCompRepeat" value="#{competenceComparisonBean.competences}" var="comparedCompData" varStatus="iterator">
						<li class="item">
							<h4 class="title">
								<h:panelGroup rendered="#{!comparedCompData.completed}"
									styleClass="iconUnCheck left marginRight10"
								/>
								
								<h:panelGroup rendered="#{comparedCompData.completed}"
									styleClass="iconCheck left marginRight10"
								/>
								<div class="titleText">#{comparedCompData.data.title}</div>
							</h4>
							
							<p:commandLink value="Add"
								rendered="#{!comparedCompData.data.userHasCompetence}"
								styleClass="button blue size25 right"
								action="#{competencesBean.connectCompetenceById(comparedCompData.data.competenceId, contextRoot.concat('.compare'))}"		
								process="@this"
								update=":goalListForm:goalListFormGrowl :competenceList :newCompetenceButtonForm 
									:collabCompsForm :goalWallTitle :compRecommendationsForm"						
								async="true"
							/>
							
							<h:panelGroup rendered="#{comparedCompData.data.userHasCompetence}">
								<span class="button disabled gray size25 right hasTooltip" title="Your goal already have this competence">Add</span>
							</h:panelGroup>
							
							<div class="clear"></div>
							<div class="details">#{comparedCompData.activities.size()} activities</div>
						</li>
					</ui:repeat>
				</ul>
				
				<h:panelGroup class="noContentMessage"
					rendered="#{empty competenceComparisonBean.competences}">
					No competences
				</h:panelGroup>
				
				<utilcomp:tooltip target=".hasTooltip[title]" />
			</h:form>
		</div>
		
		<div class="clear"></div>
		
		<script>
			
		
			function selectCompetence() {
				window.history.pushState("object or string", "Title", "new-url");
			} 
			var view = "competences";
			
			$('.goalsPage .competenceList .compDetailsBtn').on('click', function(){
				//setQueryParam('comp', $(this).parent().parent().attr('data-id'));
				//setQueryParam('id', $('.leftNav li.goal.selected').attr('data-id'));
				
				
			});
		</script>
	</div>
</ui:composition>