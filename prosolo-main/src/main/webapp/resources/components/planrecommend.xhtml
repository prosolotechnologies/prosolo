<ui:component
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:composite="http://java.sun.com/jsf/composite"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:dlg="http://java.sun.com/jsf/composite/components/dialogs"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:action="http://java.sun.com/jsf/composite/components/actions"
	xmlns:pt="http://java.sun.com/jsf/passthrough">

	<!-- targetCompIdToPreselectWhenAdding: Used on the Learn page to know on which competence to preselect -->

	<composite:interface>
		<composite:attribute name="recommendedplans" required="true" />
		<composite:attribute name="inputCompetence" default="false" />
		<composite:attribute name="selectedCompetence"/>
		<composite:attribute name="activityNameLength" default="16" />
		<composite:attribute name="appendedActivitiesRegionId" />
		<composite:attribute name="parentid" type="java.lang.String" required="true" />
		<composite:attribute name="containerClass" required="true" />
		<composite:attribute name="refreshCommand" default="" />
		<composite:attribute name="regionToUpdateAfterConnect" default="" />
		<composite:attribute name="selectedtargetcompetence" default="" />
		<composite:attribute name="cantdisplaymessage" type="java.lang.String" required="true" />
		<composite:attribute name="connectWithoutDialog" default="false" />
		<composite:attribute name="context" />
		<composite:attribute name="targetCompIdToPreselectWhenAdding" /> 
		<composite:attribute name="disabledConnect" type="java.lang.Boolean" />
		<composite:attribute name="disabledConnectTooltip" type="java.lang.String" />
		<composite:attribute name="initializeRecommendedPlans" 
			method-signature="void initializeRecommendedPlans()"
			required="true"/>
	</composite:interface>
	
	<composite:implementation>
		<utilcomp:messagesBundle var="msg" />
		
		<h:panelGroup layout="block" class="recommendedPlans" style="display: none;" id="recommendedPlansPanel">
			<h:panelGroup layout="block" id="availablePlans" class="compPlans noPlans noContentMessage" rendered="#{empty cc.attrs.recommendedplans}">
				#{cc.attrs.cantdisplaymessage}
			</h:panelGroup>
			
			<h:panelGroup layout="block" id="#{cc.attrs.parentid}ActivitiesForm"
				class="#{cc.attrs.parentid}ActivitiesForm"
				rendered="#{! empty cc.attrs.recommendedplans}">
				
				<script>
					$(document).ready(function() {
						$('.#{cc.attrs.parentid}TabbedPlans').tabs();
						$(".#{cc.attrs.parentid}ActivitiesForm .actLink").shortenedText({showChar: #{cc.attrs.activityNameLength}, mode: 'static'});
					});
				</script>
				
				<h:panelGroup layout="block" id="recommendedPlans"
					class="sideBoxFrame compPlans recommendedPlans #{cc.attrs.parentid}TabbedPlans"
					forceId="true">
					
					<ul class="sideTabs">
						<ui:repeat value="#{cc.attrs.recommendedplans}" var="recommendedPlanNum">
							<li>
								<a for-tab="plan#{recommendedPlanNum.number}" class="tabLink">
									<h:outputText value="#{recommendedPlanNum.number}" />
								</a>
							</li>
						</ui:repeat>
					</ul>
					
					<p:growl id="planRecommendGrowl" showDetail="true" />
					
					<ui:repeat value="#{cc.attrs.recommendedplans}" var="recommendedPlan">
					 
						<div id="plan#{recommendedPlan.number}" tab-id="plan#{recommendedPlan.number}" class="sideContent tabContent">
							<h:panelGroup layout="block" id="planContent#{recommendedPlan.number}">    
								<ul>
									<ui:repeat value="#{recommendedPlan.activities}" var="recActivityData">
										<li>
											<span class="#{recActivityData.completedByUser ? 'iconCheck' : 'iconBlank'} hasTooltip" 
												title="Already completed"/>
												
											<link:activity 
												activity="#{recActivityData.activity}"
												styleClass="actLink" 
												title="#{recActivityData.title}"
												context="#{cc.attrs.context}"
												targetCompIdToPreselectWhenAdding="#{cc.attrs.targetCompIdToPreselectWhenAdding}"
												toUpdateAfterAddingToCompetence="#{cc.attrs.regionToUpdateAfterConnect}" />
												
											<p:commandLink
												styleClass="iconAna hasTooltip"
												title="Analytics"
												onclick='$("#activityStatisticsDialog").dialog("open");'
												action="#{activityAnalyticsBean.initialize(recActivityData.activity, cc.attrs.context)}"
												update=":actAnalytics:activityStatisticsDialogForm" />									
											
											<h:panelGroup rendered="#{loggeduser != null and loggeduser.loggedIn}">
												<action:addToCompetence
													activity="#{recActivityData.activity}"
													tooltip="Connect"
													resetStyle="true"
													styleClass="iconConnect"
													toRender="#{!cc.attrs.connectWithoutDialog}"
													disabled="#{cc.attrs.disabledConnect}"
													context="#{cc.attrs.context}"
													disabledTooltip="#{cc.attrs.disabledConnectTooltip}"
												/>
												<p:commandLink 
													rendered="#{cc.attrs.connectWithoutDialog and !recActivityData.containedInCurrentPlan}"
													value="connect" styleClass="iconConnect hasTooltip"
													disabled="#{cc.attrs.disabledConnect}"
													pt:title="#{cc.attrs.disabledConnect ? cc.attrs.disabledConnectTooltip : msg['generic.connect.tooltip']}"
													action="#{compwall.connectActivityById(recActivityData.activity.id, cc.attrs.context)}"
													oncomplete="$('#{cc.attrs.refreshCommand}').trigger('click');"
													update=":#{cc.clientId}:recommendedPlans #{cc.attrs.regionToUpdateAfterConnect}" />
											</h:panelGroup>
										</li>
									</ui:repeat>
								</ul>
		
								<h:panelGroup rendered="#{!cc.attrs.inputCompetence}">
									<c:if test="#{loggeduser != null and loggeduser.loggedIn}">
										<p:commandLink value="Connect all"
											id="connectAllButtonId"
											rendered="#{not recommendedPlan.allActivitiesInCurrentPlan}"
											styleClass="button size20 #{cc.attrs.disabledConnect ? 'gray' : 'blue'}"
											disabled="#{cc.attrs.disabledConnect}"
											pt:title="#{cc.attrs.disabledConnect ? cc.attrs.disabledConnectTooltip : ''}"
											action="#{compwall.connectAllActivities(recommendedPlan)}"
											oncomplete="$('#{cc.attrs.refreshCommand}').trigger('click'); "
											update=":#{cc.clientId}:planRecommendGrowl :#{cc.clientId}:recommendedPlans #{cc.attrs.regionToUpdateAfterConnect}"
										/>
									</c:if>
								<ui:remove>
									<p:commandLink value="Appended activities"
										rendered="#{recommendedplans.hasAppendedPlans(recommendedPlan, cc.attrs.selectedtargetcompetence) and cc.attrs.selectedtargetcompetence == null}"
										styleClass="button blue size20" 
										action="#{appendedActivitiesBean.initializeSelectedAvailablePlan(recommendedPlan)}"
										onclick="$('#appendedActivitiesModalDialog').dialog('open');"
										update=":#{cc.attrs.appendedActivitiesRegionId}:appendedActivitiesForm"	 
									/>
									
									<p:commandLink
										value="Appended activities"
										styleClass="button blue size20"
										rendered="#{recommendedplans.hasAppendedPlans(recommendedPlan, cc.attrs.selectedtargetcompetence) and cc.attrs.selectedtargetcompetence != null}"
										action="#{appendedActivitiesBean.initializeSelectedAvailablePlanAndTargetCompetence(recommendedPlan, cc.attrs.selectedtargetcompetence)}"
										onclick="$('#appendedActivitiesModalDialog').dialog('open');"
										update=":#{cc.attrs.appendedActivitiesRegionId}:appendedActivitiesForm"/>
								</ui:remove>
								</h:panelGroup>
							<ui:remove>
								<h:panelGroup rendered="#{cc.attrs.inputCompetence}">
							 				<p:commandLink id="appendedActivitiesButton"
										value="Appended activities"
										rendered="#{recommendedplans.hasAppendedPlansForCompetence(recommendedPlan.plan, cc.attrs.selectedCompetence)}"
										onclick="$('#appendedActivitiesModalDialog').dialog('open');"
										action="#{appendedActivitiesBean.initializeSelectedAvailablePlanAndCompetence(recommendedPlan, cc.attrs.selectedCompetence)}"
										update=":#{p:component('appendedActivitiesForm')}"
										styleClass="button blue size20" 
									/>
									
								</h:panelGroup>
								</ui:remove>
							</h:panelGroup>
						</div>
					</ui:repeat>
					
				</h:panelGroup>

				
				<utilcomp:tooltip target=".hasTooltip[title]" />
			</h:panelGroup>
		
			<script>
				$('.recommendedPlans').fadeIn();
			</script>
		</h:panelGroup>
		
		<ui:remove>
		<!-- removed this as it was causing view get parameter to be resubmitted -->
		<utilcomp:lazyLoad id="lazyLoadRecommendedPlans"
			parentClass="#{cc.attrs.containerClass}"
			updateOnComplete=":#{cc.clientId}:recommendedPlansPanel"
			loaderContainer=".recommendedPlans"
			initializeAction="#{cc.attrs.initializeRecommendedPlans}"
		/>
		</ui:remove>
		
	</composite:implementation>
</ui:component>