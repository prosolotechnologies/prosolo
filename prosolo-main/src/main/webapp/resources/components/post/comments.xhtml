<ui:component
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:composite="http://java.sun.com/jsf/composite"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:post="http://java.sun.com/jsf/composite/components/post"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util">

	<composite:interface>
		<composite:attribute name="comments" required="true" type="org.prosolo.web.useractions.data.CommentsData"/>
		<composite:attribute name="isCollapsible" default="false" type="java.lang.Boolean"/>
		<composite:attribute name="uniqueId" default=""/>
		<composite:attribute name="commentsContainerDivId" required="true"/>
		<composite:attribute name="showSortOptions" default="true" type="java.lang.Boolean"/>
		 <composite:attribute name="growlToUpdate" default=""/>
		<composite:attribute name="learningContext" default=""/>
		<composite:attribute name="service" default=""/>
	</composite:interface>
	
	<composite:implementation>
		<div id="#{cc.clientId}">
			<script>var firstLoad#{cc.attrs.uniqueId} = true;</script>
			<h:form id="formComments">
				
				<ui:param name="bean" value="#{commentBean}"></ui:param>
				
				<h:panelGroup id="panelNewestCommentId" styleClass="panelNewestComment_#{cc.attrs.uniqueId}">
					<input type="hidden" id="newestCommentId#{cc.attrs.uniqueId}" value="#{cc.attrs.comments.newestCommentId}" />
				</h:panelGroup>
				
				
				<div id="#{cc.attrs.commentsContainerDivId}" class="discussion #{cc.attrs.isCollapsible ? 'collapse' : ''}">
					<c:if test="#{cc.attrs.showSortOptions}">
						<h2>Discussion</h2>
	
						<div class="dropdown sortDrop">
							<a data-toggle="dropdown" aria-haspopup="true"
								aria-expanded="true"> #{cc.attrs.comments.sortOption.label} <span
								class="arrowDown">arrowDown</span>
							</a>
							
							<ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">
								
								<ui:repeat var="sortOption" value="#{bean.sortOptions}">
									<li>
										<p:commandLink value="#{sortOption.label}"
											process="@this" action="#{bean.sortChanged(sortOption, cc.attrs.comments)}"
											update=":#{cc.clientId}:formComments">
										</p:commandLink>
									</li>
								</ui:repeat>
							</ul>
						</div>
					</c:if>
					

					<div class="comments">
						<ul class="media-list">
								<li class="loadMoreComments">
									<p:commandLink
										value="View previous comments"
										update="formComments" />
								</li>
							
							<ui:repeat var="comment" value="#{cc.attrs.comments.comments}">
								<li class="media">
									<post:comment1 id="comment"
										comments="#{cc.attrs.comments}"
										comment="#{comment}" isTopLevel="true"
										newestCommentId="newestCommentId#{cc.attrs.uniqueId}"
										toUpdate="@(.panelNewestComment_#{cc.attrs.uniqueId}) #{cc.attrs.growlToUpdate}"
										learningContext="#{cc.attrs.learningContext}" />
								</li>
							</ui:repeat>
						</ul>
					</div>
					
					<div class="addComment">
						<utilcomp:userAvatar
							avatar="#{loggeduser.avatar}"
							fullName="#{loggeduser.fullName}" />

						<div class="commentForm">
							<h:inputTextarea class="hidden"
								value="#{cc.attrs.comments.topLevelComment}" />
							
							<div class="contentEditableComment" placeholder="Add Comment..." 
								strip-br="true" contenteditable="true"
								onkeyup="displaySubmitButton(this);"></div>

							<p:commandButton styleClass="btn btn-sm btn-green hidden"
								value="Submit" action="#{bean.saveTopLevelComment(cc.attrs.comments)}"
								update="formComments #{cc.attrs.growlToUpdate}"
								oncomplete="scrollToNewestComment('newestCommentId#{cc.attrs.uniqueId}');">
								<f:param name="page" value="#{facesContext.viewRoot.viewId}" />
								<f:param name="learningContext"
									value="#{util:addSubContext(cc.attrs.learningContext, 'name:comment')}" />
							</p:commandButton>
						</div>
						
						<script>
							$('#' + escapeColons('#{cc.clientId}') + ' .addComment .contentEditableComment').on('keyup', function(e) {
								$(this).prev('textarea').val($(this).html());
							});
						</script>
					</div>
                    <div class="clear"></div>
				</div>
				<script>
					if(#{cc.attrs.isCollapsible} &amp;&amp; !firstLoad#{cc.attrs.uniqueId}) {
						$('##{cc.attrs.commentsContainerDivId}').addClass("in");
					}
					firstLoad#{cc.attrs.uniqueId} = false;
				</script>
			</h:form>
		</div>
	</composite:implementation>
</ui:component>