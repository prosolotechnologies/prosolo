<ui:component
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"  
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:composite="http://java.sun.com/jsf/composite"
	xmlns:util="http://www.prosolo.com/util"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:pt="http://java.sun.com/jsf/passthrough">
      
	<!-- actionBean: this bean must have a method 'void connectCompetence(Competence)' -->

	<composite:interface>
		<composite:attribute name="renderGlassIcon" default="true" />
		<composite:attribute name="container" required="true" />
		<composite:attribute name="value" required="true" />
		<composite:attribute name="regionToRenderOnAction" />
		<composite:attribute name="actionLinkName" default="Connect" />
		<composite:attribute name="actionBean" required="true" />
		<composite:attribute name="loaderImage" default="#{request.contextPath}/resources/images/style/ajax-loader-white.gif"/>
		<composite:attribute name="excludeAddedCompetences" default="true" />
		<composite:attribute name="toExclude" type="java.util.Collection"/>
		<composite:attribute name="toExcludeIds" type="java.lang.String" />
		<composite:attribute name="toRender" type="java.lang.Boolean" default="true" />
		<composite:attribute name="oncomplete" />
		<composite:attribute name="disabled" type="java.lang.Boolean" />
		<composite:attribute name="disabledTooltip" type="java.lang.String" />
		<composite:attribute name="context" type="java.lang.String" />
	</composite:interface>
	
	<composite:implementation>
	
		<h:outputScript library="javascript" name="prosolo.search.js" target="head" />
		<h:outputScript library="javascript" name="jquery.shortenedText.js" target="head"/>
		
		<h:panelGroup layout="block" rendered="#{cc.attrs.toRender}" class="compSearch">
			<h:panelGroup layout="group" id="compSearchform">
			
				<p:remoteCommand name="#{cc.clientId.replace(':', 'i')}SendCompetencesAjaxical" 
					update="compSearchResultPanel" 
					action="#{searchCompetencesBean.executeSearch(cc.attrs.toExcludeIds != null ? cc.attrs.toExcludeIds : util:toIdArray(cc.attrs.toExclude), cc.attrs.context)}" />
				
				<script>
				var #{cc.attrs.value}Search;
				$(function() {
					$('#{cc.attrs.container} .compSearch').prosolosearch({
						resultContainer: '#{cc.attrs.container} .compSearch .#{cc.attrs.value}SearchContainer',
						loaderContainer: '#{cc.attrs.container} .compSearch .#{cc.attrs.value}SearchContainer .#{cc.attrs.value}SearchPanel',
						searchInput: '#{cc.attrs.container} .compSearch .searchInput',
						watermark: 'Search competences',
						loaderImage: '#{cc.attrs.loaderImage}',
						searchAction: #{cc.clientId.replace(':', 'i')}SendCompetencesAjaxical
					});
					#{cc.attrs.value}Search = $('#{cc.attrs.container} .compSearch').data('prosolo.search');
				});
				</script>
	 
				<h:panelGroup layout="group" class="mGlass" rendered="#{cc.attrs.renderGlassIcon}"/>
				
			  	<h:inputText id="compInputString" size="20" 
			  		class="searchInput hasTooltip"
			  		value="#{searchCompetencesBean.query}"
			  		disabled="#{cc.attrs.disabled}"
			  		pt:title="#{cc.attrs.disabled ? cc.attrs.disabledTooltip : ''}"
				/>
							
				<div id="suggestions#{cc.attrs.value}" class="genericSearchContainer #{cc.attrs.value}SearchContainer">
	 				<h:panelGroup layout="block" id="compSearchResultPanel" class="#{cc.attrs.value}SearchPanel">
						
						<script>
						$(function() {
							$('#{cc.attrs.container} .compSearch .category .seeAllLink').attr('href', $('#{cc.attrs.container} .compSearch .category .seeAllLink').attr('href')+$('#{cc.attrs.container} .compSearch .searchInput').val());
						});
						</script>
					
	 					<h:panelGroup layout="block" id="compSearchResultPanelContent" rendered="#{not empty searchCompetencesBean.competences}">
		 				 	<div class="category">
		 				 		Competences(#{searchCompetencesBean.compsSize})
		 				 		<span class="right">
									<h:link class="seeAllLink"
										onclick="sendLogPageNavigation('search/competences','#{cc.attrs.context}');" 
										outcome="/search"
										value="See all">
										<f:param name="tab" value="competences" />
										<f:param name="query" value="" />
									</h:link>
								</span>
							</div>
		 				 	
							<ui:repeat value="#{searchCompetencesBean.competences}" var="compData" varStatus="iterator">
								<div class="searchRecord">
									<div class="image">
										<span class="competenceIcon30"></span>
									</div>
	
									<div class="info">
										<div class="title">#{compData.title}</div>
	
										<h:panelGroup layout="block" rendered="#{!empty compData.competence.maker}">
											Created	by: 
												
											<link:user value="competenceCreator" 
							    				userData="#{compData.maker}"
							    				mode="name"
							    				idPrefix="#{iterator.index}"
							    				context="#{cc.attrs.context}.result.#{compData.id}.maker.name" />
										</h:panelGroup>
										
										<div class="membersCount">
											#{competencesSearchBean.getCompetenceUsersNumber(compData.competence)}
										</div>
										
										<div class="actions">
											<link:competence 
												title="Details"
												resource="#{compData.competence}"
												type="Competence"
												onclick="#{cc.attrs.value}Search.hideResults();"
												context="#{cc.attrs.context}"/>
										
											<span class="bullet"></span>
	
											<p:commandLink rendered="#{excludeAddedCompetences}"
												value="#{cc.attrs.actionLinkName}"
												onclick="#{cc.attrs.value}Search.resetSearch();"
												action="#{cc.attrs.actionBean.connectCompetence(compData.competence)}"
												update="#{cc.attrs.regionToRenderOnAction}"
												oncomplete="#{cc.attrs.oncomplete}">
												<f:param name="context" value="#{cc.attrs.context}" />
											</p:commandLink>
											<p:commandLink rendered="#{!excludeAddedCompetences}"
												value="#{cc.attrs.actionLinkName}"
												onclick="#{cc.attrs.value}Search.resetSearch();"
												action="#{cc.attrs.actionBean.connectCompetence(compData.competence)}"
												update="#{cc.attrs.regionToRenderOnAction}"
												oncomplete="#{cc.attrs.oncomplete}">
												<f:param name="context" value="#{cc.attrs.context}" />
											</p:commandLink>
										</div>
									</div>
								</div>
							</ui:repeat>
	 					</h:panelGroup>
	 					
						<h:panelGroup id="noCompetencesResultsPanel" class="noResultPanelWhite" 
							rendered="#{empty searchCompetencesBean.competences}">
							No results found
						</h:panelGroup>
						
						<br class="break" />
					</h:panelGroup>
		 		</div>
			</h:panelGroup>
		</h:panelGroup>
	</composite:implementation>
</ui:component>