<ui:composition
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:dlgAnalytics="http://java.sun.com/jsf/composite/components/dialogs/analytics"
	xmlns:icon="http://java.sun.com/jsf/composite/components/resourceLinks/icons"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:portfolio="http://java.sun.com/jsf/composite/components/portfolio">
	
	<utilcomp:messagesBundle var="msg" />
	
	<script>
		$(function() {
			lazyLoadCompletedGoals();
		});
	
		function beforeLazyLoadCompletedGoals() {
			$('#completedGoalsForm .goalsContainer').show();
			$('#completedGoalsForm .goalsContainer').html('<img class="loader" src="#{request.contextPath}/resources/images/style/ajax-loader-black.gif"/>');
		}
	</script>

	<h:form id="completedGoalsForm">
		<p:growl id="completedGoalsFormGrowl" showDetail="true" />
		
		<p:remoteCommand name="lazyLoadCompletedGoals" 
			onstart="beforeLazyLoadCompletedGoals()"
			actionListener="#{publicportfolio.initCompletedGoals()}" 
			update=":#{p:component('completedGoalsForm')}" 
			async="true" />

		<h:panelGroup layout="block" class="profileGoals">
			<h2><icon:goal styleClass="icon" />Learning</h2>
		
			<div class="clear"></div>
			
			<div class="goalsContainer" style="display: none;">
				<p class="pRight"><strong>Average time:</strong> #{publicportfolio.goalStats.averageTime}</p>
				<h3>Ongoing Learning</h3>
			
				<h:panelGroup rendered="#{empty publicportfolio.ongoingGoals}" styleClass="noContentMessage">
					There are no ongoing goals.
				</h:panelGroup>

				<ui:repeat value="#{publicportfolio.ongoingGoals}" var="ongoingGoalIterator" id="ongoingGoalsRepeat" varStatus="iterator">
					<portfolio:goalItem
						goalData="#{ongoingGoalIterator}"
						idSufix="ongoing#{iterator.index}"
						styleClass="#{iterator.index % 2 == 1 ? 'noMargin' : '' }"
						editable="false"
						canBeAskedForRequestToJoin="#{loggeduser.loggedIn}"
						userOwner="#{publicportfolio.profileOwnerData}"
						context="publicProfile.#{publicportfolio.profileOwnerData.id}.learning.ongoing" />
				</ui:repeat>

				<div class="clear marginBottom10"></div>
				
				<h3>Completed Learning</h3>
			
				<h:panelGroup rendered="#{empty publicportfolio.completedGoals}" styleClass="noContentMessage">
					There are no completed goals yet.
				</h:panelGroup>

				<ui:repeat value="#{publicportfolio.completedGoals}" var="goalIterator" id="completedGoalsRepeat" varStatus="iterator">
					<portfolio:goalItem
						goalData="#{goalIterator}"
						idSufix="completed#{iterator.index}"
						styleClass="#{iterator.index % 2 == 1 ? 'noMargin' : '' }"
						editable="false"
						context="publicProfile.#{publicportfolio.profileOwnerData.id}.learning.completed" />
				</ui:repeat>
			</div>
			
			<div class="clear"></div>
	
			<script>
				$(function() {

					$('.profileGoals .goalsMore').moreLessBox({
						lessClass : '',
						lessText : 'See less',
						moreClass : '',
						moreText : 'See all',
					});

					$('.profileGoals .showEvaluations, .portComp .showEvaluations').on('click', function() {
						var liParent = $(this).parents('li');
						var evaluations = liParent.find('.evaluations');
						evaluations.slideToggle();
					});
					
					$('.profileGoals .profileItem h4 .firstLine').shortenedText({showChar: 60, mode: 'static'});
				});

				$(window).bind("load", function() {
					if ($('.profileGoals .evaluations .evaluation.open').length > 0) {
						$('.profileGoals .evaluations .evaluation.open').parent('.profileGoals .evaluations').slideToggle(function() {
							$('.profileGoals .evaluations .evaluation.open').effect("highlight", {}, 3000);
						});
					}
				});
				$('#completedGoalsForm .goalsContainer').fadeIn();
			</script>
		</h:panelGroup>
		
		<utilcomp:tooltip target=".hasTooltip[title]" />
	</h:form>
	
	<dlgAnalytics:goal id="goalAnalytics" />
</ui:composition>