<ui:composition
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:dlg="http://java.sun.com/jsf/composite/components/dialogs"
	xmlns:dlgAnalytics="http://java.sun.com/jsf/composite/components/dialogs/analytics"
	xmlns:icon="http://java.sun.com/jsf/composite/components/resourceLinks/icons"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:portfolio="http://java.sun.com/jsf/composite/components/portfolio">

	<ui:param name="userId" value="#{publicportfolio.profileOwnerData.id}" />

	<utilcomp:messagesBundle var="msg" />

	<script>
		$(function() {
			lazyLoadAchievedCompetence();
		});
	
		function beforeLazyLoadAchievedCompetences() {
			$('#achievedCompForm .competencesContainer').show();
			$('#achievedCompForm .competencesContainer').html('<img class="loader" src="#{request.contextPath}/resources/images/style/ajax-loader-black.gif"/>');
		}
	</script>

	<h:form id="achievedCompForm">
		<p:growl id="achievedCompFormGrowl" showDetail="true" />
		
		<p:remoteCommand name="lazyLoadAchievedCompetence" 
			onstart="beforeLazyLoadAchievedCompetences();"
			action="#{publicportfolio.initAchievedCompetences()}" 
			update=":#{p:component('achievedCompForm')}"
			async="true" />
	
		<div class="profileComp">
			<h2><icon:competence styleClass="icon" />Competences</h2>
			<div class="clear"></div>
			
			<div class="competencesContainer" style="display: none;">
				<h3>Ongoing Competences</h3>
			
				<h:panelGroup rendered="#{empty publicportfolio.ongoingCompetences}" styleClass="noContentMessage">
					There are no ongoing competences.
				</h:panelGroup>
			
				<ui:repeat value="#{publicportfolio.ongoingCompetences}" var="compIterator" id="ongoingCompsRepeat" varStatus="iterator">
					<portfolio:competenceItem
						compData="#{compIterator}"
						idSufix="ongoingComp#{iterator.index}"
						styleClass="#{iterator.index % 2 == 1 ? 'noMargin' : '' }"
						editable="false"
						canBeBrushedUp="false"
						context="publicprofile.#{userId}.competences.ongoing" />
				</ui:repeat>
				
				<div class="clear marginBottom10"></div>
				
				<h3>Completed Competences</h3>
			
				<h:panelGroup rendered="#{empty publicportfolio.achievedComps}" styleClass="noContentMessage">
					There are no achieved competences.
				</h:panelGroup>
				
				<ui:repeat value="#{publicportfolio.achievedComps}" var="compIterator" id="achievedCompsRepeat" varStatus="iterator">
				
					<portfolio:competenceItem
						compData="#{compIterator}"
						idSufix="completedComp#{iterator.index}"
						styleClass="#{iterator.index % 2 == 1 ? 'noMargin' : '' }"
						editable="false"
						canBeBrushedUp="false"
						context="publicprofile.#{userId}.competences.achieved" />
					
					<ui:remove>
					<div class="profileItem profileItemBlue #{iterator.index % 2 == 1 ? 'noMargin' : '' }">
						<div class="topContent">
							<h4>
								<link:competence
									toRender="#{compIterator.targetCompetenceId > 0}"
									resourceId="#{compIterator.targetCompetenceId}"
									type="TargetCompetence"
									title="#{compIterator.title}"
								/>
								<link:competence
									toRender="#{compIterator.targetCompetenceId == 0}"
									resource="#{compIterator.competence.competence}"
									type="Competence"
									title="#{compIterator.title}"
								/>
							</h4>
							
							<p>Valid for <strong>1 year</strong></p>
							
							<p:commandLink
								rendered="#{compIterator.badgeCount > 0}"
								styleClass="link profLinkBadges"
								onclick="$('#badgeListDialog').dialog('open');"
								action="#{badgelist.initializeForCompletedResourceById(compIterator.id, cc.attrs.context)}"
								update=":badgeListForm"
								>
								<span class="icon active"></span>
								<span class="count">#{compIterator.badgeCount}</span> badges								
							</p:commandLink>
							<h:panelGroup layout="block"
								rendered="#{compIterator.badgeCount == 0}"
								styleClass="link profLinkBadges inactive"
								>
								<span class="icon"></span>
								<span class="count">0</span> badges								
							</h:panelGroup>
							
							<p:commandLink
								styleClass="link profLinkEvals"
								rendered="#{compIterator.evaluationCount > 0}"
								onclick="$('#evaluationListDialog').dialog('open');"
								action="#{evaluationlist.initialize(compIterator.competence, 'profile.'.concat(publicportfolio.profileOwnerData.id))}"
								update=":#{p:component('evaluationListForm')}"
								>
								<span class="icon active"></span>
								<span class="count">#{compIterator.evaluationCount}</span> #{msg['portfolio.evaluatedItem.evaluationsNumber']}
							</p:commandLink>
							<h:panelGroup layout="block"
								rendered="#{compIterator.evaluationCount == 0}"
								styleClass="link profLinkEvals inactive"
								>
								<span class="icon"></span>
								<span class="count">0</span> #{msg['portfolio.evaluatedItem.evaluationsNumber']}								
							</h:panelGroup>
							
							<p:commandLink
								styleClass="link profLinkStats"
								onclick='$("#competenceStatisticsDialog").dialog("open");'
								action="#{competenceAnalyticsBean.initializeById(compIterator.competence.competence.id, 'profile.'.concat(publicportfolio.profileOwnerData.id))}"
								update=":compAnalytics:competenceStatisticsDialogForm">
								
								<span class="icon"></span>
								Statistics
							</p:commandLink>
						</div>
					</div>
					</ui:remove>
				</ui:repeat>
				
				<script>
					$('#achievedCompForm .competencesContainer').fadeIn();
				</script>
			</div>
			
			<script>
				$(function(){
					enableDropdown('.profileComp .drop');
					
					$('.profileComp .compsMore').moreLessBox({
						lessClass:'',
						lessText:'See less',
						moreClass:'',
						moreText:'See all',
					});
					
					$('.profileComp .profileItem h4 .firstLine').shortenedText({showChar: 60, mode: 'static'});
				});

			</script>
		</div>
		
		<utilcomp:tooltip target=".hasTooltip[title]" />
	</h:form>
	
	<script>
		$('#achievedCompForm .competencesContainer').hide();
	</script>
	
	<dlgAnalytics:competence id="compAnalytics" />
</ui:composition>