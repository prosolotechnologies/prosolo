<ui:composition
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:comp="http://java.sun.com/jsf/composite/components"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:dlg="http://java.sun.com/jsf/composite/components/dialogs"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:action="http://java.sun.com/jsf/composite/components/actions"
	xmlns:pt="http://java.sun.com/jsf/passthrough">
	
	<h:outputScript library="javascript" name="prosolo.tags.js" target="head"/>
	<h:outputScript library="javascript" name="readmore.custom.js" target="head"/>
	<h:outputScript library="javascript" name="jquery.autosize.min.js" target="head" />
	<h:outputScript library="javascript" name="readmore.custom.js" target="head" />
	<h:outputScript library="javascript" name="jquery.shortenedText.js" target="head"/>
	
	<utilcomp:messagesBundle var="msg" />

	<div id="competenceDetailsFormModalDialog" title="Competence details" style="display: none;">
		<h:form id="competenceDetailsForm">
			<p:growl id="competenceDetailsFormDialogGrowl" showDetail="true" />
			
			<div class="compDetails">
			
				<div class="detailsRead">
					<c:if test="#{loggeduser != null and loggeduser.loggedIn}">
						<ui:remove>
							<h:link value="Edit"
								class="button blue size30 right marginTop5"
								rendered="#{loggeduser.manager}"
								outcome="/manage/competence">
								<f:param name="id" value="#{competenceDialog.formData.id}" />
							</h:link>
							<!-- 
							<p:commandLink rendered="#{!loggeduser.manager and competenceDialog.owner}"
							 -->
						</ui:remove>

						<p:commandLink rendered="#{competenceDialog.owner}"
							value="Edit"
							onclick="toggleEditMode('.detailsRead', '.detailsEdit')" 
							styleClass="button blue size30 right marginTop5"
							async="true" />
					</c:if>
				
					<table id="competenceDetailsTable">
						<tr>
							<td class="col1"><label for="compName">Name:</label></td>
							<td>
								<h:outputText id="compName"	value="#{competenceDialog.formData.title}" />
							</td>
						</tr>
						<tr>
							<td class="col1"><label for="compDescription">Description:</label></td>
							<td>
								<h:panelGroup layout="block"
									pt:context="compDetailsDialog.#{competenceDialog.targetCompetence != null ? 'targetComp.'.concat(competenceDialog.targetCompetence.id) : 'comp.'.concat(competenceDialog.competence.id)}.description" 
									styleClass="description" id="compDescription">
									#{competenceDialog.formData.description}
								</h:panelGroup>
							</td>
						</tr>
						<tr>
							<td class="col1"><label for="validityPeriod">Validity:</label></td>
							<td>
								<h:outputText id="validityPeriod" value="#{competenceDialog.formData.validity}" />&#160;month(s)
							</td>
						</tr>
						<tr>
							<td class="col1"><label for="duration">Duration:</label></td>
							<td>
								<h:outputText id="duration" value="#{competenceDialog.formData.duration}" />&#160;day(s)
							</td>
						</tr>
						<tr class="keywords">
							<td class="col1"><label for="validityPeriod">Keywords:</label></td>
							<td>
								<h:outputText class="tagsReadMode" value="#{competenceDialog.formData.tagsString}" />
							</td>
						</tr>
						<tr>
							<td class="col1"><label for="createdby">Created by:</label></td>
							<td>	
								<link:user value="userDetails"
									user="#{competenceDialog.formData.maker}" 
									mode="imageName"
									imageSize="22" 
									idPrefix="compDetails" 
									context="compDetailsDialog.#{competenceDialog.targetCompetence != null ? 'targetComp.'.concat(competenceDialog.targetCompetence.id) : 'comp.'.concat(competenceDialog.competence.id)}.creator.imageName"/>
							</td>
						</tr>
						<h:panelGroup rendered="#{competenceDialog.targetCompetence != null}">
						<tr>
							<td class="col1">Used in goal:</td>
							<td>	
								<link:goal
									targetGoalId="#{competenceDialog.targetCompetence.parentGoal.id}" 
									styleClass="bold"
									title="#{competenceDialog.targetCompetence.parentGoal.title}" 
									context="compDetailsDialog.#{competenceDialog.targetCompetence != null ? 'targetComp.'.concat(competenceDialog.targetCompetence.id) : 'comp.'.concat(competenceDialog.competence.id)}"/>
							</td>
						</tr>
						</h:panelGroup>
					</table>
					
					<script>
						$(function() {
							roundImages();
						    $('#competenceDetailsFormModalDialog .description').readmore({
								maxHeight: 60,
								afterToggle: function(trigger, elem, expanded) {
									sendServiceUse('MOUSE_CLICK', {context: $(elem).attr('context'), link: expanded ? 'more' : 'less'});
								}
							});
						});
					</script>
				</div>
				
				<c:if test="#{loggeduser != null and loggeduser.loggedIn and competenceDialog.owner}">
					<div class="detailsEdit hidden">
						<p:commandLink
							styleClass="button blue size30 right marginTop5"
							action="#{competenceDialog.saveCompetence}"
							update="@form"
							value="Save" 
						/>
						<p:commandLink
							styleClass="button gray size30 right marginTop5"
							action="#{competenceDialog.cancelCompetenceEdit}"
							update="@form"
							value="Cancel" 
						/>
						
						<table id="competenceDetailsEditTable">
							<tr>
								<td class="col1">
									<label for="editCompName">Name:</label>
								</td>
								<td>
									<h:inputText id="editCompName" class="name" value="#{competenceDialog.formData.title}" />
								</td>
							</tr>
							<tr class="description">
								<td class="label col1">
									<label for="editCompDescription">Description:</label>
								</td>
								<td>
									<h:inputTextarea id="editCompDescription" 
										value="#{competenceDialog.formData.description}"
										placeholder="#{msg['textarea.description']}" />
								</td>
							</tr>
							<tr class="validity">
								<td class="col1">
									<label for="editValidityPeriod">Validity:</label>
								</td>
								<td>
									<h:inputText id="editValidityPeriod" value="#{competenceDialog.formData.validity}" />&#160;month(s)
								</td>
							</tr>
							<tr class="validity">
								<td class="col1">
									<label for="editDurationPeriod">Duration:</label>
								</td>
								<td>
									<h:inputText id="editDurationPeriod" value="#{competenceDialog.formData.duration}" />&#160;day(s)
								</td>
							</tr>
							<tr class="tags">
								<td class="label col1">Keywords:</td>
								<td>
									<h:inputText class="tagsEditMode" value="#{competenceDialog.formData.tagsString}" />
								</td>
							</tr>
							<tr>
								<td class="col1"><label for="createdby">Created by:</label></td>
								<td>	
									<link:user value="userDetails"
										user="#{competenceDialog.formData.maker}" 
										mode="imageName"
										imageSize="22" 
										idPrefix="compDetailsEdit"
										context="compDetailsDialog.creator.imageName.#{competenceDialog.targetCompetence != null ? 'targetComp.'.concat(competenceDialog.targetCompetence.id) : 'comp.'.concat(competenceDialog.competence.id)}" />
								</td>
							</tr>
						</table>
					</div>
				</c:if>

				<h:panelGroup layout="block" class="recommendedPlansBlock"
					id="recommendedPlansBlockId"
					rendered="#{competenceDialog.mode == 'RECOMMENDED_COMPETENCE'}">
					
					<div class="separator"></div>
					<h3>Activity plans recommended</h3>
					
					<comp:planrecommend
						id="compDetailsPlans"
						inputCompetence="true"
						selectedCompetence="#{competenceDialog.competence}"
						parentid="competenceDetailsFormModalDialog" 
						containerClass="recommendedPlansBlock"
						activityNameLength="80"
						recommendedplans="#{competenceDialog.recommendedPlans}"
						appendedActivitiesRegionId="compDetailsDlgAppendedAct"
						cantdisplaymessage="There are no suggested activities."
						context="compDetailsDialog.#{competenceDialog.targetCompetence != null ? 'targetComp.'.concat(competenceDialog.targetCompetence.id) : 'comp.'.concat(competenceDialog.competence.id)}"
						initializeRecommendedPlans="#{competenceDialog.initializeRecommendedPlans()}" />
				</h:panelGroup>

				<h:panelGroup layout="block" styleClass="usedPlansBlock" rendered="#{competenceDialog.mode == 'TARGET_COMPETENCE'}">
					<h3>Activity plan used :</h3>
					<comp:planused id="planusedcomponendid" value="planused"
						mode="MANAGER"
						parentid="competenceDetailsFormModalDialog"
						activities="#{competenceDialog.usedActivities}"
						cantdisplaymessage="No activities have been associated with this competence."
						context="compDetailsDialog.#{competenceDialog.targetCompetence != null ? 'targetComp.'.concat(competenceDialog.targetCompetence.id) : 'comp.'.concat(competenceDialog.competence.id)}" />
				</h:panelGroup>

				<h:panelGroup layout="block" styleClass="usedPlansBlock" rendered="#{competenceDialog.mode == 'ORIGINAL_COMPETENCE'}">
					<h3>Predefined activities:</h3>
					<comp:planused id="predefinedCompetences" value="planpredefined"
						mode="MANAGER"
						parentid="competenceDetailsFormModalDialog"
						activities="#{competenceDialog.predefinedActivities}"
						cantdisplaymessage="No activities have been associated with this competence."
						context="compDetailsDialog.#{competenceDialog.targetCompetence != null ? 'targetComp.'.concat(competenceDialog.targetCompetence.id) : 'comp.'.concat(competenceDialog.competence.id)}" />
				</h:panelGroup>
			
				<div class="clear"></div>

				<h:panelGroup id="compAnalytics" rendered="#{!empty competenceDialog.formData.analyticsData}">
					<span class="competenceDetailsDialogAnalytics">
						<ul class="analytics">
							<li id="users"><span class="icon hasTooltip" title="Working on competence/Achieved competence"></span>#{competenceDialog.formData.analyticsData.numOfUsersAchieving}/#{competenceDialog.formData.analyticsData.numOfUsedBy}</li>
							<li id="thumpUp"><span class="icon hasTooltip" title="Number of likes"></span>#{competenceDialog.formData.analyticsData.numOfLikes}</li>
							<li id="thumbDown"><span class="icon hasTooltip" title="Number of dislikes"></span>#{competenceDialog.formData.analyticsData.numOfDislikes}</li>
							<li id="clock"><span class="icon hasTooltip" title="Average achievement time"></span>#{competenceDialog.formData.analyticsData.averageTime}</li>
						</ul>
					</span>
				
					<utilcomp:tooltip target=".hasTooltip[title]" />
				</h:panelGroup>

				<div class="clear"></div>

				<c:if test="#{loggeduser != null and loggeduser.loggedIn}">
					<h:panelGroup layout="block" id="actionButtons"	class="actionButtons">
						<p:commandLink value="LIKE"
							rendered="#{!competenceDialog.formData.likedByUser}"
							styleClass="button gray size30 left"
							update=":competenceDetailsForm:actionButtons :competenceDetailsForm:compAnalytics"
							action="#{competenceDialog.like(competenceDialog.competence.id)}"
							process="@this"
							async="true" />
							
						<p:commandLink value="UNLIKE"
							rendered="#{competenceDialog.formData.likedByUser}"
							styleClass="button gray size30 left"
							update=":competenceDetailsForm:actionButtons :competenceDetailsForm:compAnalytics"
							action="#{competenceDialog.removeLike(competenceDialog.competence.id)}"
							process="@this"
							async="true" />
							
						<p:commandLink value="DISLIKE"
							rendered="#{!competenceDialog.formData.dislikedByUser}"
							styleClass="button gray size30 left"
							update=":competenceDetailsForm:actionButtons :competenceDetailsForm:compAnalytics"
							action="#{competenceDialog.dislike(competenceDialog.competence.id)}"
							process="@this"
							async="true" />
							
						<p:commandLink value="REMOVE DISLIKE"
							rendered="#{competenceDialog.formData.dislikedByUser}"
							styleClass="button gray size30 left"
							update=":competenceDetailsForm:actionButtons :competenceDetailsForm:compAnalytics"
							action="#{competenceDialog.removeDislike(competenceDialog.competence.id)}"
							process="@this"
							async="true" />
							
						<action:addToGoal
							competence="#{competenceDialog.competence}"
							styleClass="button gray size30 left"
							resetStyle="true"
							title="ADD TO LEARNING"
							context="compDetailsDialog.#{competenceDialog.targetCompetence != null ? 'targetComp.'.concat(competenceDialog.targetCompetence.id) : 'comp.'.concat(competenceDialog.competence.id)}" />
						
						<p:commandLink value="SHARE"
							styleClass="button gray size30 left"
							onclick="$('#newPostDialog').dialog('open');"
							action="#{postDialogBean.preparePostDialogForResourceById(competenceDialog.competence.id, 'compDetailsDialog.'.concat(competenceDialog.targetCompetence.id))}" 
							update=":newPostDialogForm"
						/>
								
						<p:commandLink value="FOLLOW" 
							styleClass="button gray size30 left"
							rendered="#{!competenceDialog.formData.followedByUser}"
							action="#{competenceDialog.startFollowingResource(competenceDialog.competence)}" 
							update=":competenceDetailsForm:actionButtons"
						/>
							
						<p:commandLink value="UNFOLLOW" 
							styleClass="button gray size30 left"
							rendered="#{competenceDialog.formData.followedByUser}"
							action="#{competenceDialog.stopFollowingResource(competenceDialog.competence)}" 
							update=":competenceDetailsForm:actionButtons"
						/>
							
						<p:commandLink value="CONNECT" 
							styleClass="button green size30 left" 
							rendered="#{view.viewId == '/learn' and !competenceDialog.formData.ownedByUser
									and competenceDialog.canBeConnected}"
							onclick="$('#competenceDetailsFormModalDialog').dialog('close');"
							action="#{competencesBean.connectCompetence(competenceDialog.competence)}"
							oncomplete="$('#accessCompetenceHereBallon .ballonMessage').trigger('pulsate');"
							update=":competenceDetailsForm:competenceDetailsFormDialogGrowl :competenceList">
							<f:param name="context" value="#{competenceDialog.generateContext()}" />
						</p:commandLink>
					</h:panelGroup>
				</c:if>

				<script>
					$('#competenceDetailsFormModalDialog .compDetails').slideDown();
					
					$('.compDetails .tagsReadMode').tags({editMode: false});
					$('.compDetails .detailsEdit .tagsEditMode').tags();
					$('.compDetails .detailsEdit .description textarea').autosize();
					
					$(function(){
						roundImages();
						$('#competenceDetailsFormModalDialog .expandableText').shortenedText({showChar: 150});
					});
				</script>
			</div>
		</h:form>
	</div>

	<script>
		$(function() {
			$('#competenceDetailsFormModalDialog').dialog({
				autoOpen : false,
				show : 'slide',
				width : 600,
				modal : true,
				resizable : false,
				open : function(event, ui) {
					$(this).children(':first')
							.css('text-align', 'center')
							.css('padding-top', '50px')
							.html('<img src="#{request.contextPath}/resources/images/style/ajax-loader-black.gif" style="vertical-align:middle;"/>');
				},
				close : function(event, ui) {
					$(this).dialog('option', 'myCompetence', false);
				}
			});
			$('#competenceDetailsFormModalDialog').show();
		});
	</script>
	
	<dlg:appendedActivities id="compDetailsDlgAppendedAct" />
</ui:composition>