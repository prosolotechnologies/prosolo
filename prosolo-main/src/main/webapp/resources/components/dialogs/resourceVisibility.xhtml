<ui:component xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:composite="http://java.sun.com/jsf/composite"
	xmlns:p="http://primefaces.org/ui"
	xmlns:comp="http://java.sun.com/jsf/composite/components"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:util="http://www.prosolo.com/util"
	xmlns:courses="http://java.sun.com/jsf/composite/components/courses">

	<composite:interface>
		<composite:attribute name="bean" required="true" />
		<composite:attribute name="resource" type="java.lang.String" default="Credential" />
		<composite:attribute name="toUpdate" default=""></composite:attribute>
		<composite:attribute name="learningContext" default="" />
	</composite:interface>

	<composite:implementation>
		<script src="#{request.contextPath}/resources/javascript2/search.js"></script>

		<h:form id="formManageVisibility">
			<div class="modal fade manageVisibility" id="manageVisibility" tabindex="-1" role="dialog" aria-labelledby="manageVis">
				<div class="modal-dialog">
					<h:panelGroup layout="block" id="panelManageVisibility" styleClass="modal-content">
						<div class="modal-header alignLeft">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&#215;</span>
							</button>
							<h2 class="modal-title">#{cc.attrs.resource} Access</h2>
						</div>
						
						<div class="checkbox checkLine checkAll">
							<h:selectBooleanCheckbox id="checkVisibleAll"
								value="#{cc.attrs.bean.visibleToEveryone}">
							</h:selectBooleanCheckbox>
							<h:outputLabel for="checkVisibleAll">Visible to Everyone</h:outputLabel>
						</div>
						
						<div class="searchInstructors">
							<p:remoteCommand name="execSearchGroups"
								process="inputGroupSearch" update="panelGroupSearchResults"
								action="#{cc.attrs.bean.searchUsersAndGroups()}"
								oncomplete="showSearchResults('.panelGroupSearchResultsSelector', '.groupSearchFieldSelector');" />

							<h:inputText id="inputGroupSearch" type="search"
								styleClass="groupSearchFieldSelector"
								placeholder="Search Users #{cc.attrs.bean.manageSection ? 'or Groups' : ''}"
								value="#{cc.attrs.bean.searchTerm}" onclick="$(this).select();"
								onkeyup="searchIfNeeded('.groupSearchFieldSelector', execSearchGroups); return false;" />

							<h:panelGroup id="panelGroupSearchResults">
								<ui:fragment rendered="#{not empty cc.attrs.bean.searchMembers}">
									<ul class="dropdown-menu searchResultsDrop panelGroupSearchResultsSelector" style="display: block;">
										<ui:repeat var="member" value="#{cc.attrs.bean.searchMembers}">
											<li>
												<p:commandLink process="@this"
													action="#{cc.attrs.bean.addNewMember(member)}"
													update=":#{cc.clientId}:formManageVisibility:panelExistingMembers @(.linkNewMemberPrivilegeSelector)"
													oncomplete="$('.groupSearchFieldSelector').val(''); $('.panelGroupSearchResultsSelector').first().stop(true, true).slideUp(10);">
													
													<div class="instructorInfo">
														<ui:fragment rendered="#{member.type eq 'User'}">
															<utilcomp:userAvatar 
																avatar="#{member.avatar}"
																fullName="#{member.name}" 
																width="48" height="48" />
																
															<div class="infoWrap">
																<h3>#{member.name}</h3>
																<span>#{member.position}</span>
															</div>
														</ui:fragment>
														
														<ui:fragment rendered="#{member.type eq 'Group'}">
															<div class="infoWrap">
																<h3>#{member.name}</h3>
																<span>#{member.userCount} #{member.userCount eq 1 ? 'User' : 'Users'}</span>
															</div>
														</ui:fragment>
													</div>
												</p:commandLink>
											</li>
										</ui:repeat>
									</ul>
								</ui:fragment>
							</h:panelGroup>
							
							<div class="dropdown sortDrop">
								<p:commandLink id="linkNewMemberPrivilege"
									styleClass="linkNewMemberPrivilegeSelector"
									pt:data-toggle="dropdown" pt:aria-haspopup="true"
									pt:aria-expanded="true">
                                      #{cc.attrs.bean.newMemberPrivilege.label}
                                      <span class="arrowDown">arrowDown</span>
								</p:commandLink>
								
								<ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">
									<ui:repeat var="priv" value="#{cc.attrs.bean.privileges}">
										<li>
											<p:commandLink process="@this"
												action="#{cc.attrs.bean.setPrivilegeForNewMember(priv)}"
												update="@(.linkNewMemberPrivilegeSelector)">
                               	   				#{priv.label}
                               	   			</p:commandLink>
                                  	   	</li>
									</ui:repeat>
								</ul>
							</div>
						</div>

						<p>Who has access:</p>

						<h:panelGroup id="panelExistingMembers">
							<ul class="list">
								<li>
									<div class="instructorInfo">
										<utilcomp:userAvatar 
											avatar="#{cc.attrs.bean.creator.avatar}"
											fullName="#{cc.attrs.bean.creator.name}" 
											width="48" height="48" />
											
										<div class="infoWrap">
											<h3>#{cc.attrs.bean.creator.name}</h3>
											<span>#{cc.attrs.bean.creator.position}</span>
										</div>
									</div>
									<div class="assignOpt">
										Is owner
									</div>
								</li>
							
								<ui:repeat var="group" value="#{cc.attrs.bean.existingGroups}" varStatus="status">
									<ui:fragment rendered="#{group.status ne 'REMOVED'}">
										<li>
											<div class="instructorInfo">
												<div class="infoWrap">
													<h3>#{group.name}</h3>
													<span>#{group.userCount} #{group.userCount eq 1 ? 'User' : 'Users'}</span>
												</div>
											</div>
											
											<div class="assignOpt">
												<div class="dropdown sortDrop">
													<p:commandLink id="existGroupPrivLink"
														styleClass="existGroupPrivLinkSelector#{status.index}"
														pt:data-toggle="dropdown" pt:aria-haspopup="true"
														pt:aria-expanded="true">
														#{group.privilege.label}
														<span class="arrowDown">arrowDown</span>
													</p:commandLink>
													
													<ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">
														<ui:repeat var="priv" value="#{cc.attrs.bean.privileges}">
															<li>
																<p:commandLink process="@this"
																	action="#{cc.attrs.bean.setPrivilegeForMember(group, priv)}"
																	update="@(.existGroupPrivLinkSelector#{status.index})">
																	#{priv.label}
																</p:commandLink>
															</li>
														</ui:repeat>
													</ul>
												</div>
												<p:commandLink styleClass="removeX" process="@this"
													action="#{cc.attrs.bean.removeMember(group)}"
													update=":#{cc.clientId}:formManageVisibility:panelExistingMembers">
													Close
												</p:commandLink>
											</div>
										</li>
									</ui:fragment>
								</ui:repeat>
								
								<ui:repeat var="user" value="#{cc.attrs.bean.existingUsers}" varStatus="status">
									<ui:fragment rendered="#{user.status ne 'REMOVED'}">
										<li>
											<div class="instructorInfo">
												<utilcomp:userAvatar 
													avatar="#{user.avatar}"
													fullName="#{user.name}" 
													width="48" height="48" />
													
												<div class="infoWrap">
													<h3>#{user.name}</h3>
													<span>#{user.position}</span>
												</div>
											</div>
											
											<div class="assignOpt">
												<div class="dropdown sortDrop">
													<p:commandLink id="existUserPrivLink"
														styleClass="existUserPrivLinkSelector#{status.index}"
														pt:data-toggle="dropdown" pt:aria-haspopup="true"
														pt:aria-expanded="true">
														#{user.privilege.label}
														<span class="arrowDown">arrowDown</span>
													</p:commandLink>
													
													<ul class="dropdown-menu dropdown-menu-right"
														aria-labelledby="dropdownMenu1">
														<ui:repeat var="priv" value="#{cc.attrs.bean.privileges}">
															<li>
																<p:commandLink process="@this"
																	action="#{cc.attrs.bean.setPrivilegeForMember(user, priv)}"
																	update="@(.existUserPrivLinkSelector#{status.index})">
																	#{priv.label}
																</p:commandLink>
															</li>
														</ui:repeat>
													</ul>
												</div>
												<p:commandLink styleClass="removeX" process="@this"
													action="#{cc.attrs.bean.removeMember(user)}"
													update=":#{cc.clientId}:formManageVisibility:panelExistingMembers">
													Close
												</p:commandLink>
											</div>
										</li>
									</ui:fragment>
								</ui:repeat>
							</ul>
						</h:panelGroup>
						
						<div class="modal-footer alignLeft">
							<p:commandLink styleClass="btn btn-green"
								action="#{cc.attrs.bean.saveVisibilityMembersData()}"
								oncomplete="$('#manageVisibility').modal('hide');"
								update="#{cc.attrs.toUpdate}">
								<f:param name="page" value="#{facesContext.viewRoot.viewId}" />
								<f:param name="learningContext" value="#{cc.attrs.learningContext}" />
								<f:param name="service" value="name:manage_visibility_dialog" />
								Done
							</p:commandLink>
						</div>
					</h:panelGroup>
				</div>
			</div>
			<script>
			$('#manageVisibility').on('shown.bs.modal', function () {
			    $('#manageVisibility .groupSearchFieldSelector').focus();
			}) 
			</script>
		</h:form>
	</composite:implementation>
</ui:component>