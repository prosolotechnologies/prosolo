<ui:component
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"  
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:composite="http://java.sun.com/jsf/composite"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:icon="http://java.sun.com/jsf/composite/components/resourceLinks/icons"
	xmlns:util="http://www.prosolo.com/util"
	xmlns:pt="http://java.sun.com/jsf/passthrough">

	<!-- actionBean: this bean must have a method 'void connectActivity(Activity)' -->
	<!-- targetCompIdToPreselectWhenAdding: Used on the Learn page to know on which competence to preselect -->

	<composite:interface>
		<composite:attribute name="renderGlassIcon" default="true" />
		<composite:attribute name="container" required="true" />
		<composite:attribute name="value" required="true" />
		<composite:attribute name="regionToRenderOnAction" />
		<composite:attribute name="refreshCommand" />
		<composite:attribute name="actionLinkName" default="Connect" />
		<composite:attribute name="actionBean" required="true" /> 
		<composite:attribute name="loaderImage" default="#{request.contextPath}/resources/images/style/ajax-loader-white.gif"/>
		<composite:attribute name="toExclude" type="java.util.Collection"/>
		<composite:attribute name="toExcludeIds" type="java.lang.String" />
		<composite:attribute name="targetCompIdToPreselectWhenAdding" />
		<composite:attribute name="disabled" type="java.lang.Boolean" />
		<composite:attribute name="disabledTooltip" type="java.lang.String" />
		<composite:attribute name="context" type="java.lang.String" />
		<composite:attribute name="page" />
		<composite:attribute name="learningContext" />
		<composite:attribute name="service" />
	</composite:interface>
	
	<composite:implementation>
		<h:outputScript library="javascript" name="prosolo.overlay.js" target="head" />
		<h:outputScript library="javascript" name="prosolo.search.js" target="head" />
	
		<div class="activitySearch">
			<h:panelGroup layout="group" id="actSearchform">
				<p:remoteCommand name="#{cc.clientId.replace(':', 'i')}SendActivitiesAjaxical" 
					update="actSearchResultPanel" 
					action="#{searchActivitiesBean.executeSearch(cc.attrs.toExcludeIds != null ? cc.attrs.toExcludeIds : util:toIdArray(cc.attrs.toExclude), cc.attrs.context)}"/>
				
				<script>
				var #{cc.attrs.value}Search;
				$(function() {
					$('#{cc.attrs.container} .activitySearch').prosolosearch({
						resultContainer: '#{cc.attrs.container} .activitySearch .#{cc.attrs.value}SearchContainer',
						loaderContainer: '#{cc.attrs.container} .activitySearch .#{cc.attrs.value}SearchContainer .#{cc.attrs.value}SearchPanel',
						searchInput: '#{cc.attrs.container} .activitySearch .searchInput',
						watermark: 'Search activities',
						loaderImage: '#{cc.attrs.loaderImage}',
						searchAction: #{cc.clientId.replace(':', 'i')}SendActivitiesAjaxical
					});
					#{cc.attrs.value}Search = $('#{cc.attrs.container} .activitySearch').data('prosolo.search');
				});
				</script>
	 
				<h:panelGroup layout="group" class="mGlass" rendered="#{cc.attrs.renderGlassIcon}" />
	
			  	<h:inputText id="actInputString" size="20" 
			  		class="searchInput"
			  		value="#{searchActivitiesBean.query}"
			  		disabled="#{cc.attrs.disabled}"
			  		pt:title="#{cc.attrs.disabled ? cc.attrs.disabledTooltip : ''}"
			  	/>
							
				<div id="suggestions#{cc.attrs.value}" class="genericSearchContainer #{cc.attrs.value}SearchContainer">
	 				<h:panelGroup layout="block" id="actSearchResultPanel" class="#{cc.attrs.value}SearchPanel">
						
						<script>
						$(function() {
							/*
							if(typeof #{cc.attrs.value}Search !== 'undefined'){
								#{cc.attrs.value}Search.clearTimeout();
							};
							*/
							$('#{cc.attrs.container} .activitySearch .category .seeAllLink').attr('href', $('#{cc.attrs.container} .activitySearch .category .seeAllLink').attr('href')+$('#{cc.attrs.container} .activitySearch .searchInput').val());
						});
						</script>
					
	 					<h:panelGroup layout="block" id="actSearchResultPanelContent" rendered="#{not empty searchActivitiesBean.activities}">
		 				 	<div class="category">
		 				 		Activities(#{searchActivitiesBean.activitiesSize})
		 				 		<span class="right">
									<h:link class="seeAllLink" 
										onclick="sendLogPageNavigation('search/activities', '#{cc.attrs.context}');" 
										outcome="/search"
										value="See all">
										<f:param name="tab" value="activities" />
										<f:param name="query" value="" />
									</h:link>
								</span>
							</div>
		 				 	
							<ui:repeat value="#{searchActivitiesBean.activities}" var="actResultData" varStatus="iterator">
								<div class="searchRecord">
									<div class="image">
										<icon:activity />
									</div>
	
									<div class="info">
										<div class="title">#{actResultData.title}</div>
	
										<h:panelGroup layout="block" rendered="#{!empty actResultData.activity.maker}">
											Created	by: 
											
											<link:user value="activityCreator" 
							    				userData="#{actResultData.creator}"
							    				mode="name"
							    				idPrefix="#{iterator.index}"
							    				context="#{cc.attrs.context}.result.#{actResultData.id}.maker.name" />
										</h:panelGroup>
										
										<div class="membersCount">
											#{activitiesSearchBean.getCompetenceUsersNumber(actResultData.activity)}
										</div>
										
										<div class="actions">
									
											<link:activity 
												activityId="#{actResultData.id}"
												title="Details"
												context="#{cc.attrs.context}"
												onclick="#{cc.attrs.value}Search.hideResults();"
												targetCompIdToPreselectWhenAdding="#{cc.attrs.targetCompIdToPreselectWhenAdding}"
												toUpdateAfterAddingToCompetence="#{cc.attrs.regionToRenderOnAction}"/>
	
											<span class="bullet"></span>
											
											<p:commandLink 
												value="#{cc.attrs.actionLinkName}"
												onclick="#{cc.attrs.value}Search.resetSearch();prosolo.overlay.activate();"
												action="#{cc.attrs.actionBean.connectActivity(actResultData.activity)}"
												update="#{cc.attrs.regionToRenderOnAction}"
												oncomplete="#{cc.attrs.refreshCommand};prosolo.overlay.reset();">
												<f:param name="context" value="#{cc.attrs.context}" />
												<f:param name="page" value="#{cc.attrs.page}" />
												<f:param name="learningContext" value="#{cc.attrs.learningContext}" />
												<f:param name="service" value="#{util:addSubService(cc.attrs.service, 'name:ACTIVITY_SEARCH')}" />
											</p:commandLink>
										</div>
									</div>
								</div>
							</ui:repeat>
	 					</h:panelGroup>
	 					
						<h:panelGroup id="noActivitiesResultsPanel" class="noResultPanelWhite" 
							rendered="#{empty searchActivitiesBean.activities}">
							No results found
						</h:panelGroup>
						
						<br class="break" />
					</h:panelGroup>
		 		</div>
			</h:panelGroup>
		</div>
	</composite:implementation>
</ui:component>