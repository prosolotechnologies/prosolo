<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:pt="http://java.sun.com/jsf/passthrough"
	xmlns:util="http://www.prosolo.com/util">
	
	<h:outputScript library="javascript" name="prosolo.overlay.js" target="head" />

	<li>
	
	<h:form id="notificationForm">
			<p:growl id="notificationsGrowl" showDetail="true" />

			<p:poll interval="#{topNotificationsBean.refreshRate}"
				oncomplete="roundImages"
				update=":notificationForm"
				widgetVar="notificationsPoll" autoStart="true" />


			<p:commandLink styleClass="faded"
				action="#{topNotificationsBean.initNotifications()}"
				actionListener="#{topNotificationsBean.logNotificationServiceUse()}"
				async="true" pt:aria-expanded="false" pt:aria-haspopup="true"
				pt:role="button" pt:data-toggle="dropdown"
				update=":notificationForm:notificationsResultPanelContent @this">

				<i class="fa fa-bell-o fa-lg"></i>

				<h:panelGroup class="bdg" rendered="#{topNotificationsBean.unreadNotificationsNo > 0}">
					#{topNotificationsBean.unreadNotificationsNo}
				</h:panelGroup>
			</p:commandLink>

			<div class="dropdown-menu notificationsContainer pull-right" aria-labelledby="dLabel">
				<h3 class="title">Notifications</h3>

				<h:panelGroup layout="block" styleClass="itemsContainer" id="notificationsResultPanelContent">
					
					<h:panelGroup layout="block" 
						styleClass="noContent"
						rendered="#{empty topNotificationsBean.notifications}">
                 
                          	No notifications
					</h:panelGroup>

					<ui:repeat value="#{topNotificationsBean.notifications}" var="notificationData" varStatus="iterator">
						<div class="alert fade in item #{notificationData.read == 'false' ? 'unread' : ''}">
							<div class="row">
								<div class="col-md-2">
									<span class="userProfileImage"> 
										<link:user
											value="notifications" userData="#{notificationData.actor}"
											mode="image" imageSize="30" 
											idPrefix="notActor#{iterator.index}"
											context="notifications.image" />
									</span>
								</div>
								
								<div class="col-md-10">
									<div class="userName">
										<h:link class="user" value="#{notificationData.actor.name}"
											outcome="/publicprofile">
											<f:param name="id" value="#{util:encodeId(notificationData.actor.id)}" />
										</h:link>
										
										<span>#{notificationData.type}
											#{notificationData.resource.shortType} 
											<link:resourceLink
												styleClass="bold"
												resourceId="#{notificationData.resource.id}"
												type="#{notificationData.resource.clazz.simpleName}"
												title="#{notificationData.resource.title}" />
										</span>
									</div>
									<div class="date">#{notificationData.when}</div>
									
									<h:panelGroup rendered="#{notificationData.chosenAction == null}">
										<ui:repeat value="#{notificationData.actions}" var="notificationAction" varStatus="notificationActionStatus">
											
											<p:commandLink styleClass="more3"
												rendered="#{notificationData.goalStatus != null and notificationAction == 'ACCEPT'}"
												value="#{topNotificationsBean.getNotificationActionName(notificationAction)}"
												onclick="$('#joinGoalFormModalDialog').dialog('open');"
												action="#{joinGoalDialog.initializeJoinGoalDialog(notificationData, 'notifications')}" 
												update=":joinGoalForm"
												async="true" />
										
											<p:commandLink styleClass="more3"
												rendered="#{!(notificationData.goalStatus != null and notificationAction == 'ACCEPT')}"
												value="#{topNotificationsBean.getNotificationActionName(notificationAction)}"
												onclick="prosolo.overlay.activate();"
												action="#{topNotificationsBean.invokeAction(notificationAction, notificationData)}" 
												update="@form"
												oncomplete="prosolo.overlay.reset();"
												async="true" />
										</ui:repeat>
									</h:panelGroup>
									
									<h:panelGroup class="inactive" rendered="#{notificationData.chosenAction != null}">
										#{notificationData.chosenAction}
									</h:panelGroup>
								</div>
							</div>
							<button aria-label="Close" data-dismiss="alert" class="close" type="button">
								<span aria-hidden="true">Ã—</span>
							</button>
						</div>
					</ui:repeat>
				</h:panelGroup>

				<h:link styleClass="seeAll" value="See all notifications"
					outcome="/communications">
					<f:param name="tab" value="notifications" />
				</h:link>
			</div>
		</h:form>
	</li>
</ui:composition>