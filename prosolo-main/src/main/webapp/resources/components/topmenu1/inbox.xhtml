
<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:action="http://java.sun.com/jsf/composite/components/actions"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:pt="http://java.sun.com/jsf/passthrough"
	xmlns:util="http://www.prosolo.com/util">

	<li class="dropdown">
		
		<h:form id="inboxForm">
			<p:growl id="messagesGrowl" showDetail="true" />

			<p:poll interval="#{topInboxBean.refreshRate}"
				oncomplete="roundImages" update=":inboxForm"
				widgetVar="messagesPoll" autoStart="true" />
				
			<p:commandLink styleClass="faded" pt:aria-expanded="false"
				pt:aria-haspopup="true" pt:role="button" pt:data-toggle="dropdown"
				action="#{topInboxBean.readMessagesAndRedirect()}"
				actionListener="#{messagesBean.logInboxServiceUse()}" async="true"
				update=":inboxForm:messagesPanelContent @this">

				<i class="fa fa-envelope-o fa-lg"></i>
				<ui:remove>
					<h:panelGroup styleClass="bdg"
						rendered="#{messagesBean.unreadThreadsNo > 0}">
						#{messagesBean.unreadThreadsNo}
					</h:panelGroup>
				</ui:remove>
			</p:commandLink>


			<div class="dropdown-menu messagesContainer pull-right" aria-labelledby="dLabel">

				<h3 class="title">Messages</h3>

				<h:panelGroup layout="block" styleClass="itemsContainer"  id="messagesPanelContent">
					
					<h:panelGroup layout="block" 
						styleClass="noContent"
						rendered="#{empty messagesBean.messagesThreads}">
                 
                          	No messages
					</h:panelGroup>

					<ui:repeat value="#{messagesBean.messagesThreads}"
						var="messageThreadData" varStatus="iterator">
						
						<h:link outcome="/messages" class="item"
							onclick="sendLogPageNavigationWithParameters('messages', { context:'mainmenu', thread: #{messageThreadData.id}});">
							<f:param name="id" value="#{util:encodeId(messageThreadData.id)}" />

							<div class="row">
								<div class="col-md-2">

									<span class="userProfileImage"> 
										<img
											title="#{messageThreadData.participantsWithoutLoggedUser.get(0).name}"
											src="#{messageThreadData.participantsWithoutLoggedUser.get(0).avatarUrl != null ? messageThreadData.participantsWithoutLoggedUser.get(0).avatarUrl : colleguesBean.avatarUrlByUserId(messageThreadData.participantsWithoutLoggedUser.get(0).id, 60)}"
											alt="#{messageThreadData.participantsWithoutLoggedUser.get(0).name}" />
									</span>
								</div>
								
								<div class="col-md-10">
									<div class="userName">
										#{messageThreadData.participantsWithoutLoggedUser.get(0).name}
										<div class="date">#{messageThreadData.updateTime}</div>
									</div>
									
									<span>"#{messageThreadData.latest.shortContent}"</span>
									<div class="more3">Read message</div>
								</div>
							</div>
						</h:link>
					</ui:repeat>
				</h:panelGroup>

				<h:link styleClass="seeAll" value="See all messages" outcome="/messages" />
			</div>
		</h:form>
	</li>
</ui:composition>