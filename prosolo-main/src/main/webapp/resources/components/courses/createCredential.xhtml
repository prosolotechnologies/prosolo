<ui:component
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:composite="http://java.sun.com/jsf/composite"
	xmlns:p="http://primefaces.org/ui"
	xmlns:comp="http://java.sun.com/jsf/composite/components"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:util="http://www.prosolo.com/util"
	xmlns:courses="http://java.sun.com/jsf/composite/components/courses"
	xmlns:dlg="http://java.sun.com/jsf/composite/components/dialogs">

	<composite:interface>
		<composite:attribute name="role" type="java.lang.String" default="USER"/>
		<composite:attribute name="toUpdate" default=""></composite:attribute>
	</composite:interface>
	
	<composite:implementation>
		<h:outputStylesheet name="bootstrap-datetimepicker.css" library="css2"/>
		<link rel="stylesheet" type="text/css" media="all" href="#{request.contextPath}/resources/css2/bootstrap-tagsinput.css" />
		<script src="#{request.contextPath}/resources/javascript2/bootstrap-tagsinput.min.js"></script>
		<script src="#{request.contextPath}/resources/javascript2/moment.min.js"></script>
		<script src="#{request.contextPath}/resources/javascript2/bootstrap-datetimepicker.min.js"></script>
		<script src="#{request.contextPath}/resources/javascript2/search.js"></script>
		<script src="#{request.contextPath}/resources/javascript2/createCredential.js"></script>
		<script src="#{request.contextPath}/resources/javascript2/tinymce/tinymce.min.js"></script>
	    <script src="#{request.contextPath}/resources/javascript2/prosolo.tinymce.js"></script>
	    <script src="#{request.contextPath}/resources/javascript2/startDelivery.js"></script>
	   
		<div class="whiteBar">
			<c:if test="#{credentialEditBean.original and credentialEditBean.credentialData.id gt 0}">
				<div class="container">
	            	<div class="whiteBarContent">
	                	<div class="whiteBarLeft">
	                    	<p:commandLink styleClass="btn btn-green btn-sm item" pt:data-toggle="modal" 
	                    		process="@this"
	                    		update="startDeliveryModal:formDeliveryStart:newDeliveryModalContent"
	                    		oncomplete="$('#newDeliveryModal').modal('show');">
	                    		Start New Delivery
	                    	</p:commandLink>
						</div>
					</div>
				</div>
			</c:if>
		</div>
		
		<div class="container">
	        <ol class="breadcrumb">
	            <li>
	            	<h:link value="Credentials" outcome="credentialLibrary"/>
	            </li>
	            <ui:fragment rendered="#{!credentialEditBean.isCreateUseCase()}">
	            	<li class="active">#{credentialEditBean.credentialData.title}</li>
	            </ui:fragment>
	            <ui:fragment rendered="#{credentialEditBean.isCreateUseCase()}">
	            	<li class="active">New Credential</li>
	            </ui:fragment>
	        </ol>
	    </div>
		
	   	<div id="#{cc.clientId}">
	   	<script>
			containerId = '#{cc.clientId}';
		</script>
		<h:form id="formMain">
			<p:growl id="growlMain" showDetail="true" globalOnly="true"></p:growl>
			<ui:param name="learningContext" value="#{credentialEditBean.decodedId > 0 ? 'name:CREDENTIAL|id:'.concat(credentialEditBean.decodedId) : ''}"></ui:param>
			<div class="container">
				<div class="row">
					<div class="col-md-8">
						<div class="whiteBox">
							<ul class="nav nav-tabs pageSubmenu" role="tablist">
								<li role="presentation" class="#{param.tab ne 'competences' ? 'active' : ''}"><a href="#info" aria-controls="info" role="tab" data-toggle="tab" onclick="setQueryParam('tab','info')">Credential Info</a></li>
								<li role="presentation" class="#{param.tab eq 'competences' ? 'active' : ''}"><a href="#competences" aria-controls="competences" role="tab" data-toggle="tab" onclick="setQueryParam('tab','competences')">Competences</a></li>
							</ul>
						</div>
						<div class="tab-content">
							<div role="tabpanel" class="tab-pane fade #{param.tab ne 'competences' ? 'active in' : ''}" id="info">
								<div class="whiteBox">
									<h2>#{credentialEditBean.resourceTypeString} Info</h2>
									
									<div class="formWrapper">
										<div class="formLine">
											<label>Title</label>
											<div class="formLineRight">
												<h:inputText 
													id="inputTitle" 
													value="#{credentialEditBean.credentialData.title}" 
													required="true"
													requiredMessage="Title is required"/>
												<h:panelGroup 
						                        	layout="block" 
						                        	rendered="#{not empty facesContext.getMessageList(cc.clientId.concat(':formMain:inputTitle'))}" 
						                        	styleClass="alert alert-danger" 
						                        	pt:role="alert">
						                            <h:message for="inputTitle"></h:message>
						                        </h:panelGroup>
											</div>
										</div>
										
										<div class="formLine">
											<label>About credential</label>
											<div class="formLineRight">                           
												<h:inputTextarea
													id="inputDescription" 
													value="#{credentialEditBean.credentialData.description}"
													required="true"
													requiredMessage="Description is required" />
												<h:panelGroup
													layout="block"
													rendered="#{not empty facesContext.getMessageList(cc.clientId.concat(':formMain:inputDescription'))}"
													styleClass="alert alert-danger"
													pt:role="alert">
													<h:message for="inputDescription"></h:message>
												</h:panelGroup>
													
												<script>
		                                    		initTinyMCE('#createCredential\\:formMain\\:inputDescription');
		                                    	</script>
											</div>
										</div>
										
										<div class="formLine">
											<label>Keywords</label>
											
											<div class="formLineRight">
												<h:inputText id="inputKeywords" styleClass="tagsInputCredTag"
													value="#{credentialEditBean.credentialData.tagsString}"
													pt:placeholder="Type and press 'Enter'"
													pt:data-role="tagsinput" />
											</div>
										</div>
										
										<script>$('.tagsInputCredTag').tagsinput();</script>
										
										<div class="formLine">
											<label>Twitter hashtags</label>
											
											<div class="formLineRight">
												<h:inputText id="inputHashtags" styleClass="tagsInputCredHahstag"
												value="#{credentialEditBean.credentialData.hashtagsString}"
												pt:placeholder="Type and press 'Enter'"
												pt:data-role="tagsinput" />
											</div>
										</div>
										<script>$('.tagsInputCredHahstag').tagsinput();</script>
										
										<div class="formLine">
		                                    <label>Other</label>
		                                    <div class="formLineRight">
		                                        <div class="checkbox checkLine">
													<h:selectBooleanCheckbox 
														id="checkMandatory"
														value="#{credentialEditBean.credentialData.mandatoryFlow}"
														onchange="showOrHideMandatoryArrows();">
													</h:selectBooleanCheckbox>
													
													<h:outputLabel for="checkMandatory">
														Mandatory flow
													</h:outputLabel>
												</div>
												<c:if test="#{cc.attrs.role eq 'MANAGER'}">
													<div class="checkbox checkLine">
														<h:selectBooleanCheckbox disabled="#{credentialEditBean.delivery}"
															id="checkAutomaticAssign"
															value="#{credentialEditBean.credentialData.automaticallyAssingStudents}">
														</h:selectBooleanCheckbox>
										                <h:outputLabel for="checkAutomaticAssign">
															Assign instructor to students automatically
														</h:outputLabel>
										            </div>
									            </c:if>
		                                    </div>
		                               </div>                      							
									</div>
								</div>
							</div>
				            
							<div role="tabpanel" class="tab-pane fade #{credentialEditBean.credentialData.mandatoryFlow ? 'mandatoryFlow' : ''} #{param.tab eq 'competences' ? 'active in' : ''}" id="competences">
								<courses:compList 
									id="compList"
									bean="#{credentialEditBean}"
									competences="#{credentialEditBean.credentialData.competences}"
									isEdit="true"
									startedLearning="false"
									toUpdate=""
									role="#{cc.attrs.role}"
									credentialId="#{credentialEditBean.id}"
									isOriginal="#{credentialEditBean.original}"/>
			
								<h:panelGroup layout="block" styleClass="newCompetenceBox" rendered="#{credentialEditBean.original}">
									<div class="elementsWrapper">
										<p:commandLink
											styleClass="btn btn-green"
											value="Create New Competence"
											action="#{credentialEditBean.saveAndNavigateToCreateCompetence}" 
											oncomplete="if (args &amp;&amp; args.validationFailed) { $('##{cc.clientId}\\:formMain\\:hiddenLinkFailure').click();};"
											onclick="copyTextFromTinyMCEToTextarea('#createCredential\\:formMain\\:inputDescription');">
											<f:param name="page" value="#{facesContext.viewRoot.viewId}"></f:param>
											<f:param name="learningContext" value="name:new_competence"></f:param>
										</p:commandLink>
										
										<p:commandLink style="display:none" id="hiddenLinkFailure"
					 							update=":#{cc.clientId}:formMain"
					 					/>
										<span>or</span>
		
										<div class="elementsRight">
											<p:remoteCommand name="execSearchComps" process="inputCompName"
												update=":#{cc.clientId}:formMain:panelCompSearchResults"
												action="#{credentialEditBean.searchCompetences()}">
												<f:param name="page" value="#{facesContext.viewRoot.viewId}"></f:param>
												<f:param name="learningContext" value="#{learningContext}"></f:param>
										    </p:remoteCommand>
											
											<h:inputText id="inputCompName"
												styleClass="competenceSearchField"
												value="#{credentialEditBean.compSearchTerm}"
												placeholder="Add existing one" 
												onclick="$(this).select();"
												onkeyup="showSearchResults('.panelCompSearchResultsSelector', '.competenceSearchField');searchIfNeeded('.competenceSearchField', execSearchComps);return false;">
											</h:inputText>
											
											<h:panelGroup id="panelCompSearchResults">
												<h:panelGroup rendered="#{not empty credentialEditBean.compSearchResults}">
													<ul class="dropdown-menu searchResultsDrop panelCompSearchResultsSelector" style="display:block;">
														<ui:repeat var="comp" value="#{credentialEditBean.compSearchResults}">
															<li>
																<p:commandLink
																	process="@this"
																	action="#{credentialEditBean.addComp(comp)}"
																	update=":#{cc.clientId}:formMain:compList :#{cc.clientId}:formMain:panelCompSearchResults"
																	oncomplete="$('.competenceSearchField').val(''); $('.panelCompSearchResultsSelector').first().stop(true, true).slideUp(10);">
																	<h3>#{comp.title}</h3>
																</p:commandLink>
															</li>
														</ui:repeat>
													</ul>
												</h:panelGroup>
											</h:panelGroup>
		
											<ui:remove><a href="#">Recommended Competences</a></ui:remove>
										</div>
									</div>
								</h:panelGroup>
							</div>
						</div>
					</div>
					
						<div class="col-md-4">
							<ui:remove>
								<h:panelGroup layout="block" rendered="#{!credentialEditBean.createUseCase}" styleClass="whiteBox publishBox visibilityBox">
									<ui:remove>
										<p class="url">
											Public URL:<br></br>
											<a href="#">https://uta.prosolo.ca/prosolo/credentials/X7J62DA7</a>
										</p>
									</ui:remove>
								</h:panelGroup>
							</ui:remove>
							
							<ui:remove>
								<div class="alert alert-info alert-dismissible" role="alert">
			                    	<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>
			                    	Note that all credential changes will affect all students currently learning for this credential.
			                	</div>
			                </ui:remove>
							
							<div class="whiteBox publishBox">
			                    <h2>Options</h2>
			                    <h:link
									styleClass="linkPreview"
									value="Preview"
									outcome="credential">
									<f:param name="id" value="#{credentialEditBean.id}"></f:param>
								</h:link>
			                    <div class="clear"></div>
			                    <c:if test="#{credentialEditBean.delivery}">
				                    <label>Start:</label>
				                    <div class="datePickerRow">
				                    	<h:inputText id="startDate" placeholder="Date and Time" disabled="#{credentialEditBean.hasDeliveryStarted()}"
				                    		styleClass="datePickerSelector#{credentialEditBean.hasDeliveryStarted() ? '1' : ''} deliveryStartSelector"
		                                   	value="#{credentialEditBean.credentialData.deliveryStart}">
		                                   	<f:convertDateTime pattern="MM/dd/yyyy hh:mm a" />
	                          			</h:inputText>
				                    </div>
				                    <label>End:</label>
				                    <div class="datePickerRow">
				                        <h:inputText id="endDateHidden" placeholder="Date and Time" disabled="#{credentialEditBean.hasDeliveryEnded()}"
		                                   	styleClass="datePickerSelector#{credentialEditBean.hasDeliveryEnded() ? '1' : ''} deliveryEndSelector"
		                                   	value="#{credentialEditBean.credentialData.deliveryEnd}">
		                                   	<f:convertDateTime pattern="MM/dd/yyyy hh:mm a" />
			                          </h:inputText>
				                    </div>
				                    <script>
				                    	$(function() {
				                    		initializeDatePickers();
				                    		disableInputAfterSpecifiedTime('deliveryStartSelector', 
				                    				#{credentialEditBean.getNumberOfMillisecondsBetweenNowAndDeliveryStart()});
				                    		disableInputAfterSpecifiedTime('deliveryEndSelector', 
				                    				#{credentialEditBean.getNumberOfMillisecondsBetweenNowAndDeliveryEnd()});
				                    	}); 
				                    
				                    </script>
				                </c:if>
			                    <div class="publishRow">
			                    	<p:commandLink
										styleClass="btn btn-green"
										action="#{credentialEditBean.save()}"
										update=":#{cc.clientId}:formMain #{cc.attrs.toUpdate} :#{cc.clientId}:archiveDialog :#{cc.clientId}:restoreDialog"
										oncomplete=""
										onclick="copyTextFromTinyMCEToTextarea('#createCredential\\:formMain\\:inputDescription');">
										<f:param name="page" value="#{facesContext.viewRoot.viewId}" />
										<f:param name="learningContext" value="#{learningContext}" />
										Save changes
									</p:commandLink>
			                        <ui:fragment rendered="#{credentialEditBean.credentialData.id > 0 and credentialEditBean.original and not credentialEditBean.credentialData.archived}">
										<a href="#" class="linkRed" data-toggle="modal" data-target="#archiveModal">Archive</a> 
									</ui:fragment> 
									<ui:fragment rendered="#{credentialEditBean.credentialData.id > 0 and credentialEditBean.original and credentialEditBean.credentialData.archived}">
										<a href="#" data-toggle="modal" data-target="#restoreModal">Restore</a> 
									</ui:fragment>
									<ui:fragment rendered="#{credentialEditBean.credentialData.id > 0 and credentialEditBean.delivery}">
										<a href="#" class="linkRed" data-toggle="modal" data-target="#deleteModal">Delete</a>
									</ui:fragment> 
			                    </div>
			                </div>
        				</div>
		            
						<script>  
							var type = null;
							if('#{cc.attrs.role}' === "USER") {
								type = "user_created";
							} else {
								type = "university_created";
							}
							document.getElementById('#{cc.clientId}:formMain:hiddenType').value = type;
						
						</script>
					</div>
				</div>
			</h:form>

			<h:form id="formRemoveComp">
				<div class="modal fade" id="modalRemoveComp" tabindex="-1" role="dialog" aria-labelledby="removeCompetence">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&#215;</span></button>
								<h2 class="modal-title" id="removeCompetence1">Remove Competence?</h2>
							</div>
	
							<div class="modal-body">
								<p>Are you sure you want to remove this competence from credential?<br></br><br></br></p>
							</div>
			                   
							<div class="modal-footer">
								<p:commandLink
									value="Remove"
									styleClass="btn btn-red"
									process="@this"
									action="#{credentialEditBean.removeComp()}"
									update=":#{cc.clientId}:formMain:compList"
									oncomplete="$('#modalRemoveComp').modal('hide');">
								</p:commandLink>
								<a href="#" class="btn btn-default" data-dismiss="modal">Cancel</a>
							</div>
						</div>
					</div>
				</div>
			</h:form>
		   
	   </div>
	  
	  <dlg:archiveResource
    		id="archiveDialog"
			archiveActionMethodName="archive"  	
			archiveAction="#{credentialEditBean.archive}"
			toUpdate=":#{cc.clientId}:formMain #{cc.attrs.toUpdate}"
			title="Credential" 
			resourceType="credential"
			resourceTypePlural="credentials"
			learningContext="#{learningContext}"/>
					
	  <dlg:restoreResource
    		id="restoreDialog"
			restoreActionMethodName="restore"  	
			restoreAction="#{credentialEditBean.restore}"
			toUpdate=":#{cc.clientId}:formMain #{cc.attrs.toUpdate}"
			title="Credential" 
			resourceType="credential"
			resourceTypePlural="credentials"
			learningContext="#{learningContext}"/>
	  
	  <c:if test="#{credentialEditBean.original}">
		  <courses:startDelivery
		  		id="startDeliveryModal"
		  		credentialId="#{credentialEditBean.credentialData.id}"
		  		toUpdate=":#{cc.clientId}:formMain:growlMain"
		  		learningContext="#{learningContext}"
		  />
	  </c:if>
	  
	  <c:if test="#{credentialEditBean.delivery}">
	  	<courses:deleteModalDialog      
				deleteActionMethodName="delete"  	
				deleteAction="#{credentialEditBean.delete}"
				toUpdate=":#{cc.clientId}:formMain #{cc.attrs.toUpdate}" 
				modalDeleteTitle="Credential Delivery"
				modalDeleteText="credential delivery"/>
	  </c:if>
	  
	</composite:implementation>
</ui:component>