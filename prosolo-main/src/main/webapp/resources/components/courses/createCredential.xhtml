<ui:component
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:composite="http://java.sun.com/jsf/composite"
	xmlns:p="http://primefaces.org/ui"
	xmlns:comp="http://java.sun.com/jsf/composite/components"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:util="http://www.prosolo.com/util"
	xmlns:courses="http://java.sun.com/jsf/composite/components/courses"
	xmlns:dialogs="http://java.sun.com/jsf/composite/components/dialogs">

	<composite:interface>
		<composite:attribute name="role" type="java.lang.String" default="USER"/>
		<composite:attribute name="toUpdate" default=""></composite:attribute>
		<composite:attribute name="compAdded" type="java.lang.Boolean" default="false" />
	</composite:interface>
	
	<composite:implementation>
		<h:outputStylesheet name="bootstrap-datetimepicker.css" library="css2"/>
		<link rel="stylesheet" type="text/css" media="all" href="#{request.contextPath}/resources/css2/bootstrap-tagsinput.css" />
		<script src="#{request.contextPath}/resources/javascript2/bootstrap-tagsinput.min.js"></script>
		<script src="#{request.contextPath}/resources/javascript2/moment.min.js"></script>
		<script src="#{request.contextPath}/resources/javascript2/bootstrap-datetimepicker.min.js"></script>
		<script src="#{request.contextPath}/resources/javascript2/search.js"></script>
		<script src="#{request.contextPath}/resources/javascript2/createCredential.js"></script>
		<script src="#{request.contextPath}/resources/javascript2/tinymce/tinymce.min.js"></script>
	    <script src="#{request.contextPath}/resources/javascript2/prosolo.tinymce.js"></script>
	   
		<div class="whiteBar">
		
		</div>
		
		<div class="container">
	        <ol class="breadcrumb">
	            <li>
	            	<h:link value="Credentials" outcome="credentialLibrary"/>
	            </li>
	            <ui:fragment rendered="#{!credentialEditBean.isCreateUseCase()}">
	            	<li class="active">#{credentialEditBean.credentialData.title}</li>
	            </ui:fragment>
	            <ui:fragment rendered="#{credentialEditBean.isCreateUseCase()}">
	            	<li class="active">New Credential</li>
	            </ui:fragment>
	        </ol>
	    </div>
		
	   	<div id="#{cc.clientId}">
	   	<script>
			containerId = '#{cc.clientId}';
		</script>
		<h:form id="formMain">
			<p:growl id="growlMain" showDetail="true" globalOnly="true"></p:growl>
			<ui:param name="learningContext" value="#{credentialEditBean.decodedId > 0 ? 'name:CREDENTIAL|id:'.concat(credentialEditBean.decodedId) : ''}"></ui:param>
			<div class="container">
				<div class="row">
					<h:inputHidden id="hiddenType" value="#{credentialEditBean.credentialData.typeString}" />
					<div class="col-md-8">
						<div class="whiteBox">
							<ul class="nav nav-tabs pageSubmenu" role="tablist">
								<li role="presentation" class="#{!cc.attrs.compAdded ? 'active' : ''}"><a href="#info" aria-controls="info" role="tab" data-toggle="tab" onclick="setQueryParam('tab','info')">Credential Info</a></li>
								<li role="presentation" class="#{cc.attrs.compAdded ? 'active' : ''}"><a href="#competences" aria-controls="competences" role="tab" data-toggle="tab" onclick="setQueryParam('tab','competences')">Competences</a></li>
							</ul>
						</div>
						<div class="tab-content">
							<div role="tabpanel" class="tab-pane fade #{!cc.attrs.compAdded ? 'active in' : ''}" id="info">
								<div class="whiteBox">
									<h2>Credential Info</h2>
									
									<div class="formWrapper">
										<div class="formLine">
											<label>Title</label>
											<div class="formLineRight">
												<h:inputText 
													styleClass="pasteable"
													id="inputTitle" 
													value="#{credentialEditBean.credentialData.title}" 
													required="true"
													requiredMessage="Title is required"/>
												<h:panelGroup 
						                        	layout="block" 
						                        	rendered="#{not empty facesContext.getMessageList(cc.clientId.concat(':formMain:inputTitle'))}" 
						                        	styleClass="alert alert-danger" 
						                        	pt:role="alert">
						                            <h:message for="inputTitle"></h:message>
						                        </h:panelGroup>
											</div>
										</div>
										
										<div class="formLine">
											<label>About credential</label>
											<div class="formLineRight">                           
												<h:inputTextarea
													styleClass="pasteable"
													id="inputDescription" 
													value="#{credentialEditBean.credentialData.description}" />
													
												<script>
		                                    		initTinyMCE('#createCredential\\:formMain\\:inputDescription');
		                                    	</script>
											</div>
										</div>
										
										<div class="formLine">
											<label>Keywords</label>
											
											<div class="formLineRight">
												<h:inputText id="inputKeywords" styleClass="tagsInputCredTag"
													value="#{credentialEditBean.credentialData.tagsString}"
													pt:placeholder="Type and press 'Enter'"
													pt:data-role="tagsinput" />
											</div>
										</div>
										
										<script>$('.tagsInputCredTag').tagsinput();</script>
										
										<div class="formLine">
											<label>Twitter hashtags</label>
											
											<div class="formLineRight">
												<h:inputText id="inputHashtags" styleClass="tagsInputCredHahstag"
												value="#{credentialEditBean.credentialData.hashtagsString}"
												pt:placeholder="Type and press 'Enter'"
												pt:data-role="tagsinput" />
											</div>
										</div>
										<script>$('.tagsInputCredHahstag').tagsinput();</script>
										
										<div class="formLine">
		                                    <label>Other</label>
		                                    <div class="formLineRight">
		                                        <div class="checkbox checkLine">
													<h:selectBooleanCheckbox 
														id="checkMandatory"
														value="#{credentialEditBean.credentialData.mandatoryFlow}"
														onchange="showOrHideMandatoryArrows();">
													</h:selectBooleanCheckbox>
													
													<h:outputLabel for="checkMandatory">
														Mandatory flow
													</h:outputLabel>
												</div>
												<c:if test="#{cc.attrs.role eq 'MANAGER'}">
													<div class="checkbox checkLine">
														<h:selectBooleanCheckbox 
															id="checkAutomaticAssign"
															value="#{credentialEditBean.credentialData.automaticallyAssingStudents}">
														</h:selectBooleanCheckbox>
										                <h:outputLabel for="checkAutomaticAssign">
															Assign instructor to students automatically
														</h:outputLabel>
										            </div>
									            </c:if>
		                                    </div>
		                               </div>                      							
									</div>
								</div>
							</div>
				            
							<div role="tabpanel" class="tab-pane fade #{credentialEditBean.credentialData.mandatoryFlow ? 'mandatoryFlow' : ''} #{cc.attrs.compAdded ? 'active in' : ''}" id="competences">
								<courses:compList 
									id="compList"
									bean="#{credentialEditBean}"
									competences="#{credentialEditBean.credentialData.competences}"
									isEdit="true"
									startedLearning="false"
									toUpdate=""
									role="#{cc.attrs.role}"
									credentialId="#{credentialEditBean.id}"/>
			
								<ui:remove><h:panelGroup 
									rendered="#{credentialEditBean.credentialData.mandatoryFlow}" 
									layout="block" styleClass="mandatoryArrow">
								</h:panelGroup></ui:remove>
			                        
								<div class="newCompetenceBox">
									<div class="elementsWrapper">
										<p:commandLink
											styleClass="btn btn-green"
											value="Create New Competence"
											action="#{credentialEditBean.saveAndNavigateToCreateCompetence}" 
											oncomplete="if (args &amp;&amp; args.validationFailed) { $('##{cc.clientId}\\:formMain\\:hiddenLinkFailure').click();};">
											<f:param name="page" value="#{facesContext.viewRoot.viewId}"></f:param>
											<f:param name="learningContext" value="name:new_competence"></f:param>
										</p:commandLink>
										
										<p:commandLink style="display:none" id="hiddenLinkFailure"
					 							update=":#{cc.clientId}:formMain"
					 					/>
										<span>or</span>
		
										<div class="elementsRight">
											<p:remoteCommand name="execSearchComps" process="inputCompName"
												update=":#{cc.clientId}:formMain:panelCompSearchResults"
												action="#{credentialEditBean.searchCompetences()}">
												<f:param name="page" value="#{facesContext.viewRoot.viewId}"></f:param>
												<f:param name="learningContext" value="#{learningContext}"></f:param>
										    </p:remoteCommand>
											
											<h:inputText id="inputCompName"
												styleClass="competenceSearchField"
												value="#{credentialEditBean.compSearchTerm}"
												placeholder="Add existing one" 
												onclick="$(this).select();"
												onkeyup="showSearchResults('.panelCompSearchResultsSelector', '.competenceSearchField');searchIfNeeded('.competenceSearchField', execSearchComps);return false;">
											</h:inputText>
											
											<h:panelGroup id="panelCompSearchResults">
												<h:panelGroup rendered="#{not empty credentialEditBean.compSearchResults}">
													<ul class="dropdown-menu searchResultsDrop panelCompSearchResultsSelector" style="display:block;">
														<ui:repeat var="comp" value="#{credentialEditBean.compSearchResults}">
															<li>
																<p:commandLink
																	process="@this"
																	action="#{credentialEditBean.addComp(comp)}"
																	update=":#{cc.clientId}:formMain:compList :#{cc.clientId}:formMain:panelCompSearchResults"
																	oncomplete="$('.competenceSearchField').val(''); $('.panelCompSearchResultsSelector').first().stop(true, true).slideUp(10);">
																	<h3>#{comp.title}</h3>
																</p:commandLink>
															</li>
														</ui:repeat>
													</ul>
												</h:panelGroup>
											</h:panelGroup>
		
											<ui:remove><a href="#">Recommended Competences</a></ui:remove>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					
						<div class="col-md-4">
							<h:panelGroup layout="block" rendered="#{!credentialEditBean.createUseCase}" styleClass="whiteBox publishBox visibilityBox">
			                    <h2>Visibility</h2>
			                    <div class="clear"></div>
			                    <p>Visible only by you.</p>
			                    <p:commandLink
			                    	styleClass="btn btn-green-stroke" 
			                    	pt:data-toggle="modal" 
			                    	action="#{credentialEditBean.initVisibilityManageData()}"
			                    	update=":#{cc.clientId}:resourceVisibilityModal:formManageVisibility:panelManageVisibility"
			                    	oncomplete="$('#manageVisibility').modal('show');">
			                    	Manage Visibility
			                    </p:commandLink>
			                    
			                    <ui:remove>
				                    <p class="url">
				                        Public URL:<br></br>
				                        <a href="#">https://uta.prosolo.ca/prosolo/credentials/X7J62DA7</a>
				                    </p>
				                </ui:remove>
			                </h:panelGroup>
							
							<div id="noteDraft" class="alert alert-warning alert-dismissible" role="alert" style="#{credentialEditBean.credentialData.published ? 'display:none' : ''}">
			                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>
			                    Your credential is now <strong>Draft</strong>. In order for changes to be available to others, change status to <strong>Published</strong>.
			                </div>
							<div class="alert alert-info alert-dismissible" role="alert">
			                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>
			                    Note that all credential changes will affect all students currently learning for this credential.
			                </div>
							
							<courses:rightSideBar
								id="credSidebar"
								publishValues="#{credentialEditBean.courseStatusArray}" 
								publishValue="#{credentialEditBean.credentialData.status}"
								scheduledDateValue="#{credentialEditBean.credentialData.scheduledPublishDateValue}"
								scheduledDatePrettyString="#{credentialEditBean.credentialData.scheduledPublishDateStringView}"
								saveAction="#{credentialEditBean.save}"
								onclickSave="copyTextFromTinyMCEToTextarea('#createCredential\\:formMain\\:inputDescription');"
								cancelScheduledUpdateModal="cancelScheduledUpdate"
								toUpdate=":#{cc.clientId}:formMain #{cc.attrs.toUpdate}" 
								previewAction="#{credentialEditBean.preview}"
								linkPreviewClass="hiddenLinkPreview"
								resource="CREDENTIAL"
								role="#{cc.attrs.role}"
								resourceLowerCase="credential"
								childResourcePlural="competences"
								duplicateModal="#duplicateCred"
								archiveModal=""
								restoreModal=""
								archived="false"
								resourceId="#{credentialEditBean.credentialData.id}"
							/>
       		
							<h:link
								style="display: none;"
								styleClass="hiddenLinkPreview"
								target="_blank"
								outcome="credential">
								<f:param name="id" value="#{credentialEditBean.id}"></f:param>
								<f:param name="mode" value="preview"></f:param>
							</h:link>
        				</div>
		            
						<script>  
							var type = null;
							if('#{cc.attrs.role}' === "USER") {
								type = "user_created";
							} else {
								type = "university_created";
							}
							document.getElementById('#{cc.clientId}:formMain:hiddenType').value = type;
							
							$(function(){
								var tabParamValue = getQueryParam('tab');
								if(tabParamValue == 'competences'){
									$('.nav.nav-tabs.pageSubmenu a[href="#competences"]').tab('show');
								};
							})
						</script>
					</div>
				</div>
			</h:form>
		   
			<h:form id="formRemoveComp">
				<div class="modal fade" id="modalRemoveComp" tabindex="-1" role="dialog" aria-labelledby="removeCompetence">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&#215;</span></button>
								<h2 class="modal-title" id="removeCompetence1">Remove Competence?</h2>
							</div>
	
							<div class="modal-body">
								<p>Are you sure you want to remove this competence from credential?<br></br><br></br>
								<small>Note: Competence will not be deleted entirely. In order to do that, go to competence Edit > Delete.</small></p>
							</div>
			                   
							<div class="modal-footer">
								<p:commandLink
									value="Remove"
									styleClass="btn btn-red"
									process="@this"
									action="#{credentialEditBean.removeComp()}"
									update=":#{cc.clientId}:formMain:compList"
									oncomplete="$('#modalRemoveComp').modal('hide');">
								</p:commandLink>
								<a href="#" class="btn btn-default" data-dismiss="modal">Cancel</a>
							</div>
						</div>
					</div>
				</div>
			</h:form>
		   
			<courses:deleteModalDialog      
				deleteActionMethodName="delete"  	
				deleteAction="#{credentialEditBean.delete}"
				toUpdate=":#{cc.clientId}:formMain #{cc.attrs.toUpdate}" 
				modalDeleteTitle="Credential"
				modalDeleteText="credential"/>
				
			<dialogs:resourceVisibility
				id="resourceVisibilityModal"
				bean="#{credentialVisibilityBean}"
				resource="Credential"
				toUpdate=":#{cc.clientId}:formMain:growlMain"
				learningContext="#{learningContext}"
			/>
			
			<div class="modal fade" id="cancelScheduledUpdate" tabindex="-1" role="dialog" aria-labelledby="cancelScheduledUpdate">
		        <div class="modal-dialog" role="document">
		            <div class="modal-content">
		                <div class="modal-header">
		                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&#215;</span></button>
		                    <h2 class="modal-title" id="duplicateCredential">Cancel Scheduled #{credentialEditBean.credentialData.status eq 'SCHEDULED_UNPUBLISH' ? 'Un-' : ''}Publish</h2>
		                </div>
		                <div class="modal-body">
		                    <p>Are you sure you want to cancel scheduled #{credentialEditBean.credentialData.status eq 'SCHEDULED_UNPUBLISH' ? 'Un-' : ''}Publish</p>
		                </div>
		                <div class="modal-footer">
		                     <p:commandLink
		                     	styleClass="btn btn-green"
			                	action="#{credentialEditBean.cancelScheduledUpdate}"
			                	update=":#{cc.clientId}:formMain:credSidebar"
			                	oncomplete="$('#cancelScheduledUpdate').modal('hide');">
			                	<f:param name="page" value="#{facesContext.viewRoot.viewId}"></f:param>
			                	Cancel
			                 </p:commandLink>
		                    <a href="#" class="btn btn-default" data-dismiss="modal">Cancel</a>
		                </div>
		            </div>
		        </div>
    		</div>
    		
	   </div>
	   
	   <div class="modal fade" id="duplicateCred" tabindex="-1" role="dialog" aria-labelledby="duplicateCredential">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&#215;</span></button>
						<h2 class="modal-title" id="duplicateCredential">Duplicate Credential?</h2>
					</div>
					<div class="modal-body">
						<p>You will create a new credential with the same structure as the original one in terms of competences and activities. The new credential will be empty in terms of students, student results, comments and assessments.</p>
					</div>
					<div class="modal-footer">
						<p:commandLink styleClass="btn btn-green"
							value="Duplicate Credential"
							action="#{credentialEditBean.duplicate()}"
							process="@this">
							<f:param name="page" value="#{facesContext.viewRoot.viewId}" />
							<f:param name="learningContext" value="name:credential" />
						</p:commandLink>
						<a href="#" class="btn btn-default" data-dismiss="modal">Cancel</a>
					</div>
				</div>
			</div>
		</div>
	</composite:implementation>
</ui:component>