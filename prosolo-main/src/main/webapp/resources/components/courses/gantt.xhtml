<ui:component
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:composite="http://java.sun.com/jsf/composite"
	xmlns:p="http://primefaces.org/ui"
	xmlns:comp="http://java.sun.com/jsf/composite/components"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks">

	<!-- url: if data is restfully available. usually used for viewing or editing existing course. -->
	<!-- prepareAction: used when creating a new course and data is nor persisted yet -->

	<composite:interface>
		<composite:attribute name="url" type="java.lang.String"/>
		<composite:attribute name="prepareAction" type="java.lang.String"/>
		<composite:attribute name="courseBean"/>
		<composite:attribute name="data" type="java.lang.String"/>
		<composite:attribute name="changeHolder" type="java.lang.String"/>
		<composite:attribute name="updateOnRemoveCompetence" type="java.lang.String"/>
		<composite:attribute name="slideWidth" type="java.lang.Integer"/>
		<composite:attribute name="parentSelector" type="java.lang.String"/>
		<composite:attribute name="readOnly" type="java.lang.Boolean" default="false"/>
		<composite:attribute name="context" type="java.lang.String"/>
	</composite:interface>
	
	<composite:implementation>
		<script type="text/javascript" src="#{request.contextPath}/resources/javascript/ganttView/jquery.ganttView.custom.js"></script>
		<link rel="stylesheet" type="text/css" href="#{request.contextPath}/resources/css/jquery.ganttView.custom.css" />
		
		<script type="text/javascript">
			function initializeGantt() {
				$('#{cc.attrs.parentSelector} .courseGanttChart').html('<img src="#{request.contextPath}/resources/images/style/ajax-loader-black.gif" class="loader" style="vertical-align:middle;"/>');
	
				$('#{cc.attrs.prepareAction}').trigger('click');
				$('#{cc.attrs.parentSelector} .courseGanttChart .loader').remove();
			};
			
			function drawGantt() {
				var ganttSettings = { 
					data: data,
					slideWidth: #{cc.attrs.slideWidth},
					fixedDuration: 120,
					legendContainer: '#{cc.attrs.parentSelector} .legend', 
				};
				
				if (!#{cc.attrs.readOnly}) {
					ganttSettings.behavior = {
						clickable: true,
		            	draggable: true,
		            	resizable: true,
						onResize: function (data) {
							$('#{cc.attrs.parentSelector} .changeHolderContainer input').val(data.id+','+data.start+','+data.duration);
							$('#{cc.attrs.parentSelector} .changeHolderContainer .resize').trigger('click');
						},
						onDrag: function (data) { 
							$('#{cc.attrs.parentSelector} .changeHolderContainer input').val(data.id+','+data.start+','+data.duration);
							$('#{cc.attrs.parentSelector} .changeHolderContainer .resize').trigger('click');
						}
					};
				}
				
				$('#{cc.attrs.parentSelector} .courseGanttChart').ganttView(ganttSettings);
			}
		</script>
		
		<div class="changeHolderContainer hidden">
			<h:inputText value="#{cc.attrs.changeHolder}" id="changeHolder" class="changeHolder" />
			
			<p:commandLink styleClass="resize" action="#{cc.attrs.courseBean.updateChanges}" />
				
			<link:competence
				styleClass="openCompetenceDialog"
				resourceId="#{cc.attrs.changeHolder}"
				type="Competence"
				context="#{cc.attrs.context}" />
			
			<p:commandLink styleClass="removeCompetence"
				action="#{cc.attrs.courseBean.removeCompetence(cc.attrs.courseBean.course, cc.attrs.changeHolder)}"
				update="ganttContainer #{cc.attrs.updateOnRemoveCompetence}"
			/>
		</div>
		
		
		<h:panelGroup layout="block" id="ganttContainer">
			<div class="legend"></div>
			<div class="clear"></div>
			
			<div class="courseGanttChart"></div>
			
			<script type="text/javascript">
				var data = '';
				try{
					data = $.parseJSON('<h:outputText value="#{cc.attrs.data}" escape="false" />');
				}catch(e){ }
	
				drawGantt();
				
				// convert names to links and add remove link
				$('#{cc.attrs.parentSelector} .ganttview-vtheader-item .ganttview-vtheader-item-name').each(function(){
					var text = $(this).text();
					
					var itemParent =  $(this).parents('.ganttview-vtheader-item');
					var predefined = false;
					
					if (itemParent.attr('predefined') == 'true') {
						predefined = true;
					}
					$(this).html((predefined ? '' : (#{cc.attrs.readOnly} ? '' : '<span class="iconRemove"></span>'))+'<a class="titleLink" href="#">'+text+'</a>');
				});
				
				// attach events
				$('#{cc.attrs.parentSelector} .ganttview-vtheader-item-name .titleLink').on('click', function(){
					$('#{cc.attrs.parentSelector} .changeHolderContainer input').val($(this).parents('.ganttview-vtheader-item').attr('dataid'));
					$('#{cc.attrs.parentSelector} .openCompetenceDialog').trigger('click');
					return false;
				});
				
				if (!#{cc.attrs.readOnly}) {
					$('#{cc.attrs.parentSelector} .ganttview-vtheader-item:not([predefined=true]) .ganttview-vtheader-item-name .iconRemove').on('click', function(){
						$('#{cc.attrs.parentSelector} .changeHolderContainer input').val($(this).parents('.ganttview-vtheader-item').attr('dataid'));
						$('#{cc.attrs.parentSelector} .removeCompetence').trigger('click');
						return false;
					});
				}
			</script>
		</h:panelGroup>
		
	</composite:implementation>
</ui:component>