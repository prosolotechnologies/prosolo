<ui:component
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:composite="http://java.sun.com/jsf/composite"
	xmlns:p="http://primefaces.org/ui"
	xmlns:dlg="http://java.sun.com/jsf/composite/components/dialogs"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:icon="http://java.sun.com/jsf/composite/components/resourceLinks/icons"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	template="templates/masterLayout.xhtml"
	xmlns:util="http://www.prosolo.com/util">

	<composite:interface>
		<composite:attribute name="role" type="java.lang.String" default="USER"/>
		<composite:attribute name="newCoursePagePath" type="java.lang.String" />
		<composite:attribute name="courseDetailsPagePath" type="java.lang.String" />
	</composite:interface>
	
	<composite:implementation>
		<utilcomp:messagesBundle var="msg" />
		
		<h:outputScript library="javascript" name="readmore.custom.js" target="head" />
	
		<script type="text/javascript">
			$(function() {
				var query = "#{param['query']}";
				
				$('form.filteredSearch .inputContainer.objSearch .searchInput').val("#{param['query']}");
				$('form.filteredSearch .inputContainer.objSearch .searchInput').next('input').val("#{param['query']}");
				searchControl.executeSearch();
			});
			
			var searchControl = {
				addLoaderToSearchContainer: function () {
					$('form.filteredSearch .resultContainer')
						.css('text-align', 'center')
						.css('padding-top', '50px')
						.html('<img src="#{request.contextPath}/resources/images/style/ajax-loader-black.gif" style="vertical-align:middle;"/>');
				},
				updateUrlQuery: function (){
					setQueryParam('query', $('form.filteredSearch .inputContainer.objSearch .searchInput').val());
				},
				updateUrlKeywords: function (){
					setQueryParam('keywords', $('form.filteredSearch .inputContainer.keywordFilter .searchInput').val());
				},
				executeSearch: function (){
					$('form.filteredSearch .search.button').trigger('click');
				},
				keystrokeTimeout: null,
				searchListener: function () {
					var $this = this;
					this.updateUrlQuery(); 
					
					var delayedSearch = function(){
						$('form.filteredSearch .inputContainer.objSearch .searchInput').next('input').val($('form.filteredSearch .inputContainer.objSearch .searchInput').val());
						$this.executeSearch();
					};
	
					window.clearTimeout(this.keystrokeTimeout);
					this.keystrokeTimeout = window.setTimeout(delayedSearch, 350);
				},
			};
		</script>
	
		<div class="content wide search">
			<h:form id="courseSearchForm" class="filteredSearch">
				<p:growl id="growl" showDetail="true" />
			
				<h2>#{msg['composite.browseCourses.title.browseCourses']}</h2>
			
				<div class="right">
					<p:commandLink styleClass="button blue size25 right search" value="Search"
						onclick="searchControl.addLoaderToSearchContainer(); searchControl.updateUrlQuery();"
						actionListener="#{searchCoursesBean.searchAllCourses()}"
						update=":#{cc.clientId}:courseSearchForm:resultContainer">
						<f:param name="role" value="#{cc.attrs.role}" />
					</p:commandLink>
					
					<div class="inputContainer objSearch">
						<div class="mGlass"></div>
	  						<h:inputText size="20" class="searchInput"
						  		onclick="$(this).select();" 
						  		onkeydown="searchControl.searchListener();" />
					  		
					  	<h:inputHidden class="searchInputHidden" value="#{searchCoursesBean.query}" />
					  		
				  		<script>
							$('form.filteredSearch .inputContainer.objSearch .searchInput').attr("placeholder", "#{msg['composite.browseCourses.search.placeholder']}");
						</script>
					</div>
				</div>
	
				<div class="clear"></div>
				
				<div class="right">
					<span class="marginRight10 middleAlign">Filter by keywords:</span>
					
					<h:panelGroup layout="block" id="keywords" class="keywords">
						<div class="inputContainer keywordFilter">
							<ui:repeat value="#{searchCoursesBean.filterTags}" var="keyword" id="filterKeywords">
								<span class="keywordItem">
									<span class="name">#{keyword.title}</span>
									<p:commandLink styleClass="remove"
										actionListener="#{searchCoursesBean.removeFilterTag(keyword)}"
										action="#{searchTagsBean.resetSearchResults()}"
										update=":#{cc.clientId}:courseSearchForm"
										oncomplete="searchControl.executeSearch();"
					    			/>
								</span>
							</ui:repeat>
							
							<div class="searchInputContainer">
		   						<h:inputText size="20" class="searchInput"
						    		autocomplete="off"
							  		onclick="$(this).select();" 
									valueChangeListener="#{searchTagsBean.searchListener}">
									<f:ajax	render="keywordSearchResultPanel"
										execute="@this" event="keyup" />
						  		</h:inputText>
						  		
								<h:panelGroup layout="block" id="keywordSearchResultPanel">
									<h:panelGroup layout="block" styleClass="results" rendered="#{not empty searchTagsBean.tags}">
								
										<ui:repeat value="#{searchTagsBean.tags}" var="keyword" id="foundKeywordList">
											<p:commandLink
												styleClass="resultContainer"
												action="#{searchCoursesBean.addFilterTag(keyword)}"
												oncomplete="$('.admin .keywords .results').fadeOut();$('.admin .filteredSearch .inputContainer.keywordFilter .searchInput').val('');"
								    			update=":#{cc.clientId}:courseSearchForm:keywords">
								    			
												<div class="result">
													<div class="infoContainer" style="float: left">
														<div class="title">#{keyword.title}</div>
													</div>
												</div>
											</p:commandLink>
											
											<div class="clear"></div>
										</ui:repeat>
									</h:panelGroup>
								</h:panelGroup>
							</div>
						  		
						  	<h:inputHidden class="searchInputHidden" value="#{searchTagsBean.query}" />
						</div>
					</h:panelGroup>
					
					<script>
					$(function() {
						$('.admin .filteredSearch .keywordFilter').on('click', function(e) {
							$(this).find('.searchInput').focus();
						});
						$(document).on('click', function(){
							$('.admin .keywords .results').fadeOut();
						});
					});
					</script>
				</div>
	
				<h:link styleClass="left button green size30 marginBottom10"
					rendered="#{cc.attrs.role == 'MANAGER'}"
					value="#{msg['composite.browseCourses.button.newCourse']}"
					outcome="#{cc.attrs.newCoursePagePath}" />
					
				<p:commandLink styleClass="left button green size30 marginBottom10"
					rendered="#{cc.attrs.role == 'MANAGER'}"									
					oncomplete="$('#restoreCourseDialog').dialog('open');"
					update=":#{cc.clientId}:restoreCourseDialogForm"
					value="Restore" />
				
				<div class="separator clear"></div>
			
				<h:panelGroup layout="block" class="resultContainer" id="resultContainer">
					<div class="marginTop10">
						<span class="marginRight10">Sorting:</span>
					
						<p:commandLink styleClass="titleSort marginRight10"
							rendered="#{!searchCoursesBean.sortTitleAsc}"
							action="#{searchCoursesBean.changeTitleSorting(true)}"
							update="resultContainer">
							Title <span class="upArrow dark inlineBlock"></span>
						</p:commandLink>
						<p:commandLink styleClass="titleSort marginRight10"
							rendered="#{searchCoursesBean.sortTitleAsc}"
							action="#{searchCoursesBean.changeTitleSorting(false)}"
							update="resultContainer">
							Title <span class="downArrow dark inlineBlock"></span>
						</p:commandLink>
						
						<p:commandLink styleClass="dateSort"
							rendered="#{!searchCoursesBean.sortDateAsc}"
							action="#{searchCoursesBean.changeDateSorting(true)}"
							update="resultContainer">
							Date <span class="upArrow dark inlineBlock"></span>
						</p:commandLink>
						<p:commandLink styleClass="dateSort"
							rendered="#{searchCoursesBean.sortDateAsc}"
							action="#{searchCoursesBean.changeDateSorting(false)}"
							update="resultContainer">
							Date <span class="downArrow dark inlineBlock"></span>
						</p:commandLink>
					</div>
				
					<h:panelGroup class="noContentMessage" rendered="#{empty searchCoursesBean.courses}">
						#{msg['manager.courseBrowse.noCoursesMessage']}
					</h:panelGroup>
				
					<ui:repeat value="#{searchCoursesBean.courses}" var="courseData" id="objList" varStatus="iterator">
						<div class="box course#{courseData.id}">
							<div class="avatar">
								<icon:course styleClass="icon" />
							</div>
							
							<div class="textWrapper">
								<span class="title">
									<h:link value="#{courseData.title}" 
										onclick="sendLogPageNavigationWithParameters('credentials', {context: 'plan.browse.#{courseData.id}.title', courseId: #{courseData.id}});"
										outcome="#{cc.attrs.courseDetailsPagePath}">
										<f:param name="id" value="#{util:encodeId(courseData.id)}" />
									</h:link>
								</span>
								<div class="clear"></div>
								
								<h:panelGroup layout="block"
									rendered="#{courseData.description != null and courseData.description != ''}"
									class="message">"#{courseData.description}"</h:panelGroup>
								
								<div class="clear"></div>
								
								<h:panelGroup layout="block" class="user">
									<span class="bold">Creator:</span>
									
									<h:panelGroup rendered="#{courseData.creatorType == 'MANAGER'}">
										Organizational
									</h:panelGroup>
									
									<h:panelGroup rendered="#{courseData.creatorType == 'USER'}">
										<link:user value="userDetailsImage" 
						    				user="#{courseData.creator}"
						    				mode="imageName"
						    				imageSize="22"
						    				idPrefix="objSearchCreator#{iterator.index}" 
						    				context="courses.imageName"/>
									</h:panelGroup>
								</h:panelGroup>
								<div class="clear"></div>
								
								<h:panelGroup layout="block" class="user">
									<span class="bold">Members: </span>
									
									 <h:link id= "linkMembers" 
									 	rendered="#{not empty courseData.memberIds}"
										value="#{courseData.memberIds.size()} people" 
										outcome="/manage/studentList.xhtml">
										<f:param name="id" value="#{util:encodeId(courseData.id)}" />
										<f:param name="courseName" value="#{courseData.title}" />
									</h:link>
									
									<h:outputText rendered="#{empty courseData.memberIds}"
										value="0 people" />
								   
								</h:panelGroup>
								<div class="clear"></div>
								
								<h:panelGroup layout="block" class="user" rendered="#{cc.attrs.role == 'MANAGER'}">
									<span class="bold">Published: </span>
									
									#{courseData.published}
								</h:panelGroup>
								<div class="clear"></div>
								
								<h:panelGroup layout="block" class="user">
									<span class="left bold">Keywords:</span>
									
									<h:panelGroup rendered="#{empty courseData.tags}" class="noContentMessage">
										&#160;No keywords
									</h:panelGroup>
									
									<ui:repeat value="#{courseData.tags}" var="keyword" varStatus="iterator">
										<p:commandLink styleClass="keywordItem actionalble"
											actionListener="#{searchCoursesBean.addFilterTag(keyword)}"
											action="#{searchCoursesBean.searchAllCourses()}"
							    			update=":#{cc.clientId}:courseSearchForm"
							    			oncomplete="$('.admin .keywords .results').hide();">

							    			<f:param name="role" value="#{cc.attrs.role}" />
							    			
											<span class="name">#{keyword.title}</span>
										</p:commandLink>
									</ui:repeat>
								</h:panelGroup>
								
								<div class="clear"></div>
								
								<div class="links">
									<h:link class="button green size20 left"
										rendered="#{cc.attrs.role == 'MANAGER'}"
										value="Edit" outcome="/manage/course">
										<f:param name="id" value="#{util:encodeId(courseData.id)}" />
									</h:link>
									
									<p:commandLink styleClass="button green size20 left"
										rendered="#{cc.attrs.role == 'MANAGER'}"
										action="#{manageCourseBackupsBean.setCourseToBackup(courseData)}"
										oncomplete="$('#backupCourseDialog').dialog('open');"
										update=":#{cc.clientId}:backupCourseDialogForm"
										value="Backup" />
									
									<p:commandLink styleClass="button red size20 left"
										rendered="#{cc.attrs.role == 'MANAGER' and empty courseData.memberIds}"
										action="#{manageCourseBean.setCourseToDelete(courseData, 'manager.courses'.concat(courseData.id))}"
										oncomplete="$('#deleteCourseDialog').dialog('open');"
										update=":#{cc.clientId}:deleteCourseDialogForm"
										value="Delete" />
										
									<p:commandLink styleClass="button disabled gray size20 left hasTooltip"
										rendered="#{cc.attrs.role == 'MANAGER' and not empty courseData.memberIds}"
										title="#{msg['composite.browseCourses.button.delete.disabled.tooltip']}"
										value="Delete" />
										
									<h:link class="button green size20 left"
										rendered="#{cc.attrs.role == 'USER'}"
										onclick="sendLogPageNavigationWithParameters('course', { context: 'plan.browse.#{courseData.id}.details', 'courseId' : '#{courseData.id}'});" 
										value="Details" outcome="#{cc.attrs.courseDetailsPagePath}">
										<f:param name="id" value="#{util:encodeId(courseData.id)}" />
									</h:link>
								</div>
							</div>
							
							<div class="date">Created: #{courseData.dateCreatedPretty}</div>
			            </div>
						
						<div class="separator clear"></div>
					</ui:repeat>
					
					<p:commandLink id="loadMore" rendered="#{searchCoursesBean.moreToLoad}" styleClass="loadMore"
						actionListener="#{searchCoursesBean.loadMore}"
						update=":#{cc.clientId}:courseSearchForm">
						<f:param name="role" value="#{cc.attrs.role}" />
						
						<h:outputText value="SHOW MORE" />
					</p:commandLink>
					
					<script type="text/javascript">
					$('form.filteredSearch .box .message').readmore({maxHeight: 40});
					
					$(function() {
						roundImages();
						
						$('form.filteredSearch .loadMore').on('click', function() {
							return false;
						});
						
						var input = $('form.filteredSearch .inputContainer .searchInput');
						input[0].selectionStart = input[0].selectionEnd = input.val().length;
						
						$('form.filteredSearch .resultContainer').fadeIn();
					});
					</script>
					
					<utilcomp:tooltip target=".hasTooltip[title]" />
				</h:panelGroup>
			</h:form>
		</div>
		
		<div id="deleteCourseDialog" class="deleteCourseDialog" style="display: none;">
			<h:form id="deleteCourseDialogForm" prependId="false">
				<p:growl id="deleteCourseDialogGrowl" showDetail="true" />
				
				<h4 class="warningMessage">#{msg['composite.browseCourses.dialog.deleteCourse.message']} '#{manageCourseBean.courseToDelete.title}'?</h4>
				<br/><br/>
		
				<p:commandLink value="Delete"
					styleClass="button green size30 right"
					onclick='$("#deleteCourseDialog").dialog("close");'
				 	action="#{manageCourseBean.deleteCourse()}"
				 	update=":#{cc.clientId}:courseSearchForm" />
		
				&#160;
				<a class="button gray size30 right" onclick='$("#deleteCourseDialog").dialog("close");'>Cancel</a>
	    	</h:form>
		</div>
		
		<div id="backupCourseDialog" class="backupCourseDialog" style="display: none;">
			<h:form id="backupCourseDialogForm" prependId="false">
				<p:growl id="backupCourseDialogGrowl" showDetail="true" />
				
				<p><strong>#{manageCourseBackupsBean.courseToBackup.title}</strong></p>
				
				<h:panelGrid columns="2" columnClasses="backupSettingsFirstColumn, backupSettingsSecondColumn">
					<h:outputText value="Include competences:" />
					<p:selectBooleanCheckbox value="#{manageCourseBackupsBean.includeCompetences}" /> 
					<h:outputText value="Include activities:" />
					<p:selectBooleanCheckbox value="#{manageCourseBackupsBean.includeActivities}" /> 
					<h:outputText value="Include files:" />
					<p:selectBooleanCheckbox value="#{manageCourseBackupsBean.includeFiles}" /> 
					<h:outputText value="Include keywords:" />
					<p:selectBooleanCheckbox value="#{manageCourseBackupsBean.includeKeywords}" /> 
				</h:panelGrid>
				 
				<br/>
				<p:commandLink value="Backup"
					styleClass="button green size30 right"
					onclick='$("#backupCourseDialog").dialog("close");'
				 	action="#{manageCourseBackupsBean.backupCourse()}"
				 	update=":#{cc.clientId}:courseSearchForm" />
		
				&#160;
				<a class="button gray size30 right"
					onclick='$("#backupCourseDialog").dialog("close");'>Cancel</a>
	    	</h:form>
		</div>
		
		
		<div id="restoreCourseDialog" class="restoreCourseDialog" style="display: none;">
			<h:form id="restoreCourseDialogForm" prependId="false">
			
			<p:growl id="restoreCourseDialogGrowl" showDetail="true" />
			
			<h:dataTable value="#{manageCourseBackupsBean.courseBackups}"  var="courseBackup"  columnClasses="firstBackupColumn,secondBackupColumn, thirdBackupColumn, fourthBackupColumn">
				<h:column>
			 		<f:facet name="header">Filename</f:facet>
			 		#{courseBackup.filename}
			 	</h:column>
			 	<h:column>
			 		<f:facet name="header">Download</f:facet>
			 		<h:outputLink styleClass="atcUrl webPageLink" target="_blank" value="#{courseBackup.link}">
						Download
					</h:outputLink>
			 	</h:column>
			 	<h:column>
			 		<f:facet name="header">Delete</f:facet>
			 		<p:commandLink value="Delete"
						action="#{manageCourseBackupsBean.deleteCourseBackup(courseBackup)}"
				 		update=":#{cc.clientId}:restoreCourseDialogForm" >
				 		<f:ajax event="click"></f:ajax>
				 		</p:commandLink>
			 	</h:column>
			 	<h:column>
			 		<f:facet name="header">Restore</f:facet>
			 		<p:commandLink value="Restore"
						action="#{manageCourseBackupsBean.restoreCourseBackup(courseBackup)}"
						oncomplete='$("#restoreCourseDialog").dialog("close");'
				 		update=":browseCourses:courseSearchForm" >
				 		<f:ajax event="click" ></f:ajax>
				 		</p:commandLink>
			 	</h:column>
			</h:dataTable>
		 
			<p:commandLink value="Upload external file"
				onclick="$('.backupUploadContainer .ui-fileupload input').trigger('click');"
				styleClass="button blue size20 right"
			 	update=":#{cc.clientId}:restoreCourseDialogForm"/>
		 
	    	</h:form>
	    	<h:form id="backupUploadForm" prependId="false" enctype="multipart/form-data">
				 <p:messages id="backupUploadFormMessages" showDetail="true" closable="false" />
			
				<div class="backupUploadContainer hidden">
					<p:fileUpload value="#{manageCourseBackupsBean.file}"
						fileUploadListener="#{manageCourseBackupsBean.handleBackupFileUpload}"
						mode="advanced" 
						auto="true" 
						immediate="true" 
						sizeLimit="1000000"
						update=":#{cc.clientId}:restoreCourseDialogForm"
						allowTypes="/(\.|\/)(zip)$/"/>
				</div>
			</h:form>
		</div>
		 
		<script>
		$(function() {
			$('#deleteCourseDialog').dialog({
				title: "#{msg['composite.browseCourses.dialog.deleteCourse.title']}",
				dialogClass: 'warning',
				autoOpen: false,
				show : 'slide',
				width: 400,
				modal: true,
				resizable: false,
				open: function() {
					$(this).parent()
			        .children('.ui-dialog-titlebar')
			        .prepend('<span class="warningIcon"></span>');
				}
			});
			$('#deleteCourseDialog').show();

			$('#backupCourseDialog').dialog({
				title: 'Backup settings',
				 autoOpen: false,
				show : 'slide',
				width: 400,
				modal: true,
				resizable: false,
				open: function() {
					$(this).parent()
			        .children('.ui-dialog-titlebar');
				}
			});
			$('#backupCourseDialog').show();

			$('#restoreCourseDialog').dialog({
				title: 'Available backups',
				 autoOpen: false,
				show : 'slide',
				width: 400,
				modal: true,
				resizable: false,
				open: function() {
					$(this).parent()
			        .children('.ui-dialog-titlebar');
				}
			});
			$('#restoreCourseDialog').show();
		});
		</script>
	
	</composite:implementation>
</ui:component>