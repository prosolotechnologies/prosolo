<ui:component
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:composite="http://java.sun.com/jsf/composite"
	xmlns:comp="http://java.sun.com/jsf/composite/components"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:post="http://java.sun.com/jsf/composite/components/post"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:courses="http://java.sun.com/jsf/composite/components/courses"
	xmlns:socialWall="http://java.sun.com/jsf/composite/components/socialWall"
	xmlns:util="http://www.prosolo.com/util">

	<composite:interface>
		<composite:attribute name="activity" required="true" />
		<composite:attribute name="bean" required="true" />
		<composite:attribute name="isPreview" required="true" type="java.lang.Boolean" />
		<composite:attribute name="learningContext" required="true" />
	</composite:interface>
	
	<composite:implementation>
		<div id="#{cc.clientId}">
			<p:growl id="growlDetails" globalOnly="true" showDetail="true" />
			
            <ui:fragment rendered="#{cc.attrs.activity.activityType == 'VIDEO'}">
				<div class="activityMain">
					<socialWall:youtubevideopreview
						embedId="#{cc.attrs.activity.embedId}"
						width="731"
						height="413"
						context="#{cc.attrs.learningContext}"/>
				</div>
			</ui:fragment>
			
			<ui:fragment rendered="#{cc.attrs.activity.activityType == 'SLIDESHARE'}">
				<iframe src="#{cc.attrs.activity.embedId}"
					width="731" height="413" frameborder="0"
					marginwidth="0" marginheight="0" scrolling="no"
					style="border: 1px solid #CCC; border-width: 1px 1px 0; margin-bottom: 5px">
				</iframe>
			</ui:fragment>
			
			<ui:fragment rendered="#{cc.attrs.activity.activityType == 'EXTERNAL_TOOL'}">
				<ui:fragment rendered="#{!cc.attrs.activity.openInNewWindow}">
					<h:link 
						style="display:none;"
						value="Load"
						styleClass="linkLoadExternalActivity"
						outcome="/lti" 
						target="extActivityFrame"
						onclick="sendLogPageNavigationWithParameters('/lti', {});">
						<f:param name="launchUrl" value="#{cc.attrs.activity.launchUrl}"/>
						<f:param name="sharedSecret" value="#{cc.attrs.activity.sharedSecret}"/>
						<f:param name="consumerKey" value="#{cc.attrs.activity.consumerKey}"/>
						<f:param name="targetActivityId" value="#{cc.attrs.activity.targetActivityId}"/>
						<f:param name="activityId" value="#{cc.attrs.activity.activityId}"/>
						<f:param name="title" value="#{cc.attrs.activity.title}"/>
						<f:param name="description" value="#{cc.attrs.activity.description}"/>
						<f:param name="contextName" value="#{cc.attrs.activity.competenceName}"/>
					</h:link>
				
					<iframe name="extActivityFrame"
						width="731" height="413" frameborder="0"
						marginwidth="0" marginheight="0" scrolling="yes"
						style="border: 1px solid #CCC; border-width: 1px 1px 0; margin-bottom: 5px">
					</iframe>
					
					<script>
					$(function(){
						document.getElementsByClassName("linkLoadExternalActivity")[0].click();
					});
					</script>
				</ui:fragment>
			
				<ui:fragment rendered="#{cc.attrs.activity.openInNewWindow}">
					<h:outputScript library="javascript" name="oauth.js" target="head" />
					<h:outputScript library="javascript" name="sha1.js" target="head" />
					<h:outputScript library="javascript" name="prosolo.lti.js" target="head" />
					
					<form action="#{cc.attrs.activity.launchUrl}" name="ltiLaunchForm" target="_blank" 
						onsubmit="form.removeChild(document.getElementById('javax.faces.ViewState'))" method="post" 
						enctype="application/x-www-form-urlencoded">
							<input type="hidden" name="context_id" value="#{cc.attrs.activity.targetActivityId}" />
							<input type="hidden" name="context_label" value="#{cc.attrs.activity.competenceName}" />
							<input type="hidden" name="context_title" value="#{cc.attrs.activity.competenceName}" />
							<input type="hidden" name="lti_message_type" value="basic-lti-launch-request" />
							<input type="hidden" name="tool_consumer_instance_guid" value="prosolo.ca" />
							<input type="hidden" name="tool_consumer_instance_description" value="ProSolo" />
							<input type="hidden" name="lti_version" value="LTI-1p0" />
							<input type="hidden" name="resource_link_id" value="#{cc.attrs.activity.activityId}" />
							<input type="hidden" name="resource_link_title" value="#{cc.attrs.activity.title}" />
							<input type="hidden" name="resource_link_description" value="#{cc.attrs.activity.description}" />
							<input type="hidden" name="user_id" value="#{loggeduser.userId}" />
							<input type="hidden" name="lis_outcome_service_url" value="#{applicationbean.domain}api/lti/replaceresult" />
							<input type="hidden" name="lis_person_name_full" value="#{loggeduser.name} #{loggeduser.lastName}" />
							<input type="hidden" name="lis_person_name_family" value="#{loggeduser.lastName}" />
							<input type="hidden" name="lis_person_name_given" value="#{loggeduser.name}" />
							<input type="hidden" name="lis_person_contact_email_primary" value="#{loggeduser.email}" />
							<input type="hidden" name="tool_consumer_instance_url" value="#{applicationbean.domain}" />
							<input type="hidden" name="lis_result_sourcedid"  value="#{loggeduser.userId}::#{cc.attrs.activity.activityId}::#{cc.attrs.activity.targetActivityId}" />
							<input type="hidden" name="oauth_version" value="1.0" />
							<input type="hidden" name="oauth_consumer_key" value="#{cc.attrs.activity.consumerKey}" />
							<input type="hidden" name="oauth_callback" value="about:blank" />
							<input type="hidden" name="oauth_signature" value="blahs" />
							<input type="hidden" name="launch_presentation_locale" value="en-US" />
							<input type="hidden" name="oauth_nonce" value="0" />
							<input type="hidden" name="oauth_timestamp" value="0" />
							<input type="hidden" name="roles" value="#{activityViewBean.roles}" />
							<input type="hidden" name="oauth_signature_method" value="HMAC-SHA1" />            
							<input type="hidden" name="ltiLaunchForm" value="" />
							<input type="button" hidden="true" onclick="doOnLoad('#{cc.attrs.activity.sharedSecret}','#{cc.attrs.activity.launchUrl}',this.form)" 
								id="submitLTILaunchFormButton" name="submit_form_button" class="hidden" value="Launch external tool" />
					</form>
					
					<ul class="whiteBox activityLinksBox">
	                    <li>
							<div class="actBoxLeft noUrl">
	                            <h3>External Tool</h3>
	                        </div>
	                        <a href="javascript:void(0)" onclick="$('#submitLTILaunchFormButton').click()" class="btn btn-green btn-sm">Open</a>
	                    </li>
	                </ul>
				</ui:fragment>
				
			</ui:fragment>
           
            <ui:fragment rendered="#{not empty cc.attrs.activity.description}">
            	<p>#{cc.attrs.activity.description}</p>
            </ui:fragment>
            
            <h:panelGroup layout="block" rendered="#{cc.attrs.activity.activityType == 'TEXT'}" styleClass="whiteBox activityTextBox">
				<h:outputText escape="false" value="#{cc.attrs.activity.text}"/>
            </h:panelGroup>
            
            <ui:fragment rendered="#{cc.attrs.activity.activityType != 'EXTERNAL_TOOL'}">
	            <ul class="whiteBox activityLinksBox">
	            	<ui:repeat var="link" value="#{cc.attrs.activity.links}">
	            		<li>
		                    <div class="actBoxLeft">
		                        <h3>#{link.linkName}</h3>
		                        <span>#{link.url}</span>
		                    </div>
		                    <a href="#{link.url}" 
	                    		target="_blank" 
	                    		class="btn btn-green btn-sm"
	                    		onclick="sendLogPageNavigation('#{link.url}', 
	                    				'#{facesContext.viewRoot.viewId}', 
	                    				'#{util:addSubContext(cc.attrs.learningContext, &#34;name:activity_link|id:&#34;.concat(link.id))}', 
	                    				null);">
	                    		Open
		                    </a>
		                </li>
	            	</ui:repeat>    
	            </ul>
	            <ul class="whiteBox activityFilesBox">
	            	<ui:repeat var="file" value="#{cc.attrs.activity.files}">
	            		<li>
		                    <div class="actBoxLeft">
		                        <h3>#{file.linkName}</h3>
		                        <span>#{file.linkName}</span>
		                    </div>
		                    <a href="#{file.url}" 
		                    	target="_blank" 
		                    	class="btn btn-green btn-sm"
		                    	onclick="sendLogPageNavigation('#{file.url}', 
	                    				'#{facesContext.viewRoot.viewId}', 
	                    				'#{util:addSubContext(cc.attrs.learningContext, &#34;name:activity_file|id:&#34;.concat(file.id))}', 
	                    				null);">
		                    	Download
		                    </a>
		                </li>
	            	</ui:repeat>    	             
	            </ul>
	        </ui:fragment>
            <h:panelGroup id="panelUploadAssignment" rendered="#{cc.attrs.activity.enrolled and cc.attrs.activity.uploadAssignment}">
            	<ui:fragment rendered="#{not empty cc.attrs.activity.assignmentLink}">
            		<h2>Your Result</h2>
	                <ul class="whiteBox activityResultBox">
	                    <li>
	                        <div class="actBoxLeft">
	                            <h3>#{cc.attrs.activity.assignmentTitle}</h3>
	                            <a href="#" class="deleteLink linkRed" data-toggle="modal" data-target="#deleteModal">Delete</a>
	                        </div>
	                        <a href="#{cc.attrs.activity.assignmentLink}" target="_blank" class="btn btn-green btn-sm">Download</a>
	                    </li>
	                </ul>
            	</ui:fragment>
            	<ui:fragment rendered="#{empty cc.attrs.activity.assignmentLink}">
            		<h:form id="formUpload" enctype="multipart/form-data">
		            	<utilcomp:fileUpload
		            		uploadFileInfo="Upload Result"
		            		fileUploadListenerMethodName="handleFileUpload"
		            		fileUploadListenerMethod="#{cc.attrs.bean.handleFileUpload}"
		            		toUpdate=":#{cc.clientId}:panelUploadAssignment :#{cc.clientId}:growlDetails"
		            		learningContext="#{cc.attrs.learningContext}"
		            	/> 
	            	</h:form> 
            	</ui:fragment>

            </h:panelGroup>
            <courses:deleteModalDialog
                deleteActionMethodName="deleteAssignment"          	
        		deleteAction="#{activityViewBean.deleteAssignment}"
        		toUpdate=":#{cc.clientId}:panelUploadAssignment :#{cc.clientId}:growlDetails" 
        		modalDeleteTitle="Result"
        		modalDeleteText="the result"
        		learningContext="#{cc.attrs.learningContext}"/>
        </div>
	</composite:implementation>
</ui:component>