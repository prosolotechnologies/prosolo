<ui:component
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:composite="http://java.sun.com/jsf/composite"
	xmlns:comp="http://java.sun.com/jsf/composite/components"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:post="http://java.sun.com/jsf/composite/components/post"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:c="http://java.sun.com/jsp/jstl/core">

	<composite:interface>
		<composite:attribute name="publishValues" required="true" />
		<composite:attribute name="publishValue" required="true" />
		<composite:attribute name="scheduledDateValue" />
		<composite:attribute name="scheduledDatePrettyString" default=""/>
		<composite:attribute name="saveAction" required="true" method-signature="void save()"/>
		<composite:attribute name="cancelScheduledUpdateModal" default=""/>
		<composite:attribute name="toUpdate" required="true" />
		<composite:attribute name="previewAction" required="true" method-signature="void preview()"/>
		<composite:attribute name="linkPreviewClass" required="true" />
		<composite:attribute name="resource" required="true" /> <!-- Should be either CREDENTIAL or COMPETENCE -->
		<composite:attribute name="role" required="true" />
		<composite:attribute name="resourceLowerCase" required="true" />
		<composite:attribute name="childResourcePlural" required="true" />
		<composite:attribute name="onclickSave" />
	</composite:interface>
	
	<composite:implementation>
		<script src="#{request.contextPath}/resources/javascript2/rightSideBar.js"></script>
		<div id="#{cc.clientId}" class="whiteBox publishBox">
			<h2>Publish</h2>
			
			<p:commandLink id="linkPreview"
				value="Preview #{cc.attrs.publishValue eq 'UNPUBLISH' ? 'Draft' : ''}"
				styleClass="linkPreview"
				action="#{cc.attrs.previewAction}"
				update="#{cc.attrs.toUpdate}"
				oncomplete="if(args &amp;&amp; !args.validationFailed) {attachListenersForUpdatingStatus(); document.getElementsByClassName('#{cc.attrs.linkPreviewClass}')[0].click();}">
				<f:param name="page" value="#{facesContext.viewRoot.viewId}"></f:param>
				<f:param name="learningContext" value="name:preview"></f:param>
			</p:commandLink>
			
			<div class="clear"></div>
			
			<label>Status:</label>
			<ui:fragment rendered="#{cc.attrs.publishValue eq 'SCHEDULED_PUBLISH' or cc.attrs.publishValue eq 'SCHEDULED_UNPUBLISH'}">
				<p>
	                #{cc.attrs.publishValue eq 'SCHEDULED_UNPUBLISH' ? 'Un-' : ''}Publish scheduled for:<br></br>
	                <strong>#{cc.attrs.scheduledDatePrettyString}</strong><br></br>
	                <a href="javascript:void(0);" data-toggle="modal" data-target="##{cc.attrs.cancelScheduledUpdateModal}">Cancel</a>
	            </p>
            </ui:fragment>
            <ui:fragment rendered="#{cc.attrs.publishValue ne 'SCHEDULED_PUBLISH' and cc.attrs.publishValue ne 'SCHEDULED_UNPUBLISH'}">
				<h:selectOneMenu 
					id="selectStatus" styleClass="selectpicker" 
					value="#{cc.attrs.publishValue}"
					onchange="onStatusChange();">
					<f:selectItems value="#{cc.attrs.publishValues}" var="status"
						itemValue="#{status}" itemLabel="#{status.label}" />
				</h:selectOneMenu>
				
				<script>
					$('.selectpicker').selectpicker('refresh');
					$(function () {
					    $("[id$=datetimepicker4]").datetimepicker({
					    	minDate : new Date()
					    	//defaultDate : new Date()
					    });
					    $("[id$=datetimepicker4]").keypress(function(event) {event.preventDefault();});
					    var status = $(document.getElementById("#{cc.clientId}:selectStatus")).val();
						if(status != "SCHEDULED_PUBLISH" &amp;&amp; status != "SCHEDULED_UNPUBLISH") {
							$("[id$=datetimepicker4]").hide();
						}
					});	
				</script>
				
				<div class="datePickerRow">
	                 <h:inputText value="#{cc.attrs.scheduledDateValue}" style="width:100%;" 
	                 type="text" id="datetimepicker4" placeholder="Date and Time" />
	            </div>
				<br />
			</ui:fragment>
			<div class="publishRow">
				<a href="javascript:void(0);" class="btn btn-green" 
					onclick="saveChangesBtnClick(getStatus());">Save changes</a>
				<p:commandLink style="display: none;"
					styleClass="saveChangesSelector"
					onclick="#{cc.attrs.onclickSave}"
					action="#{cc.attrs.saveAction}"
					update="#{cc.attrs.toUpdate}"
					oncomplete="attachListenersForUpdatingStatus();">
					<f:param name="page" value="#{facesContext.viewRoot.viewId}" />
					Save changes
				</p:commandLink>
				<ui:fragment rendered="#{cc.attrs.resource == 'CREDENTIAL' and cc.attrs.role == 'MANAGER'}">
					<a href="#" data-toggle="modal" data-target="#duplicateCred">Duplicate</a>
				</ui:fragment>
				<a id="linkPublishChildResources" href="#" style="display: none;" data-toggle="modal" data-target="#publishModal"></a> 
				<div class="modal fade" id="publishModal" tabindex="-1" role="dialog" aria-labelledby="publishModal">
			        <div class="modal-dialog" role="document">
			            <div class="modal-content">
			                <div class="modal-header">
			                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&#215;</span></button>
			                    <h2 class="modal-title" id="duplicateCredential">Save changes</h2>
			                </div>
			                <div class="modal-body">
			                    <p>You are about to publish this #{cc.attrs.resourceLowerCase}. By publishing the #{cc.attrs.resourceLowerCase} you will also publish all #{cc.attrs.childResourcePlural}.</p>
			                </div>
			                <div class="modal-footer">
			                    <p:commandLink
									styleClass="btn btn-green"
									onclick="#{cc.attrs.onclickSave}"
									action="#{cc.attrs.saveAction}"
									update="#{cc.attrs.toUpdate}"
									oncomplete="attachListenersForUpdatingStatus(); hideModal('publishModal');">
									<f:param name="page" value="#{facesContext.viewRoot.viewId}"></f:param>
									<f:param name="service" value="name:publish_resource_dialog"></f:param>
									Publish
								</p:commandLink>
			                    <a href="#" class="btn btn-default" data-dismiss="modal">Cancel</a>
			                </div>
			            </div>
			        </div>
	    		</div>
				<a href="#" class="linkRed" data-toggle="modal" data-target="#deleteModal">Delete</a>      
			</div>
		</div>
		
		<ui:fragment rendered="#{cc.attrs.resource == 'CREDENTIAL' and cc.attrs.role == 'MANAGER'}">
			<div class="modal fade" id="duplicateCred" tabindex="-1" role="dialog" aria-labelledby="duplicateCredential">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&#215;</span></button>
							<h2 class="modal-title" id="duplicateCredential">Duplicate Credential?</h2>
						</div>
						<div class="modal-body">
							<p>You will create a new credential with the same structure as the original one in terms of competences and activities. The new credential will be empty in terms of students, student results, comments and assessments.</p>
						</div>
						<div class="modal-footer">
							<p:commandLink styleClass="btn btn-green"
								value="Duplicate Credential"
								action="#{credentialEditBean.duplicate()}"
								process="@this">
								<f:param name="page" value="#{facesContext.viewRoot.viewId}" />
								<f:param name="learningContext" value="name:credential" />
							</p:commandLink>
							<a href="#" class="btn btn-default" data-dismiss="modal">Cancel</a>
						</div>
					</div>
				</div>
			</div>
		</ui:fragment>
		
	</composite:implementation>
</ui:component>