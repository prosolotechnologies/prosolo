<ui:composition
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:pt="http://java.sun.com/jsf/passthrough"
	xmlns:util="http://www.prosolo.com/util">

	<h:form id="notificationForm">
		<p:growl id="notificationsGrowl" showDetail="true" />
		
		<p:poll interval="#{topNotificationsBean.refreshRate}"
			oncomplete="roundImages" update=":notificationForm:notificationsInboxPanel"
			widgetVar="notificationsPoll" autoStart="true" />
			
		<h:panelGroup class="relPos" id="notificationsInboxPanel">
			<div class="container">
				<p:commandLink
					pt:position="s"
					styleClass="btnNotifications indexTripStep8 inlineBlock right"
					action="#{topNotificationsBean.initNotifications()}" 
					actionListener="#{topNotificationsBean.logNotificationServiceUse()}"
					oncomplete="$('.notificationContainer .circle').hide();"
					async="true"
					update=":notificationForm:notificationsResultPanelContent">
					
					<i class="fa fa-bell-o fa-lg"></i>
					
					<h:panelGroup layout="block" class="inboxCircle" rendered="#{topNotificationsBean.unreadNotificationsNo > 0}">
						#{topNotificationsBean.unreadNotificationsNo}
					</h:panelGroup>
				</p:commandLink>
			</div>

			<div id="notifications">
				<div class="beeperNub"></div>
				
				<h:panelGroup layout="block" id="notificationsContainer" class="notificationsContainer">
					<div class="category">
						Notifications
					</div>
				
					<h:panelGroup layout="block" class="itemsContainer" id="notificationsResultPanelContent" rendered="#{!empty topNotificationsBean.notifications}">
						
						<ui:repeat value="#{topNotificationsBean.notifications}" var="notificationData" varStatus="iterator">
							
							<div class="item #{notificationData.read == 'false' ? 'selected' : ''}">
								<link:user value="notifications" 
				    				userData="#{notificationData.actor}"
				    				mode="image"
				    				imageSize="30"
				    				divClass="left"
				    				idPrefix="notActor#{iterator.index}"
				    				context="notifications.image" />
				    				
				    			<h:panelGroup rendered="#{notificationData.actor == null}" class="logoSign image-wrap" />
				    				
								<div class="contentContainer">
									<span>
										<h:link	class="user" value="#{notificationData.actor.name}" 
											outcome="/publicprofile" >
											<f:param name="id" value="#{util:encodeId(notificationData.actor.id)}" />  
										</h:link>
										#{notificationData.type} #{notificationData.resource.shortType}
										<link:resourceLink
											styleClass="bold"
											resourceId="#{notificationData.resource.id}" 
											type="#{notificationData.resource.clazz.simpleName}"
											title="#{notificationData.resource.title}" />
									</span>
									
									<h:panelGroup class="notificationMessage" rendered="#{notificationData.message != null and !notificationData.message.isEmpty()}">
										<div class="clear"></div>
										"#{notificationData.message}"
									</h:panelGroup>
									<div class="clear marginBottom5"></div>
									
									<div class="links">
										<h:panelGroup rendered="#{notificationData.chosenAction == null}">
											<ui:repeat value="#{notificationData.actions}" var="notificationAction" varStatus="notificationActionStatus">
											
												<h:panelGroup rendered="#{notificationData.goalStatus != null and notificationAction == 'ACCEPT'}">
												
													<p:commandLink
														value="#{topNotificationsBean.getNotificationActionName(notificationAction)}"
														onclick="$('#joinGoalFormModalDialog').dialog('open');"
														action="#{joinGoalDialog.initializeJoinGoalDialog(notificationData, 'notifications')}" 
														update=":joinGoalForm"
														async="true" />
												</h:panelGroup>
											
												<p:commandLink rendered="#{!(notificationData.goalStatus != null and notificationAction == 'ACCEPT')}"
													value="#{topNotificationsBean.getNotificationActionName(notificationAction)}"
													onclick="prosolo.overlay.activate();"
													action="#{topNotificationsBean.invokeAction(notificationAction, notificationData)}" 
													update="@form"
													oncomplete="prosolo.overlay.reset();"
													async="true" />
												<h:panelGroup class="bullet" rendered="#{notificationActionStatus.index != notificationData.actions.size()-1}" />
											</ui:repeat>
										</h:panelGroup>
										
										<h:panelGroup class="inactive" rendered="#{notificationData.chosenAction != null}">
											#{notificationData.chosenAction}
										</h:panelGroup>
									</div>
									
									<span class="time">
										#{notificationData.when}
									</span>
								</div>
							</div>
						</ui:repeat>
					</h:panelGroup>
					
					<h:panelGroup layout="block" id="noResultsPanel" styleClass="noResults"
						rendered="#{empty topNotificationsBean.notifications}">
						<h:outputText value="There are no new notifications" />
					</h:panelGroup>
					
					<h:link styleClass="seeAll" value="See all notifications" outcome="/communications" >
						<f:param  name="tab" value="notifications" />
					</h:link>

					<script type="text/javascript">
						$(function() {
							roundImages();
							$('.notificationMessage').shortenedText({showChar: 150, mode: 'static'});
						});
					</script>
				</h:panelGroup>
			</div>
			
			<script type="text/javascript">
			$(function() {
				$('.btnNotifications').on('click', function(e){
					e.stopPropagation();
					if ($('#notifications').hasClass('shown')) {
						$('#notifications').fadeOut();
						$('#notifications').removeClass('shown');
					} else {
						//$('#notifications .notificationsResultPanel').html('<div class="center marginTop10 marginBottom10"><img src="#{request.contextPath}/resources/images/style/ajax-loader-white.gif" style="vertical-align:middle;"/></div>');
						$('#notifications').fadeIn();
						$('#notifications').addClass('shown');
					}
				});
				
				$('#notifications').click(function(e){
					e.stopPropagation();
				});
				
				$(document).on('click', function(e){
					$('#notifications').fadeOut();
					$('#notifications').removeClass('shown');
				});
			});
			</script>
		</h:panelGroup>
	</h:form>
	
	<ui:include	src="/resources/components/dialogs/joinGoalDialog.xhtml" />
</ui:composition>