<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:settingscomp="http://java.sun.com/jsf/composite/components/settings">

	<utilcomp:messagesBundle var="msg" />
	
	<div id="feeds" class="feeds">
		<h2>Settings: Personal Blog and RSS Feeds</h2>
		<div class="separator clear"></div>
	 
		<h:panelGroup id="feedsSettingsContainer" class="feedsContainer">
			<h:form id="feedsSettingsForm">

				<h3>Digest intervals</h3>

				<div class="row info">
					<div class="first bold">
						<h:selectOneMenu value="#{feedsBean.updatePeriod}">
							<f:selectItem itemValue="DAILY" itemLabel="Daily" />
							<f:selectItem itemValue="WEEKLY" itemLabel="Weekly" />
							<f:selectItem itemValue="MONTHLY" itemLabel="Monthly" />
							<f:ajax listener="#{feedsBean.updateSettings}" />
						</h:selectOneMenu>
					</div>

					<div class="second">How often your RSS feeds should be updated</div>
				</div>

				<div class="separator"></div>
			</h:form>
		</h:panelGroup>
	 

		<h:panelGroup id="feedsContainer" class="feedsContainer">
			<h:form id="feedsForm">
				<p:growl id="feedsFormGrowl" showDetail="true" />

				<h3>
					Your personal blog page
					
					<p:commandLink value="Add blog"
						rendered="#{feedsBean.personalBlogSource == null}"
						styleClass="button size20 green right"
						onclick="$('#newBlogModalDialog').dialog('open');"
						update=":addBlogUrlDialog:rssLinkForm" />
					
					<h:outputText value="Add blog" 
						class="button size20 gray right hasTooltip"
						rendered="#{feedsBean.personalBlogSource != null}"
						title="#{msg['settings.feeds.personalBlogs.addBlogBtn.disabled.tooltip']}" />
				</h3>

				<div>This is the URL to you personal blog and its RSS feed where other users can follow you.</div>

				<h:panelGroup layout="block" id="personalBLogSources" class="marginTop10">
				
					<h:panelGroup layout="block" rendered="#{feedsBean.personalBlogSource == null}"
						class="noContentMessage">
						There is no personal blog defined
					</h:panelGroup>
				
					<h:panelGroup layout="block" 
						rendered="#{feedsBean.personalBlogSource != null}"
						class="row info">
						
						<div class="first bold">
							Blog: <h:outputLink value="#{portfolio.socialNetworksData.blogLink}">#{portfolio.socialNetworksData.blogLink}</h:outputLink>
							<div class="clear"></div>
							
							RSS feed: 
								<h:outputLink value="#{feedsBean.personalBlogRssFeedSource}">
									#{feedsBean.personalBlogRssFeedSource}
								</h:outputLink>
								<h:outputText rendered="#{feedsBean.personalBlogRssFeedSource.length() == 0}"
									class="noContentMessage"
									value="No blog RSS feed defined" />
						</div>

						<div class="second">
							<p:commandLink value="Remove" 
								styleClass="iconRemove"
								action="#{feedsBean.removePersonalBlogSource()}"
								update=":feedsForm" />
						</div>
					</h:panelGroup>
				</h:panelGroup>
				
				<div class="separator"></div>

				<h3>
					RSS Feeds
					
					<p:commandLink value="Add feed" 
						styleClass="button size20 green right"
						onclick="$('#newRssModalDialog').dialog('open');"
						update=":addUrlDialog:rssLinkForm" />
				</h3>

				<div>Here are listed RSS feeds that you would like to follow in your digest.</div>
				
				<h:panelGroup layout="block" id="subscribedRssSources" class="marginTop10">
					<p:growl id="subscribedRssSourcesGrowl" showDetail="true" />
				
					<h:panelGroup rendered="#{empty feedsBean.subscribedRssSources}"
						class="noContentMessage">
						There are no RSS feeds defined
					</h:panelGroup>
	
					<ui:repeat value="#{feedsBean.subscribedRssSources}" var="linkData" id="rssFeeds">
						<div class="row info">
							<div class="first bold">
								<h:outputLink value="#{linkData.link}">#{linkData.link}</h:outputLink>
							</div>
	
							<div class="second">
								<p:commandLink value="Remove" 
									styleClass="iconRemove"
									action="#{feedsBean.removeSubscribedRssSource(linkData)}"
									update=":feedsForm" />
							</div>
						</div>
					</ui:repeat>
				</h:panelGroup>
				
				<c:if test="#{loggeduser.user.system}">
					<div class="separator"></div>
					<h3 style="margin-bottom: 0px; color: red">Only system user available action. Use this only if you know what you are doing.</h3>

					<h:panelGroup layout="block" class="left" id="updateFeedsPanel">
						<ui:remove>
							<div>
								<div>
									<h:outputText value="#{feedsBean.message}" escape="false" />
								</div>

								<h:link	rendered="#{featuredNewsBean.feedFeaturedNewsData != null and
												featuredNewsBean.feedFeaturedNewsData.personalFeed != null and
												!feedsBean.initialisedAggregation}"
									value="#{featuredNewsBean.feedFeaturedNewsData.actionLabel}"
									outcome="/digest">
									<f:param name="tab" value="myfeeds" />
									<f:param name="id"
										value="#{featuredNewsBean.feedFeaturedNewsData.personalFeed.id}" />
								</h:link>

							</div>
					
						<div class="row info">
							<div class="first bold"></div>
							<div class="loaderContainer"></div>
						</div>
					</ui:remove>
					
						<div class="row info">
							<div class="second">
								<p:commandLink value="Batch Generate Feed Digests and Email"
									styleClass="button size30 green left"
									update="feedsForm"
									action="#{feedsBean.testBatchGenerateFeedsAndEmail()}" />
									
								<p:commandLink value="Generate Feed Digests For Logged In User"
									styleClass="button size30 green left"
									update="feedsForm"
									action="#{feedsBean.generateMyPersonalFeeds()}" />
							</div>
						</div>
						
						<div class="row info">
							<div class="first bold"></div>
							<div class="loaderContainer"></div>
						</div>
						
						<div class="row info">
							<div class="second"></div>
						</div>

						<script>
						$(function() {
							if (#{feedsBean.initialisedAggregation}) {
								$('.loaderContainer').html('<img class="loader center" src="#{request.contextPath}/resources/images/style/ajax-loader-black.gif"/>').show();
							}
						});
						</script>
					</h:panelGroup>
				</c:if>
				
				<p:remoteCommand name="refreshFeedsForm" update=":feedsForm" />
			</h:form>
		</h:panelGroup>
	</div>
	
	<settingscomp:addUrlDialog id="addUrlDialog"
		onClose="refreshFeedsForm()"/>
	
	<settingscomp:addBlogUrlDialog id="addBlogUrlDialog"
		onClose="refreshFeedsForm()"/>
</ui:composition>