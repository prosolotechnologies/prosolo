<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util">

	<utilcomp:messagesBundle var="msg" />
	
	<script>
		var feedsPage = {};
		feedsPage.fetchingFeedsForBlogMode = false;
	</script>

	<div id="feeds" class="feeds">
		<h2>Settings: Personal Blog and RSS Feeds</h2>
		<div class="separator clear"></div>
	 
			<h:panelGroup id="feedsSettingsContainer" class="feedsContainer">
				<h:form id="feedsSettingsForm">

					<h3>Digest intervals</h3>

					<div class="row info">
						<div class="first bold">
							<h:selectOneMenu value="#{feedsBean.updatePeriod}">
								<f:selectItem itemValue="DAILY" itemLabel="Daily" />
								<f:selectItem itemValue="WEEKLY" itemLabel="Weekly" />
								<f:selectItem itemValue="MONTHLY" itemLabel="Monthly" />
								<f:ajax listener="#{feedsBean.updateSettings}" />
							</h:selectOneMenu>
						</div>

						<div class="second">How often your RSS feeds should be updated</div>
					</div>

					<div class="separator"></div>
				</h:form>
			</h:panelGroup>
	 

		<h:panelGroup id="feedsContainer" class="feedsContainer">
			<h:form id="feedsForm">
				<p:growl id="feedsFormGrowl" showDetail="true" />

				<h3>
					Your personal blog page
					
					<p:commandLink value="Add blog" 
						rendered="#{feedsBean.personalBlogSource == null}"
						styleClass="button size20 green right"
						onclick="feedsPage.fetchingFeedsForBlogMode = true;$('#addLinkSourceModalDialog').dialog('open');"
						action="#{feedsBean.resetAddFeedSourceForm}"
						update=":addLinkSourceForm" />
					
					<h:outputText value="Add blog" 
						class="button size20 gray right hasTooltip"
						rendered="#{feedsBean.personalBlogSource != null}"
						title="#{msg['settings.feeds.personalBlogs.addBlogBtn.disabled.tooltip']}" />
				</h3>

				<div>This is the URL to you personal blog's RSS feed where other users can follow you.</div>

				<h:panelGroup layout="block" id="personalBLogSources" class="marginTop10">
				
					<h:panelGroup layout="block" rendered="#{feedsBean.personalBlogSource == null}"
						class="noContentMessage">
						There is no personal blog defined
					</h:panelGroup>
				
					<h:panelGroup layout="block" 
						rendered="#{feedsBean.personalBlogSource != null}"
						class="row info">
						
						<div class="first bold">
							<h:outputLink value="#{feedsBean.personalBlogSource.link}">#{feedsBean.personalBlogSource.title}</h:outputLink>
						</div>

						<div class="second">
							<p:commandLink value="Remove" 
								styleClass="iconRemove"
								action="#{feedsBean.removePersonalBlogSource()}"
								update=":feedsForm" />
						</div>
					</h:panelGroup>
				</h:panelGroup>

				<div class="separator"></div>

				<h3>
					RSS Feeds
					
					<p:commandLink value="Add feed" 
						styleClass="button size20 green right"
						onclick="feedsPage.fetchingFeedsForBlogMode = false;$('#addLinkSourceModalDialog').dialog('open');"
						action="#{feedsBean.resetAddFeedSourceForm}"
						update=":addLinkSourceForm" />
				</h3>

				<div>Here are lister RSS feeds that you would like to follow in your digest.</div>
				
				<h:panelGroup layout="block" id="subscribedRssSources" class="marginTop10">
				
					<h:panelGroup rendered="#{empty feedsBean.subscribedRssSources}"
						class="noContentMessage">
						There are no RSS feeds defined
					</h:panelGroup>
	
					<ui:repeat value="#{feedsBean.subscribedRssSources}" var="linkData" id="rssFeeds">
						<div class="row info">
							<div class="first bold">
								<h:outputLink value="#{linkData.link}">#{linkData.title}</h:outputLink>
							</div>
	
							<div class="second">
								<p:commandLink value="Remove" 
									styleClass="iconRemove"
									action="#{feedsBean.removeSubscribedRssSource(linkData)}"
									update=":feedsForm" />
							</div>
						</div>
					</ui:repeat>
				</h:panelGroup>
				
				<c:if test="#{loggeduser.user.system}">
					<div class="separator"></div>
					<h3 style="margin-bottom: 0px; color: red">Only system user available action. Use this only if you know what you are doing.</h3>

					<h:panelGroup layout="block" class="left" id="updateFeedsPanel">
						<ui:remove>
							<div>
								<div>
									<h:outputText value="#{feedsBean.message}" escape="false" />
								</div>

								<h:link	rendered="#{featuredNewsBean.feedFeaturedNewsData != null and
												featuredNewsBean.feedFeaturedNewsData.personalFeed != null and
												!feedsBean.initialisedAggregation}"
									value="#{featuredNewsBean.feedFeaturedNewsData.actionLabel}"
									outcome="/digest">
									<f:param name="tab" value="myfeeds" />
									<f:param name="id"
										value="#{featuredNewsBean.feedFeaturedNewsData.personalFeed.id}" />
								</h:link>

							</div>
					
						<div class="row info">
							<div class="first bold"></div>
							<div class="loaderContainer"></div>
						</div>
					</ui:remove>
					
						<div class="row info">
							<div class="second">
								<p:commandLink value="Batch Generate Feed Digests and Email"
									styleClass="button size30 green left"
									update="feedsForm"
									action="#{feedsBean.testBatchGenerateFeedsAndEmail()}" />
									
								<p:commandLink value="Generate Feed Digests For Logged In User"
									styleClass="button size30 green left"
									update="feedsForm"
									action="#{feedsBean.generateMyPersonalFeeds()}" />
							</div>
						</div>
						
						<div class="row info">
							<div class="first bold"></div>
							<div class="loaderContainer"></div>
						</div>
						
						<div class="row info">
							<div class="second"></div>
						</div>

						<script>
						$(function() {
							if (#{feedsBean.initialisedAggregation}) {
								$('.loaderContainer').html('<img class="loader center" src="#{request.contextPath}/resources/images/style/ajax-loader-black.gif"/>').show();
							}
						});
						</script>
					</h:panelGroup>
				</c:if>
			</h:form>
		</h:panelGroup>
	</div>
	
	
	<!-- Add link source -->
	<div id="addLinkSourceModalDialog" class="addLinkSourceModalDialog" style="display: none;">
		<h:form id="addLinkSourceForm">
			<div class="firstPage">
				<p>
					<h:inputText id="linkToAdd" 
						class="linkToAdd" 
						placeholder="#{msg['settings.feeds.dialog.addRssSource.linkToAdd']}"
						value="#{feedsBean.addFeedSourceData.linkToAdd}" />
					
					<h:selectBooleanCheckbox id="fetchingFeedsForBlog" class="fetchingFeedsForBlog hidden" 
						value="#{feedsBean.fetchingFeedsForBlog}" />
					
					<script>
						$('#addLinkSourceModalDialog .firstPage .linkToAdd').val('').focus();
						$('#addLinkSourceModalDialog .firstPage .fetchingFeedsForBlog').attr('checked', feedsPage.fetchingFeedsForBlogMode);
					</script>
				</p>
				
				<div class="actions">
					<p:commandLink value="Analyze link"
						styleClass="button green size30 right"
						onclick="$('#addLinkSourceModalDialog .actions .loader').show()"
					 	action="#{feedsBean.processFeedSource()}"
					 	process=":addLinkSourceForm:linkToAdd :addLinkSourceForm:fetchingFeedsForBlog"
					 	update=":addLinkSourceForm:newFeedSources"
					 	oncomplete="showSecondPage();"
					/>
				
					<img src="#{request.contextPath}/resources/images/style/ajax-loader-black.gif"
						class="loader hidden right"
						style="vertical-align:middle;" />
				</div>
			</div>
			
			<h:panelGroup layout="block" id="newFeedSources" class="secondPage hidden">
				<h:panelGroup rendered="#{empty feedsBean.addFeedSourceData.feedSources}"
					class="noContentMessage">
					There are no RSS feeds found on this page.
				</h:panelGroup>
			
				<h:panelGroup rendered="#{not empty feedsBean.addFeedSourceData.feedSources}">
					<p class="message">For this link we have found the following RSS feeds. Please select the ones you want to add.</p>
				
					<table>
						<ui:repeat value="#{feedsBean.addFeedSourceData.feedSources}" var="feedSource">
							<tr>
								<td>
									<h:selectBooleanCheckbox class="toAddCheck"
										value="#{feedSource.toAdd}" />
								</td>	
								<td>
									<a href="#{feedSource.link}" target="_blank">#{feedSource.title}</a>
								</td>					
							</tr>
						</ui:repeat>
					</table>
					<script>
						if (feedsPage.fetchingFeedsForBlogMode) {
							$('#addLinkSourceModalDialog .secondPage .message').append('<b>You can only choose one source to be your personal blog.</b>');
							
							$('#addLinkSourceModalDialog .toAddCheck').on('change', function() {
							    $('#addLinkSourceModalDialog .toAddCheck').not(this).prop('checked', false);  
							});
						}
					</script>
				</h:panelGroup>
				
				<div class="actions marginTop20">
					<a class="button gray size30 left" onclick="showFirstPage()">Back</a>
					
					<p:commandLink value="Save"
						rendered="#{not empty feedsBean.addFeedSourceData.feedSources}"
						styleClass="button green size30 right"
						onclick="$('#addLinkSourceModalDialog').dialog('close');"
					 	action="#{feedsBean.addNewFeedSources()}"
					 	update=":feedsForm"
					/>
					
					<p:commandLink value="Close"
						rendered="#{empty feedsBean.addFeedSourceData.feedSources}"
						styleClass="button green size30 right"
						onclick="$('#addLinkSourceModalDialog').dialog('close');"
					/>
				</div>
			</h:panelGroup>
			
			<script>
				function showFirstPage(){
					$('#addLinkSourceModalDialog .firstPage .linkToAdd').val('');
					$('#addLinkSourceModalDialog .firstPage').show();
					$('#addLinkSourceModalDialog .secondPage').hide();
				}
				function showSecondPage(){
					$('#addLinkSourceModalDialog .firstPage').hide();
					$('#addLinkSourceModalDialog .secondPage').show();
					$('#addLinkSourceModalDialog .actions .loader').hide();
				}
			</script>
			
			<utilcomp:tooltip target=".hasTooltip[title]" />
	 	</h:form>
	</div>
	
	<script>
	$(function() {
		$('#addLinkSourceModalDialog').dialog({
			title: 'Add new feed source',
			show : 'slide',
			autoOpen: false,
			width: 400,
			modal: true,
			resizable: false,
			open: function(event, ui) {
				$(this).children(':first')
					.css('text-align', 'center')
					.css('padding-top', '50px')
					.html('<img src="#{request.contextPath}/resources/images/style/ajax-loader-black.gif" style="vertical-align:middle;"/>');
			},
		});
		$('#addLinkSourceModalDialog').show();
	});
	</script>
</ui:composition>