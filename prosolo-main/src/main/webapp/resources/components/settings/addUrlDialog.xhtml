<ui:component
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:composite="http://java.sun.com/jsf/composite"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util">

	<composite:interface>
		<composite:attribute name="onClose" />
	</composite:interface>
	
	<composite:implementation>

		<utilcomp:messagesBundle var="msg" />
		
		<div id="newRssModalDialog" class="newRssModalDialog" style="display: none;">
			<h:form id="rssLinkForm">
			
				<p:growl id="newRssModalDialogGrowl" showDetail="true" />
	
				<p class="message">Insert RSS feed link:</p>
				<p>
					<h:inputText id="linkToAdd" 
						class="linkToAdd" 
						placeholder="#{msg['settings.feeds.dialog.enterLink']}"
						value="#{feedsBean.addRssFeedSourceData.linkToAdd}" />
				</p>
				
				<p class="message actions">
					<p:commandLink value="Analyze"
						id="analyzeBtn"
						styleClass="button green size30 right analyzeBtn"
						onclick="$('#newRssModalDialog .actions .loader').show()"
					 	action="#{feedsBean.processRssFeedLink()}"
					 	update="newFeedSources newRssModalDialogGrowl"
					 	oncomplete="afterLinkProcess(xhr, status, args)"
					/>
					
					<script>
					function afterLinkProcess(xhr, status, args) {  
						if (args.close) {
							$('#newRssModalDialog').dialog('close');
						} else {
							$('#newRssModalDialog .newFeedSources').show();
						}
					}
					
					$("#newRssModalDialog .linkToAdd").focus();
					</script>
				
					<img src="#{request.contextPath}/resources/images/style/ajax-loader-black.gif"
						class="loader hidden right"
						style="vertical-align:middle;" />
				</p>
				<div class="clear marginBottom10"></div>
				
				<h:panelGroup layout="block" id="newFeedSources" class="message newFeedSources hidden">
					<h:panelGroup rendered="#{empty feedsBean.addRssFeedSourceData.feedSources}" class="noContentMessage">
						There are no RSS feeds found on this page.
					</h:panelGroup>
				
					<h:panelGroup rendered="#{not empty feedsBean.addRssFeedSourceData.feedSources}">
						<p class="message">On this link we have found the several RSS feeds. Select the ones you want to subscribe to.</p>
					
						<table>
							<ui:repeat value="#{feedsBean.addRssFeedSourceData.feedSources}" var="feedSource">
								<tr>
									<td>
										<h:selectBooleanCheckbox class="toAddCheck"
											rendered="#{!feedSource.canNotBeAdded}"
											value="#{feedSource.toAdd}" />
									</td>	
									<td>
										<a href="#{feedSource.link}" target="_blank">#{feedSource.title}</a>
									</td>					
								</tr>
							</ui:repeat>
						</table>
						
						<h:panelGroup rendered="#{feedsBean.addRssFeedSourceData.someFeedsCanNotBeAdded}" class="noContentMessage">
							Feeds you are already subscribed to are disabled for adding.
						</h:panelGroup>
					</h:panelGroup>
					
					<div class="actions marginTop20">
						<p:commandLink value="Save"
							rendered="#{not empty feedsBean.addRssFeedSourceData.feedSources}"
							styleClass="button green size30 right"
							onclick="$('#newRssModalDialog').dialog('close');"
						 	action="#{feedsBean.addNewRSSFeedSources()}"
						 	update=":feedsForm"
						/>
						
						<p:commandLink value="Close"
							styleClass="button gray size30 right"
							onclick="$('#newRssModalDialog').dialog('close');"
						/>
					</div>
					
					<script>
						$('#newRssModalDialog .actions .loader').hide();
					</script>
				</h:panelGroup>
				
				<utilcomp:tooltip target=".hasTooltip[title]" />
				<p:defaultCommand target="analyzeBtn" />
		 	</h:form>
		</div>
		
		<script>
		$(function() {
			$('#newRssModalDialog').dialog({
				title: 'Add new RSS feed',
				show : 'slide',
				autoOpen: false,
				width: 500,
				modal: true,
				resizable: false,
				open: function(event, ui) {
					$(this).children(':first')
						.css('text-align', 'center')
						.css('padding-top', '50px')
						.html('<img src="#{request.contextPath}/resources/images/style/ajax-loader-black.gif" style="vertical-align:middle;"/>');
				},
				close: function(event, ui) {
					${cc.attrs.onClose}
				},
			});
			$('#newRssModalDialog').show();
		});
		</script>
		
	</composite:implementation>
</ui:component>