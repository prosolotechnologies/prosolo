<ui:component
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:composite="http://java.sun.com/jsf/composite"
	xmlns:p="http://primefaces.org/ui"
	xmlns:comp="http://java.sun.com/jsf/composite/components"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:util="http://www.prosolo.com/util"
	xmlns:courses="http://java.sun.com/jsf/composite/components/courses"
	xmlns:post="http://java.sun.com/jsf/composite/components/post">

	<composite:interface>
		<composite:attribute name="bean" required="true"/>
		<composite:attribute name="role" type="java.lang.String" default="USER"/>
		<composite:attribute name="learningContext" default=""/>
		<composite:attribute name="service" default="" />
	</composite:interface>
	
	<composite:implementation>
		<ui:param name="isPreview" value="#{cc.attrs.bean.isPreview()}" />
     	<ui:param name="canEdit" value="#{cc.attrs.role == 'MANAGER' and cc.attrs.bean.competenceData.activityToShowWithDetails.type == 'UNIVERSITY_CREATED' 
     		and request.isUserInRole('MANAGE.CONTENT.EDIT') || cc.attrs.role != 'MANAGER' and cc.attrs.bean.isCurrentUserCreator()}"></ui:param>
     	
     	<c:choose>
		    <c:when test="#{cc.attrs.bean.competenceData.activityToShowWithDetails.enrolled}">
		         <c:set var="learningContext" value="name:credential|id:#{cc.attrs.bean.decodedCredId}|context:/name:competence|id:#{cc.attrs.bean.decodedCompId}|context:/name:activity|id:#{cc.attrs.bean.competenceData.activityToShowWithDetails.activityId}|context:/name:target_activity|id:#{cc.attrs.bean.competenceData.activityToShowWithDetails.targetActivityId}///"/>
		    </c:when>
		    <c:otherwise>
		    	 <c:choose>
		    	 	 <c:when test="#{cc.attrs.bean.decodedCredId ne 0}">
			         	  <c:set var="learningContext" value="name:credential|id:#{cc.attrs.bean.decodedCredId}|context:/name:competence|id:#{cc.attrs.bean.decodedCompId}|context:/name:activity|id:#{cc.attrs.bean.competenceData.activityToShowWithDetails.activityId}//"/>
			         </c:when>
			         <c:otherwise>
			         	  <c:set var="learningContext" value="name:competence|id:#{cc.attrs.bean.decodedCompId}|context:/name:activity|id:#{cc.attrs.bean.competenceData.activityToShowWithDetails.activityId}//"/>
		         	 </c:otherwise>
		    	 </c:choose>
		    </c:otherwise>
		</c:choose>
     	<div id="#{cc.clientId}">
	    	<div class="whiteBar">
	        <div class="container">
	         <h:form id="formMain">
	            <div class="whiteBarContent">
	                <h:panelGroup layout="block" id="panelComplete" styleClass="whiteBarLeft">
	                	<p:commandLink
	                		rendered="#{cc.attrs.bean.competenceData.activityToShowWithDetails.enrolled 
	                			and !isPreview and !cc.attrs.bean.competenceData.activityToShowWithDetails.completed
	                			and cc.attrs.bean.nextToLearn}"
	                		styleClass="btn btn-green btn-sm"
	                		value="Mark as Complete"
	                		process="@this"
	                		action="#{cc.attrs.bean.completeActivity()}"
	                		update=":#{cc.clientId}:formMain:panelComplete :#{cc.clientId}:panelCompProgress">
	                		<f:param name="page" value="#{facesContext.viewRoot.viewId}"></f:param>
	                    	<f:param name="learningContext" value="#{learningContext}"></f:param>
	                	</p:commandLink>
	                	<ui:fragment rendered="#{!cc.attrs.bean.nextToLearn}">
	                		<a href="javascript:void(0);" 
	                			class="btn btn-green btn-sm" 
	                			disabled="disabled" 
	                			data-toggle="tooltip" 
	                			title="In order to complete this activity, previous tasks need to be completed.">
	                			Mark as Complete
	                		</a>
                		</ui:fragment>
	                	<ui:fragment rendered="#{cc.attrs.bean.competenceData.activityToShowWithDetails.enrolled 
	                		and !isPreview and cc.attrs.bean.competenceData.activityToShowWithDetails.completed}">
	                    	<div class="tagCompleted">Completed</div>
	                    </ui:fragment>
	                </h:panelGroup>
	                <div class="whiteBarRight">
	                    <div class="duration item">#{cc.attrs.bean.competenceData.activityToShowWithDetails.durationString}</div>
	                    <h:link 
	                    	rendered="#{canEdit and !isPreview}"
	                    	value="Edit Activity"
	                    	styleClass="btn btn-green-stroke btn-sm item"
	                    	outcome="create-activity">
	                    	<f:param name="id" value="#{param['actId']}"></f:param>
	                    	<f:param name="compId" value="#{param['compId']}"></f:param>
	                    	<f:param name="credId" value="#{param['credId']}" disable="#{empty param['credId']}"></f:param>
	                    </h:link>
	                </div>
	            </div>
	         </h:form>
	        </div>
	    	</div>
	
		    <div class="container">
		    	<ui:fragment rendered="#{cc.attrs.bean.competenceData.credentialId != 0}">
		    		<ol class="breadcrumb">
			            <li>
			            	<h:link value="Credentials" outcome="/credentialLibrary"/>
			            </li>
			            <li>
			            	<h:link 
			            		value="#{cc.attrs.bean.competenceData.credentialTitle}"
			            		outcome="credential">
			            		<f:param name="id" value="#{param['credId']}"></f:param>
			            	</h:link>
			            </li>
			            <li>
			            	<h:link 
			            		value="#{cc.attrs.bean.competenceData.title}"
			            		outcome="competence">
			            		<f:param name="compId" value="#{param['compId']}"></f:param>
			            		<f:param name="credId" value="#{param['credId']}"></f:param>
			            	</h:link>
			            </li>
			            <li class="active">#{cc.attrs.bean.competenceData.activityToShowWithDetails.title}</li>
			        </ol>
		    	</ui:fragment>
		        <ui:fragment rendered="#{cc.attrs.bean.competenceData.credentialId == 0}">
		    		<ol class="breadcrumb">	 
		    			<li>
			            	<a href="javascript:void(0);">Competences</a>
			            </li> 
		    			<li>
			            	<h:link 
			            		value="#{cc.attrs.bean.competenceData.title}"
			            		outcome="competence">
			            		<f:param name="compId" value="#{param['compId']}"></f:param>  
			            	</h:link>
			            </li>         
			            <li class="active">#{cc.attrs.bean.competenceData.activityToShowWithDetails.title}</li>
			        </ol>
		    	</ui:fragment>
		    </div>
	
		    <div class="container">
		        <div class="row">
		            <div class="col-md-8">
		            	<courses:activityDetails 
		            		id="activityDetails"
		            		activity="#{cc.attrs.bean.competenceData.activityToShowWithDetails}"
		            		bean="#{cc.attrs.bean}"
		            		isPreview="#{isPreview}"
		            		learningContext="#{learningContext}"
		            	/>
		                
		                <post:comments 
		               		id="comments"
		               		learningContext="#{learningContext}"
		               />
		            </div>
		            <h:panelGroup layout="block" id="panelCompProgress" styleClass="col-md-4">
						<div class="sidebarBlock">
			                <h2>Competence Progress</h2>
		            	
			                <ul class="competenceProgressList">
			                	<ui:repeat var="act" value="#{cc.attrs.bean.competenceData.activities}">
			                		<li class="#{styleUtilBean.getStyleClassBasedOnActivityType(act.activityType)} 
			                			#{cc.attrs.bean.isActivityActive(act) ? 'active' : ''}">
			                        	<h:panelGroup 
						          			rendered="#{!isPreview and act.completed}"
						          			styleClass="check">    
						          		</h:panelGroup>
					            		<h:panelGroup
					            			rendered="#{!act.completed || isPreview}"
					            			styleClass="iconType">
					            		</h:panelGroup>
			                       		<h3>
			                       			<ui:fragment rendered="#{!isPreview and !cc.attrs.bean.isActivityActive(act)}">
					                   			<h:link
								            		value="#{act.title}"
								            		outcome="activity">
								            		<f:param name="actId" value="#{util:encodeId(act.activityId)}"></f:param>
								            		<f:param name="compId" value="#{param['compId']}" disable="#{empty param['compId']}"></f:param>
					            					<f:param name="credId" value="#{param['credId']}" disable="#{empty param['credId']}"></f:param>
					            				</h:link>   
						                   	</ui:fragment>
						                   	<ui:fragment rendered="#{isPreview || cc.attrs.bean.isActivityActive(act)}">
						                   		#{act.title}
						                   	</ui:fragment>
			                       		</h3>
			                    	</li>
			                	</ui:repeat>
			                </ul>
						</div>
					</h:panelGroup>
				</div>
		    </div>
		    
		    <ui:fragment rendered="#{not empty param['comment']}">
		    	<script>
			    	scrollTo('comment_' + #{util:decodeId(param['comment'])});
			    </script>
		    </ui:fragment>
		</div>
	</composite:implementation>
</ui:component>