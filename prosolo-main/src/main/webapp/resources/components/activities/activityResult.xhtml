<ui:component
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:composite="http://java.sun.com/jsf/composite"
	xmlns:comp="http://java.sun.com/jsf/composite/components"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:link="http://java.sun.com/jsf/composite/components/resourceLinks"
	xmlns:post="http://java.sun.com/jsf/composite/components/post"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:courses="http://java.sun.com/jsf/composite/components/courses"
	xmlns:socialWall="http://java.sun.com/jsf/composite/components/socialWall"
	xmlns:util="http://www.prosolo.com/util"
	xmlns:c="http://java.sun.com/jsp/jstl/core">

	<composite:interface>
		<composite:attribute name="bean"/>
		<composite:attribute name="resultData" required="true" />
		<composite:attribute name="resultType" required="true"/>
		<composite:attribute name="learningContext" required="true" />
		<composite:attribute name="assignmentUploadModalId" default="" />
		<composite:attribute name="growlToUpdate" default="" />
		<composite:attribute name="regionToUpdate" default="" />
		<composite:attribute name="privateConvModalId" default="" />
		<composite:attribute name="toUpdateConvModal" default="" />
		<composite:attribute name="privateConvNumberOfMsgsLink" default=""/>
		<composite:attribute name="assessmentGradeModalId" default="" />
		<composite:attribute name="toUpdateAssessmentGradeModal" default="" />
		<composite:attribute name="gradeLink" default=""/>
		<composite:attribute name="role" default="USER" />
	</composite:interface>
	
	<composite:implementation>
		<c:if test="#{cc.attrs.resultType eq 'FILE_UPLOAD'}">
   			<div id="activityResultBox_#{cc.attrs.resultData.user.id}" class="whiteBox activityResultFile">
             <div class="activityResultHead">
                 <div class="user32">
                 	<utilcomp:userAvatar
						avatar="#{cc.attrs.resultData.user.avatarUrl}"
						fullName="#{cc.attrs.resultData.user.fullName}" />
                     <h3>
                     	<h:link outcome="/profile">
                     		#{cc.attrs.resultData.user.fullName}
                     		<f:param name="id" value="#{util:encodeId(cc.attrs.resultData.user.id)}"></f:param>
                     	</h:link>
                     </h3>
                 </div>
                 <div class="timestamp">
                     #{cc.attrs.resultData.prettyResultPostDate}
                 </div>
             </div>
             <div class="resultWrapper">
                 <div class="actBoxLeft #{cc.attrs.role eq 'USER' and cc.attrs.resultData.user.id eq loggeduser.userId ? '' : 'noUrl'}">
                     <h3>#{cc.attrs.resultData.assignmentTitle}</h3>                    
                 	 <ui:fragment rendered="#{cc.attrs.role eq 'USER' and cc.attrs.resultData.user.id eq loggeduser.userId}">
                 	 	<a href="#" class="newFileLink" data-toggle="modal" data-target="##{cc.attrs.assignmentUploadModalId}">Upload New Submission</a>
                 	 </ui:fragment>
                 </div>
                 <a href="#{cc.attrs.resultData.result}" target="_blank" class="btn btn-green btn-sm">Download</a>
             </div>
             <c:if test="#{cc.attrs.role eq 'MANAGER'}">
	             <div class="resultOptions">
	                 <span>Private conversation:</span>
	                 <p:commandLink 
	                 	styleClass="commentsIcon #{cc.attrs.privateConvNumberOfMsgsLink}" 
	                 	pt:data-toggle="modal" data-target="##{cc.attrs.privateConvModalId}"
	                 	onclick="markDiscussionAsSeen('#{cc.attrs.resultData.assessment.encodedDiscussionId}',this.parentElement)"
	                 	action="#{cc.attrs.bean.loadActivityDiscussion(cc.attrs.resultData)}"
	                 	update="#{cc.attrs.toUpdateConvModal}"
	                 	oncomplete="$('##{cc.attrs.privateConvModalId}').modal('show');">
	                 	#{cc.attrs.resultData.assessment.numberOfMessages}
	                 </p:commandLink>
	                 
	                 <ui:fragment rendered="#{activityResultsBeanManager.isCurrentUserAssessor(cc.attrs.resultData)}">
		                 <p:commandLink 
		                 	styleClass="grade #{cc.attrs.gradeLink}" 
		                 	pt:data-toggle="modal" data-target="##{cc.attrs.assessmentGradeModalId}"
		                 	action="#{cc.attrs.bean.setCurrentResult(cc.attrs.resultData)}"
		                 	update="#{cc.attrs.toUpdateAssessmentGradeModal}"
		                 	oncomplete="$('##{cc.attrs.assessmentGradeModalId}').modal('show');">
		                 	#{not empty cc.attrs.resultData.assessment.grade.value ? cc.attrs.resultData.assessment.grade.value : '-'}
		                 </p:commandLink>
		             </ui:fragment>
		             <ui:fragment rendered="#{not activityResultsBeanManager.isCurrentUserAssessor(cc.attrs.resultData)}">
		             	<a 
		                 	class="grade" 
		                 	disabled="disabled" 
		                 	data-toggle="tooltip" 
		                 	title="You can not grade this student because you are not his instructor">
		                 	#{not empty cc.attrs.resultData.assessment.grade.value ? cc.attrs.resultData.assessment.grade.value : '-'}
		                 </a>
		             </ui:fragment>
	             </div>
             </c:if>
             <div class="activityResultFooter">
             	<h:panelGroup id="panelToggleComments">
		           <p:commandLink rendered="#{!cc.attrs.resultData.resultComments.initialized}"
		           		styleClass="commentsNumber" 
		           		pt:role="button" 
		           		pt:data-toggle="collapse" 
		           		href="#commentsContainerDiv#{cc.attrs.resultData.targetActivityId}" 
		           		pt:aria-expanded="false" 
		           		pt:aria-controls="#commentsContainerDiv#{cc.attrs.resultData.targetActivityId}"
		           		action="#{activityResultBean.initializeResultCommentsIfNotInitialized(cc.attrs.resultData)}"
		           		update="comments panelToggleComments"
		           		oncomplete="$('#commentsContainerDiv#{cc.attrs.resultData.targetActivityId}').collapse();">
		           		<span class="icon"></span>#{cc.attrs.resultData.resultComments.numberOfComments} comments
		           	</p:commandLink>
		           	<ui:fragment rendered="#{cc.attrs.resultData.resultComments.initialized}">
		           		<h:panelGroup id="panelCommentsNumber" styleClass="panelCommentsNumber#{cc.attrs.resultData.targetActivityId}">
		            			<a class="commentsNumber" 
		            				role="button" 
		            				data-toggle="collapse" 
		            				href="#commentsContainerDiv#{cc.attrs.resultData.targetActivityId}" 
		            				aria-expanded="false" 
		            				aria-controls="#commentsContainerDiv#{cc.attrs.resultData.targetActivityId}">
						<span class="icon"></span>
						#{cc.attrs.resultData.resultComments.numberOfComments} comments
					</a>
		           		</h:panelGroup>  
		       		</ui:fragment>
        		</h:panelGroup>
             </div>
          	<post:comments
	      		id="comments"
	      		comments="#{cc.attrs.resultData.resultComments}"
	      		uniqueId="#{cc.attrs.resultData.targetActivityId}"
	      		commentsContainerDivId="commentsContainerDiv#{cc.attrs.resultData.targetActivityId}"
	      		showSortOptions="false"
	      		isCollapsible="true"
	      		growlToUpdate="#{cc.attrs.growlToUpdate}"
	      		learningContext="#{util:addSubContext(cc.attrs.learningContext, 'name:result|id:'.concat(cc.attrs.resultData.targetActivityId))}"
	      		toUpdateOnSaveTopLevelComment="@(.panelCommentsNumber#{cc.attrs.resultData.targetActivityId})"
	      		toUpdateOnCommentSave=""
    		/>
         </div>
   		</c:if>
   		<c:if test="#{cc.attrs.resultType eq 'TEXT'}"> 
   			<article id="activityResultBox_#{cc.attrs.resultData.user.id}" class="whiteBox activityResultText">
             <div class="activityResultHead">
                 <div class="user32">
                     <utilcomp:userAvatar
						avatar="#{cc.attrs.resultData.user.avatarUrl}"
						fullName="#{cc.attrs.resultData.user.fullName}" />
                     <h3>
                     	<h:link outcome="/profile">
                     		#{cc.attrs.resultData.user.fullName}
                     		<f:param name="id" value="#{util:encodeId(cc.attrs.resultData.user.id)}"></f:param>
                     	</h:link>
                     </h3>
                 </div>
                 <div class="timestamp">
                     #{cc.attrs.resultData.prettyResultPostDate}
                 </div>
             </div>
             <div class="activityResultTextContent">
                 <p class="commentText">
                 	<h:outputText escape="false" value="#{cc.attrs.resultData.result}" />
                 </p>
                 <ui:fragment rendered="#{cc.attrs.role eq 'USER' and cc.attrs.resultData.user.id eq loggeduser.userId}">
                 	<div class="editComment hidden">
	                 	<h:form>
		                  	<h:inputTextarea class="hidden"
								value="#{cc.attrs.resultData.result}" />
	                      	<div class="contentEditableComment" contenteditable="true" strip-br="true">#{cc.attrs.resultData.result}</div>
		                    <p:commandLink 
		                      	styleClass="btn btn-sm btn-green"
		                      	action="#{activityResultBean.updateTextResponse(cc.attrs.resultData)}"
		                      	update="#{cc.attrs.regionToUpdate}">
		                      	<f:param name="page" value="#{facesContext.viewRoot.viewId}"/>
								<f:param name="learningContext" value="#{cc.attrs.learningContext}"/>
		                      	Submit
		                    </p:commandLink>
	                  
	                     	<a href="javascript:void(0)" class="btn btn-sm btn-green-stroke" onclick="hideEditResponse(this);">Cancel</a>
	                 		<script>
								$('.activityResultTextContent .editComment .contentEditableComment').on('keyup', function(e) {
									$(this).prev('textarea').val($(this).html());
								});
							</script>
	                 	</h:form>
	                 </div>
                 </ui:fragment>
             </div>
             <c:if test="#{cc.attrs.role eq 'MANAGER'}">
	             <div class="resultOptions">
	                 <span>Private conversation:</span>
	                 <a href="#" class="commentsIcon" data-toggle="modal" data-target="##{cc.attrs.privateConvModalId}">5</a>
	                 <a href="#" class="grade" data-toggle="modal" data-target="##{cc.attrs.assessmentGradeModalId}">10</a>
	             </div>
             </c:if>
             <div class="activityResultFooter">
                 <h:panelGroup id="panelToggleComments">
		           <p:commandLink rendered="#{!cc.attrs.resultData.resultComments.initialized}"
		           		styleClass="commentsNumber" 
		           		pt:role="button" 
		           		pt:data-toggle="collapse" 
		           		href="#commentsContainerDiv#{cc.attrs.resultData.targetActivityId}" 
		           		pt:aria-expanded="false"
		           		pt:aria-controls="#commentsContainerDiv#{cc.attrs.resultData.targetActivityId}"
		           		action="#{activityResultBean.initializeResultCommentsIfNotInitialized(cc.attrs.resultData)}"
		           		update="comments panelToggleComments"
		           		oncomplete="$('#commentsContainerDiv#{cc.attrs.resultData.targetActivityId}').collapse();">
		           		<span class="icon"></span>#{cc.attrs.resultData.resultComments.numberOfComments} comments
		           	</p:commandLink>
		           	<ui:fragment rendered="#{cc.attrs.resultData.resultComments.initialized}">
		           		<h:panelGroup id="panelCommentsNumber" styleClass="panelCommentsNumber#{cc.attrs.resultData.targetActivityId}">
		            			<a class="commentsNumber" 
		            				role="button" 
		            				data-toggle="collapse" 
		            				href="#commentsContainerDiv#{cc.attrs.resultData.targetActivityId}" 
		            				aria-expanded="false" 
		            				aria-controls="#commentsContainerDiv#{cc.attrs.resultData.targetActivityId}">
									<span class="icon"></span>
									#{cc.attrs.resultData.resultComments.numberOfComments} comments
								</a>
           				</h:panelGroup>  
       				</ui:fragment>
        		</h:panelGroup>
        		<ui:fragment rendered="#{cc.attrs.role eq 'USER' and cc.attrs.resultData.user.id eq loggeduser.userId}">
             		<a href="javascript:void(0)" class="edit" onclick="showEditResponse(this)"><span class="icon"></span>Edit</a>
             	</ui:fragment>
             </div>
             <post:comments
		      		id="comments"
		      		comments="#{cc.attrs.resultData.resultComments}"
		      		uniqueId="#{cc.attrs.resultData.targetActivityId}"
		      		commentsContainerDivId="commentsContainerDiv#{cc.attrs.resultData.targetActivityId}"
		      		showSortOptions="false"
		      		isCollapsible="true"
		      		growlToUpdate="#{cc.attrs.growlToUpdate}"
		      		learningContext="#{util:addSubContext(cc.attrs.learningContext, 'name:result|id:'.concat(cc.attrs.resultData.targetActivityId))}"
		      		toUpdateOnSaveTopLevelComment="@(.panelCommentsNumber#{cc.attrs.resultData.targetActivityId})"
		      		toUpdateOnCommentSave=""
		    />
         </article>
   		</c:if>
	</composite:implementation>
</ui:component>