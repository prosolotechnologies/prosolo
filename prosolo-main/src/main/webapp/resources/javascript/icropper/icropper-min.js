(function(){var e={mixin:function(e,t){for(var n in t)e[n]=t[n]},byId:function(e){if(typeof e=="string")return document.getElementById(e);else return e},create:function(e,t){var n=document.createElement(e);this.mixin(n,t);return n},connect:function(e,t,n,r){var i=this;e[t]=function(e){e=i.fixEvent(e);n[r](e)}},style:function(e,t){if(typeof t=="string"){var n=e.style[t];if(!n){s=window.getComputedStyle?getComputedStyle(e):e.currentStyle;n=s[t]}return n}else this.mixin(e.style,t)},each:function(e,t){for(var n=0;n<e.length;n++)t(e[n],n)},indexOf:function(e,t){for(var n=0;n<e.length;n++)if(t==e[n])return n;return-1},addCss:function(t,n){if(!t)return;var r=t.className||"",i=r.split(" "),s=e.indexOf(i,n);if(s<0)i.push(n);t.className=i.join(" ")},rmCss:function(t,n){if(!t)return;var r=t.className||"",i=r.split(" "),s=e.indexOf(i,n);if(s>=0)i.splice(s,1);t.className=i.join(" ")},fixEvent:function(e){e=e||event;if(!e.target)e.target=e.srcElement;if(!e.keyCode)e.keyCode=e.which||e.charCode;if(!e.pageX){e.pageX=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;e.pageY=e.clientY+document.body.scrollTop+document.documentElement.scrollTop}return e}};window.ICropper=function(t,n){t=e.byId(t);for(var r in n){if(n[r])this[r]=n[r]}this.domNode=t||e.create("div");this._init()};ICropper.prototype={image:"",minWidth:20,minHeight:20,gap:50,initialSize:0,keepSquare:false,preview:null,domNode:null,cropNode:null,imageNode:null,setImage:function(t){var n=new Image;n.src=t;this.image=t;if(!this.imageNode){this.imageNode=e.create("img");this.domNode.appendChild(this.imageNode);var r=this;this.imageNode.onload=function(){r._setSize(this.offsetWidth,this.offsetHeight)}}this.imageNode.src=t},bindPreview:function(t){t=e.byId(t);e.style(t,{overflow:"hidden"});var n=parseInt(e.style(t,"width")),r=parseInt(e.style(t,"height"));var i=e.create("img",{src:this.image});t.appendChild(i);var s=this.onChange;this.onChange=function(t){s.call(this,t);var o=n/t.w,u=r/t.h;e.style(i,{width:t.cw*o+"px",height:t.ch*u+"px",marginLeft:-t.l*o+"px",marginTop:-t.t*u+"px"})}},getInfo:function(){return{w:this.cropNode.offsetWidth-2,h:this.cropNode.offsetHeight-2,l:parseInt(e.style(this.cropNode,"left")),t:parseInt(e.style(this.cropNode,"top")),cw:this.domNode.offsetWidth,ch:this.domNode.offsetHeight}},onChange:function(){},onComplete:function(){},_init:function(){e.addCss(this.domNode,"icropper");this._buildRendering();this._updateUI();e.connect(this.cropNode,"onmousedown",this,"_onMouseDown");e.connect(document,"onmouseup",this,"_onMouseUp");e.connect(document,"onmousemove",this,"_onMouseMove");this.image&&this.setImage(this.image);if(this.preview){var t=this;e.each(this.preview,function(e){t.bindPreview(e)})}},_buildRendering:function(){this._archors={};this._blockNodes={};this.cropNode=e.create("div",{className:"crop-node no-select"});this.domNode.appendChild(this.cropNode);var t=["lt","t","rt","r","rb","b","lb","l"];for(var n=0;n<8;n++){var r=e.create("div",{className:"archor archor-"+t[n]});this.cropNode.appendChild(r);this._archors[t[n]]=r}t=["l","t","r","b"];for(var n=0;n<4;n++){var r=e.create("div",{className:"block block-"+t[n]});this.domNode.appendChild(r);this._blockNodes[t[n]]=r}},_setSize:function(e,t){this.domNode.style.width=e+"px";this.domNode.style.height=t+"px";var n,r;if(this.initialSize){var i=Math.min(e,t,this.initialSize);n=r=i-2+"px"}else{n=e-this.gap*2-2;r=t-this.gap*2-2;if(this.keepSquare){n=r=Math.min(n,r)}n+="px";r+="px"}var s=this.cropNode.style;s.width=n;s.height=r;var o=(e-this.cropNode.offsetWidth)/2,u=(t-this.cropNode.offsetHeight)/2;if(o<0)o=0;if(u<0)u=0;s.left=o+"px";s.top=u+"px";this._posArchors();this._posBlocks();this.onChange(this.getInfo())},_updateUI:function(){this._posArchors();this._posBlocks()},_posArchors:function(){var e=this._archors,t=this.cropNode.offsetWidth,n=this.cropNode.offsetHeight;t=t/2-4+"px";n=n/2-4+"px";e.t.style.left=e.b.style.left=t;e.l.style.top=e.r.style.top=n},_posBlocks:function(){var t=this.startedPos,n=this._blockNodes;var r=parseInt(e.style(this.cropNode,"left"));var i=parseInt(e.style(this.cropNode,"top"));var s=this.cropNode.offsetWidth;var o=this.domNode.offsetWidth;var u=this.cropNode.offsetHeight;var a=this.domNode.offsetHeight;n=this._blockNodes;n.t.style.height=n.l.style.top=n.r.style.top=i+"px";n.l.style.height=n.r.style.height=u+"px";n.l.style.width=r+"px";s=o-s-r;u=a-u-i;if(s<0)s=0;if(u<0)u=0;n.r.style.width=s+"px";n.b.style.height=u+"px"},_onMouseDown:function(t){var n=this.cropNode,r=n.style;this.dragging=t.target==n?"move":t.target.className;if(this.dragging!="move"){var i=this.dragging.split(" ");this.dragging=i.pop().split("-")[1]}this.startedPos={x:t.pageX,y:t.pageY,h:n.offsetHeight-2,w:n.offsetWidth-2,l:parseInt(e.style(n,"left")),t:parseInt(e.style(n,"top"))};var s=e.style(t.target,"cursor");e.style(document.body,{cursor:s});e.style(this.cropNode,{cursor:s});e.addCss(document.body,"no-select");e.addCss(document.body,"unselectable")},_onMouseUp:function(t){this.dragging=false;e.style(document.body,{cursor:"default"});e.style(this.cropNode,{cursor:"move"});e.rmCss(document.body,"no-select");e.rmCss(document.body,"unselectable");this.onComplete&&this.onComplete(this.getInfo())},_onMouseMove:function(e){if(!this.dragging)return;if(this.dragging=="move")this._doMove(e);else this._doResize(e);this._updateUI();this.onChange&&this.onChange(this.getInfo())},_doMove:function(e){var t=this.cropNode.style,n=this.startedPos;var r=n.l+e.pageX-n.x;var i=n.t+e.pageY-n.y;if(r<0)r=0;if(i<0)i=0;var s=this.domNode.offsetWidth-this.cropNode.offsetWidth;var o=this.domNode.offsetHeight-this.cropNode.offsetHeight;if(r>s)r=s;if(i>o)i=o;t.left=r+"px";t.top=i+"px"},_doResize:function(e){var t=this.dragging,n=this.cropNode.style,r=this.cropNode.offsetWidth,i=this.cropNode.offsetHeight,s=this.startedPos;var o=e.pageX-s.x,u=e.pageY-s.y;if(this.keepSquare||e.shiftKey){if(t=="l"){u=o;if(s.l+o<0)o=u=-s.l;if(s.t+u<0)o=u=-s.t;t="lt"}else if(t=="r"){u=o;t="rb"}else if(t=="b"){o=u;t="rb"}else if(t=="lt"){o=u=Math.abs(o)>Math.abs(u)?o:u;if(s.l+o<0)o=u=-s.l;if(s.t+u<0)o=u=-s.t}else if(t=="lb"){u=-o;if(s.l+o<0){o=-s.l;u=s.l}}else if(t=="rt"||t=="t"){o=-u;t="rt";if(s.t+u<0){u=-s.t;o=-u}}}if(/l/.test(t)){o=Math.min(o,s.w-this.minWidth);if(s.l+o>=0){n.left=s.l+o+"px";n.width=s.w-o+"px"}else{n.left=0;n.width=s.l+s.w+"px"}}if(/t/.test(t)){u=Math.min(u,s.h-this.minHeight);if(s.t+u>=0){n.top=s.t+u+"px";n.height=s.h-u+"px"}else{n.top=0;n.height=s.t+s.h+"px"}}if(/r/.test(t)){o=Math.max(o,this.minWidth-s.w);if(s.l+s.w+o<=this.domNode.offsetWidth){n.width=s.w+o+"px"}else{n.width=this.domNode.offsetWidth-s.l-2+"px"}}if(/b/.test(t)){u=Math.max(u,this.minHeight-s.h);if(s.t+s.h+u<=this.domNode.offsetHeight){n.height=s.h+u+"px"}else{n.height=this.domNode.offsetHeight-s.t-2+"px"}}if(this.keepSquare||e.shiftKey){var a=Math.min(parseInt(n.width),parseInt(n.height));n.height=n.width=a+"px"}},destroy:function(){}}})()