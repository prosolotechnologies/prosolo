<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                template="templates/masterLayout2.xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
                xmlns:util="http://www.prosolo.com/util"
                xmlns:user="http://java.sun.com/jsf/composite/components/admin/user"
>
    <utilcomp:messagesBundle var="msg" />

    <ui:define name="windowTitle" >
        #{groupUsersBean.userGroupTitle} - Users
    </ui:define>

    <ui:define name="metadata">
        <f:metadata>
            <f:viewParam name="orgId" value="#{groupUsersBean.orgId}" />
            <f:viewParam name="unitId" value="#{groupUsersBean.unitId}" />
            <f:viewParam name="id" value="#{groupUsersBean.groupId}" />
            <f:viewParam name="p" value="#{groupUsersBean.page}" default="1" />
            <f:viewAction action="#{groupUsersBean.init()}" />
        </f:metadata>
    </ui:define>

    <ui:define name="resourceTitle" >
        <h1>#{groupUsersBean.userGroupTitle}</h1>
    </ui:define>

    <ui:define name="content">
        <script src="#{request.contextPath}/resources/javascript2/search.js"></script>

        <ui:param name="learningContext" value="name:ORGANIZATION|id:#{groupUsersBean.decodedOrgId}|context:/name:UNIT|id:#{groupUsersBean.decodedUnitId}|context:/name:USER_GROUP|id:#{groupUsersBean.decodedGroupId}//"></ui:param>

        <p:growl id="growlMain" showDetail="true" globalOnly="true" />

        <div class="whiteBar">
            <div class="container">
                <div class="whiteBarContent">
                    <div class="whiteBarLeft">
                        <p:commandLink styleClass="btn btn-green btn-sm item"
                                       pt:data-toggle="modal"
                                       action="#{groupUsersBean.prepareAddingUsers()}"
                                       update=":addUsers:panelUsers :addUsers:pagination"
                                       oncomplete="$('#addUsersModal').modal('show');">
                            Add Students
                        </p:commandLink>

                        <div class="searchBox">
                            <h:form>
                                <p:remoteCommand name="execSearchGroupUsers"
                                                 process="inputGroupUsersSearch"
                                                 update=":panelUsers :pagination"
                                                 action="#{groupUsersBean.resetAndSearch()}" />

                                <h:inputText id="inputGroupUsersSearch" type="search"
                                             placeholder="Search by name" value="#{groupUsersBean.searchTerm}"
                                             onclick="$(this).select();"
                                             onkeyup="searchListener(execSearchGroupUsers);" />
                            </h:form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <ol class="breadcrumb">
                <ui:fragment rendered="#{loggeduser.hasCapability('admin.advanced')}">
                    <li><h:link outcome="/admin/organizations">Organizations</h:link></li>
                </ui:fragment>
                <li>
                    <h:link outcome="/admin/units">
                        #{groupUsersBean.organizationTitle}
                        <f:param name="id" value="#{param.orgId}" />
                    </h:link>
                </li>
                <li>
                    <h:link outcome="/admin/units">
                        #{msg['label.unit.plural']}
                        <f:param name="id" value="#{param.orgId}" />
                    </h:link>
                </li>
                <li>
                    <h:link outcome="/admin/unit-credentials">
                        #{groupUsersBean.unitTitle}
                        <f:param name="orgId" value="#{param.orgId}" />
                        <f:param name="id" value="#{param.unitId}" />
                    </h:link>
                </li>
                <li>
                    <h:link outcome="/admin/unit-groups">
                        Student Groups
                        <f:param name="orgId" value="#{param.orgId}" />
                        <f:param name="id" value="#{param.unitId}" />
                    </h:link>
                </li>
                <li class="active">#{groupUsersBean.userGroupTitle}</li>
            </ol>
        </div>

        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div class="whiteBox manageVisibility">
                        <div class="innerWrapper">
                            <p>
                                <p:commandLink pt:data-toggle="modal"
                                              action="#{groupUsersBean.prepareImportingUsers()}"
                                              update=":importUsers:importUsersForm:importUsersPanel"
                                              oncomplete="$('#importUsersModal').modal('show');">
                                    Import students from CSV file
                                </p:commandLink>
                            </p>
                        </div>
                        <h:panelGroup id="panelUsers">
                            <ui:fragment rendered="#{empty groupUsersBean.users}">
                                <div class="noPeopleMessage">
                                    <p>No students</p>
                                </div>
                            </ui:fragment>
                            <ui:fragment rendered="#{not empty groupUsersBean.users}">
                                <ul class="list hasTopBorder">
                                    <ui:repeat var="user" value="#{groupUsersBean.users}" varStatus="status">
                                        <li>
                                            <div class="instructorInfo">
                                                <utilcomp:userAvatar avatar="#{user.avatarUrl}"
                                                                     fullName="#{user.fullName}" width="48" height="48" />

                                                <div class="infoWrap">
                                                    <h3>#{user.commaSeparatedFullName}</h3>
                                                    <span>#{user.position}</span>
                                                </div>
                                            </div>
                                            <div class="assignOpt">
                                                <p:commandLink styleClass="removeX" process="@this"
                                                               action="#{groupUsersBean.removeUserFromGroup(user)}"
                                                               update=":panelUsers :growlMain">
                                                    Close
                                                    <f:param name="page" value="#{facesContext.viewRoot.viewId}" />
                                                    <f:param name="learningContext"
                                                             value="#{util:addSubContext(learningContext, 'name:user|id:'.concat(user.id))}" />
                                                </p:commandLink>
                                            </div>
                                        </li>
                                    </ui:repeat>
                                </ul>
                            </ui:fragment>
                        </h:panelGroup>

                        <utilcomp:pagination id="pagination"
                                             bean="#{groupUsersBean}"
                                             toUpdate=":panelUsers"
                                             updateUrl="true"
                        />
                    </div>
                </div>
            </div>
        </div>

        <user:importUsers id="importUsers"
                addUserToResource="group"
                bean="#{groupUsersBean}"
                userType="student"
                modalId="importUsersModal"
                importUsersFormId="importUsersForm"
                importUsersPanelId="importUsersPanel"
                toUpdate=":panelUsers :pagination :growlMain"
                learningContext="#{learningContext}"/>

        <user:addUsers
                id="addUsers"
                modalTitle="Add Students to Group"
                searchPlaceholder="Search Students"
                searchBean="#{groupUserAddBean}"
                actionBean="#{groupUsersBean}"
                toUpdate=":panelUsers :pagination :growlMain"
                userPanelId="panelUsers"
                paginationPanelId="pagination"
                learningContext="#{learningContext}"
                noResultsMessage="No students"
        />

    </ui:define>
</ui:composition>
