<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	template="templates/masterLayout2.xhtml"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:util="http://www.prosolo.com/util"
	xmlns:courses="http://java.sun.com/jsf/composite/components/courses"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util">

<ui:define name="windowTitle">
	Users
</ui:define>

<ui:define name="metadata">
	<f:metadata>
		<f:viewParam name="role" value="#{adminUsers.roleId}" default="null" />
		<f:viewAction action="#{adminUsers.init()}" />
	</f:metadata>
</ui:define>

<ui:define name="content">
<script src="#{request.contextPath}/resources/javascript2/search.js"></script>
	<p:growl id="growlMain" showDetail="true" globalOnly="true"></p:growl>
    <div class="whiteBar">
        <div class="container">
            <div class="whiteBarContent">
                <div class="whiteBarLeft">
                    <h:link outcome="/admin/userEdit" styleClass="btn btn-green btn-sm item">New User</h:link>
					<p:commandLink value="Reindex ElasticSearch"
						pt:role="button"
						styleClass="btn btn-green btn-sm item" 
						action="#{bulkDataAdministration.deleteAndReindexElasticSearch}"
					/>
					<p:commandLink value="Reindex Users"
						pt:role="button"
						styleClass="btn btn-green btn-sm item"
						action="#{bulkDataAdministration.deleteAndReindexUsers}"
					/>
                    <div class="searchBox">
                    	<h:form>
                    		<p:remoteCommand 
								name="execSearchUsers" 
								process="inputUserSearch"
								update=":panelUsers :panelSearchFilters :pagination"
								action="#{adminUsers.resetAndSearch()}" />
														
							<h:inputText id="inputUserSearch"
								type="search"
								placeholder="Filter by Keywords"
								value="#{adminUsers.searchTerm}"
								onclick="$(this).select();"
								onkeyup="searchListener(execSearchUsers);"/> 
                    	</h:form>
                    </div>
                </div>
                <div class="whiteBarRight">
               	<h:panelGroup layout="block" id="panelSearchFilters" styleClass="dropdown showDrop item">
						<span>Show:</span>
						<h:link 
							id="linkSearchFilter"
							pt:data-toggle="dropdown" 
							pt:aria-haspopup="true" 
							pt:aria-expanded="true">
							#{adminUsers.filter.label} (#{adminUsers.filter.numberOfResults})
							<span class="arrowDown">arrowDown</span>
						</h:link>
						
						<ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">
							<ui:repeat var="searchFilter" value="#{adminUsers.filters}">
								<li>
									<p:commandLink 
										process="@this"
										value="#{searchFilter.label} (#{searchFilter.numberOfResults})"
										action="#{adminUsers.applySearchFilter(searchFilter)}"
										update=":panelUsers :pagination :panelSearchFilters" />
								</li>
							</ui:repeat> 
						</ul>
					</h:panelGroup>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <h:panelGroup layout="block" id="panelUsers" styleClass="col-md-12">
                <ul class="whiteBox peopleList">
                	<ui:repeat var="user" value="#{adminUsers.users}">
	                    <li>
	                        <div class="peopleListLeft">
	                        	<h:link outcome="/admin/userEdit">
			                   		<utilcomp:userAvatar
										avatar="#{user.avatarUrl}"
										fullName="#{user.fullName}"	
										width="64"
										height="64"
								    />    
								    <f:param name="id" value="#{util:encodeId(user.id)}"></f:param>
			                    </h:link>
	                            
	                            <div>
	                                <h2>
	                                	<h:link outcome="/admin/userEdit">
					                   		#{user.fullName}    
								    		<f:param name="id" value="#{util:encodeId(user.id)}"></f:param>
			                    		</h:link>
			                    	</h2>
	                                <span>#{user.position}</span>
	                            </div>
	                        </div>
	                        <div class="peopleListRight">
	                            <div class="userRole">
	                                #{user.rolesCSV}
	                            </div>
	                            <div class="userEditOpt">
	                                <h:link outcome="/admin/userEdit" styleClass="btn btn-green-stroke">
		                                 <f:param name="id" value="#{util:encodeId(user.id)}"/>
		                               	 Edit
	                                </h:link>
	                                
	                                <p:commandLink 
	                                	styleClass="btn btn-green-stroke" 
	                                	pt:data-toggle="modal" 
	                                	action="#{adminUsers.prepareLoginAsUser(user)}"
	                                	update=":formLoginAs:panelLoginAs"
	                                	oncomplete="$('#loginAs').modal('show');">
	                                	Login as...
	                                </p:commandLink>
	                                
	                                <p:commandLink 
	                                	styleClass="linkRed"
	                                	pt:data-toggle="modal"
	                                	action="#{adminUsers.setUserToDelete(user)}"
	                                	update=":deleteUserModal"
	                                	oncomplete="$('#deleteModal').modal('show');">
	                                	Delete
	                                </p:commandLink>
	                            </div>
	                        </div>
	                    </li>
                    </ui:repeat>
                </ul>
            </h:panelGroup>
        </div>

        <utilcomp:pagination
				id="pagination" 
				bean="#{adminUsers}"
				toUpdate=":panelUsers" />
    </div>

	<h:form id="formLoginAs">
		 <div class="modal fade" id="loginAs" tabindex="-1" role="dialog" aria-labelledby="loginAsUser">
             <div class="modal-dialog" role="document">
                 <h:panelGroup id="panelLoginAs" layout="block" styleClass="modal-content">
                     <div class="modal-header">
                         <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&#215;</span></button>
                         <h2 class="modal-title" id="loginAsUser">Login as...</h2>
                     </div>
                     <div class="modal-body">
                         <p>
                             By proceeding your current session will end and you will be logged in as a student [#{adminUsers.loginAsUser.fullName}]. All actions performed during this session will be contributed to this student.
                         </p>
                     </div>
                     <div class="modal-footer">
                         <p:commandLink
                         	styleClass="btn btn-green"
                         	process="@this"
                         	action="#{adminUsers.loginAs()}"
                         	update=":growlMain"
                         	oncomplete="$('#loginAs').modal('hide');">
                         	Proceed
                         </p:commandLink>
                         <a href="#" class="btn btn-default" data-dismiss="modal">Cancel</a>
                     </div>
                 </h:panelGroup>
             </div>
         </div>
	</h:form>

	<courses:deleteModalDialog id="deleteUserModal"
   			deleteActionMethodName="delete"     	
          	deleteAction="#{adminUsers.delete}"
          	toUpdate=":panelUsers :growlMain" 
          	modalDeleteTitle="user"
          	modalDeleteText="#{adminUsers.userToDelete.fullName}"/>
  </ui:define>
</ui:composition>
