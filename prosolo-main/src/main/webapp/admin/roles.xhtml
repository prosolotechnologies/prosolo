<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	template="templates/masterLayout1.xhtml"
	xmlns:dlg="http://java.sun.com/jsf/composite/components/admin/dialogs"
	xmlns:utilcomp="http://java.sun.com/jsf/composite/components/util"
	xmlns:c="http://java.sun.com/jsp/jstl/core">

	<ui:define name="windowTitle">
	Administration: Roles
</ui:define>

<ui:define name="content">
	<dlg:newRole id="newRole" />
	<dlg:editRole id="editRole" />

	<section class="heading">
		<header>
			<i class="fa fa-sitemap headIcon"></i>
			<div class="headerTitle">
				<h1>Roles</h1>
				<p>Manage user roles and capabilities in the application.</p>
			</div>
			
			<ul class="basicStats pull-right">
				<li>
					<p:commandLink immediate="true" id="newRoleBtn"
						styleClass="btn btn-default panelButton pull-right"
						action="#{roles.prepareAddRole()}"
						onclick='$("#newRoleModalDialog").dialog("open");'
						update=":newRole:newRoleForm">
						
						<i class="fa fa-plus"></i>
						Add Role
					</p:commandLink>
				</li>
			</ul>
		</header>
	</section>
	
	<section class="container-fluid mainArea">
		<div class="row">
			<div class="panel panel-default">
				<div class="panel-body">
					<div class="row">
						<div class="col-md-12">
							<h:form id="rolesForm" prependId="false">
							
								<p:dataTable id="rolessDataTable" var="role" value="#{roles.roles}">
					
									<f:facet name="header">Roles</f:facet>
					
									<p:column id="nameColumn" filterBy="#{role.name}"
										filterMatchMode="contains" sortBy="#{role.name}">
					
										<f:facet name="header">
											<h:outputText value="Name" />
										</f:facet>
										<h:outputText value="#{role.name}" />
									</p:column>
					
									<p:column id="usersColumn" filterBy="#{role.name}"
										filterMatchMode="contains" sortBy="#{role.name}">
					
										<f:facet name="header">
											<h:outputText value="Users" />
										</f:facet>
										<p:commandLink rendered="#{not empty role.userIds}"
											value="#{role.userIds.size()} users"
											action="#{peopleListDialog.initializePeopleWithIds(role.userIds)}"
											onclick="$('#peopleListDialog').dialog('open');"
											update=":peopleListForm" />
					
										<h:outputText rendered="#{empty role.userIds}" value="0 users" />
									</p:column>
					
					
									<p:column>
										<f:facet name="header">
											<h:outputText value="Description" />
										</f:facet>
										<h:outputText value="#{role.description}" />
									</p:column>
					
									<p:column styleClass="center">
										<f:facet name="header">
											<h:outputText value="Edit" />
										</f:facet>
					
										<p:commandLink immediate="true" value="Edit" styleClass="blue button size25"
											onclick="$('#editRoleModalDialog').dialog('open');"
											action="#{roles.prepareEdit(role)}"
											update=":editRole:editRoleForm" />
									</p:column>
					
									<p:column styleClass="center">
										<f:facet name="header">
											<h:outputText value="Delete" />
										</f:facet>
					
										<p:commandLink value="Delete" styleClass="button red size25"
											rendered="#{!roles.isRoleUsed(role)}"
											onclick="$('#deleteRoleDialog').dialog('open');"
											action="#{roles.setRoleToDelete(role)}"
											update=":deleteRoleDialogForm" />
					
										<p:commandLink value="Delete"
											styleClass="button disabled gray size25 hasTooltip"
											rendered="#{roles.isRoleUsed(role)}"
											title="#{msg['admin.roles.delete.disabled.tooltip']}" />
									</p:column>
								</p:dataTable>
							</h:form>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<div class="row">
			<div class="panel panel-default">
				<div class="panel-body">
					<div class="row">
						<div class="col-md-12">
							<h:form id="capabilitiesForm" prependId="false">
							
								<p:dataTable id="capabilitiesTable" var="cap" value="#{roles.capabilities}">
			
									<f:facet name="header">Capabilities</f:facet>
									<p:column id="nameColumn" filterBy="#{cap.description}"
										filterMatchMode="contains" sortBy="#{cap.description}">
			
										<f:facet name="header">
											<h:outputText value="Name" />
										</f:facet>
										<h:outputText value="#{cap.description}" />
									</p:column>
									
									<c:forEach items="#{roles.roles}" var="role">
			    						<p:column headerText="#{role.name}">
			        						<h:selectBooleanCheckbox checked="#{roles.isSelected(cap,role)}">
											<p:ajax event="click" process="@this"
												listener="#{roles.capabilityChanged(cap, role)}" update=":capabilitiesForm:growlMsg @this" />
										</h:selectBooleanCheckbox>
			    						</p:column> 
									</c:forEach>
								</p:dataTable>
								
								<p:growl id="growlMsg" showDetail="true"/>
							</h:form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>

	<div id="deleteRoleDialog" class="deleteRoleDialog"
		style="display: none;">
		<h:form id="deleteRoleDialogForm">
			<h4 class="warningMessage">Are you sure you want to delete role
				#{roles.roleToDelete.name}?</h4>

			<div class="actions">
				<p:commandLink value="Yes" styleClass="button green size30 right"
					onclick="$('#deleteRoleDialog').dialog('close');"
					action="#{roles.delete()}" update=":rolesForm" />
				&#160; <a href="#" class="button gray size30 right"
					onclick="$('#deleteRoleDialog').dialog('close');">Cancel</a>
			</div>
		</h:form>
	</div>

		<script>
			$(function() {
				$('#deleteRoleDialog').dialog({
					title : 'Delete Role',
					dialogClass : 'warning',
					show : 'slide',
					autoOpen : false,
					width : 400,
					modal : true,
					resizable : false,
					open : function() {
						$(this).children(':first')
							.css('text-align', 'center')
							.css('padding-top', '50px')
							.html('<img src="#{request.contextPath}/resources/images/style/ajax-loader-black.gif" style="vertical-align:middle;"/>');

							if ($(this).parent().find('.ui-dialog-titlebar .warningIcon').length == 0) {
								$(this).parent()
									.children('.ui-dialog-titlebar')
									.prepend('<span class="warningIcon"></span>');
							}
					}
				});
				$('#deleteRoleDialog').show();
			});
		</script>
		
		<utilcomp:tooltip target=".hasTooltip[title]" />
	</ui:define>
</ui:composition>